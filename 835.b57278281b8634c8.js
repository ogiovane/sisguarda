"use strict";(self.webpackChunkmantis_free_version=self.webpackChunkmantis_free_version||[]).push([[835],{5835:(GI,rm,J)=>{J.d(rm,{ST:()=>tm,yb:()=>qI});var A,im=J(6814),j=J(9212),xe=J(8326),ii=J(7217),ct=J(7213),sm=J(6321),om=J(5592),si=J(2459),$u=J(2096),Ds=J(7921),bs=J(9384),Ge=J(7398),Ns=J(6699),am=J(3997),Wu=J(2181),um=(J(7410),J(3106)),p=J(5861),oi=J(534),Hu=J(4537),ze=J(7879),q=J(9058),cm=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},qe={},ks=ks||{},D=cm||self;function ai(n){var e=typeof n;return"array"==(e="object"!=e?e:n?Array.isArray(n)?"array":e:"null")||"object"==e&&"number"==typeof n.length}function Wn(n){var e=typeof n;return"object"==e&&null!=n||"function"==e}var Fs="closure_uid_"+(1e9*Math.random()>>>0),hm=0;function dm(n,e,t){return n.call.apply(n.bind,arguments)}function fm(n,e,t){if(!n)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var i=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(i,r),n.apply(e,i)}}return function(){return n.apply(e,arguments)}}function Te(n,e,t){return(Te=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?dm:fm).apply(null,arguments)}function ui(n,e){var t=Array.prototype.slice.call(arguments,1);return function(){var r=t.slice();return r.push.apply(r,arguments),n.apply(this,r)}}function le(n,e){function t(){}t.prototype=e.prototype,n.$=e.prototype,n.prototype=new t,n.prototype.constructor=n,n.ac=function(r,i,s){for(var o=Array(arguments.length-2),a=2;a<arguments.length;a++)o[a-2]=arguments[a];return e.prototype[i].apply(r,o)}}function lt(){this.s=this.s,this.o=this.o}lt.prototype.s=!1,lt.prototype.sa=function(){!this.s&&(this.s=!0,this.N(),0)&&function lm(n){Object.prototype.hasOwnProperty.call(n,Fs)&&n[Fs]||(n[Fs]=++hm)}(this)},lt.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const Zu=Array.prototype.indexOf?function(n,e){return Array.prototype.indexOf.call(n,e,void 0)}:function(n,e){if("string"==typeof n)return"string"!=typeof e||1!=e.length?-1:n.indexOf(e,0);for(let t=0;t<n.length;t++)if(t in n&&n[t]===e)return t;return-1};function Ms(n){const e=n.length;if(0<e){const t=Array(e);for(let r=0;r<e;r++)t[r]=n[r];return t}return[]}function Yu(n,e){for(let t=1;t<arguments.length;t++){const r=arguments[t];if(ai(r)){const i=n.length||0,s=r.length||0;n.length=i+s;for(let o=0;o<s;o++)n[i+o]=r[o]}else n.push(r)}}function Ee(n,e){this.type=n,this.g=this.target=e,this.defaultPrevented=!1}Ee.prototype.h=function(){this.defaultPrevented=!0};var gm=function(){if(!D.addEventListener||!Object.defineProperty)return!1;var n=!1,e=Object.defineProperty({},"passive",{get:function(){n=!0}});try{const t=()=>{};D.addEventListener("test",t,e),D.removeEventListener("test",t,e)}catch{}return n}();function Hn(n){return/^[\s\xa0]*$/.test(n)}function ci(){var n=D.navigator;return n&&(n=n.userAgent)?n:""}function Ke(n){return-1!=ci().indexOf(n)}function Os(n){return Os[" "](n),n}Os[" "]=function(){};var Bs,n,_m=Ke("Opera"),rn=Ke("Trident")||Ke("MSIE"),Ju=Ke("Edge"),Ls=Ju||rn,Xu=Ke("Gecko")&&!(-1!=ci().toLowerCase().indexOf("webkit")&&!Ke("Edge"))&&!(Ke("Trident")||Ke("MSIE"))&&!Ke("Edge"),ym=-1!=ci().toLowerCase().indexOf("webkit")&&!Ke("Edge");function ec(){var n=D.document;return n?n.documentMode:void 0}e:{var qs="",Us=(n=ci(),Xu?/rv:([^\);]+)(\)|;)/.exec(n):Ju?/Edge\/([\d\.]+)/.exec(n):rn?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(n):ym?/WebKit\/(\S+)/.exec(n):_m?/(?:Version)[ \/]?(\S+)/.exec(n):void 0);if(Us&&(qs=Us?Us[1]:""),rn){var Gs=ec();if(null!=Gs&&Gs>parseFloat(qs)){Bs=String(Gs);break e}}Bs=qs}var Im=D.document&&rn&&(ec()||parseInt(Bs,10))||void 0;function Zn(n,e){if(Ee.call(this,n?n.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,n){var t=this.type=n.type,r=n.changedTouches&&n.changedTouches.length?n.changedTouches[0]:null;if(this.target=n.target||n.srcElement,this.g=e,e=n.relatedTarget){if(Xu){e:{try{Os(e.nodeName);var i=!0;break e}catch{}i=!1}i||(e=null)}}else"mouseover"==t?e=n.fromElement:"mouseout"==t&&(e=n.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==n.clientX?n.clientX:n.pageX,this.clientY=void 0!==n.clientY?n.clientY:n.pageY,this.screenX=n.screenX||0,this.screenY=n.screenY||0),this.button=n.button,this.key=n.key||"",this.ctrlKey=n.ctrlKey,this.altKey=n.altKey,this.shiftKey=n.shiftKey,this.metaKey=n.metaKey,this.pointerId=n.pointerId||0,this.pointerType="string"==typeof n.pointerType?n.pointerType:Tm[n.pointerType]||"",this.state=n.state,this.i=n,n.defaultPrevented&&Zn.$.h.call(this)}}le(Zn,Ee);var Tm={2:"touch",3:"pen",4:"mouse"};Zn.prototype.h=function(){Zn.$.h.call(this);var n=this.i;n.preventDefault?n.preventDefault():n.returnValue=!1};var Yn="closure_listenable_"+(1e6*Math.random()|0),Em=0;function vm(n,e,t,r,i){this.listener=n,this.proxy=null,this.src=e,this.type=t,this.capture=!!r,this.la=i,this.key=++Em,this.fa=this.ia=!1}function li(n){n.fa=!0,n.listener=null,n.proxy=null,n.src=null,n.la=null}function Ks(n,e,t){for(const r in n)e.call(t,n[r],r,n)}function nc(n){const e={};for(const t in n)e[t]=n[t];return e}const rc="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ic(n,e){let t,r;for(let i=1;i<arguments.length;i++){for(t in r=arguments[i],r)n[t]=r[t];for(let s=0;s<rc.length;s++)t=rc[s],Object.prototype.hasOwnProperty.call(r,t)&&(n[t]=r[t])}}function hi(n){this.src=n,this.g={},this.h=0}function js(n,e){var t=e.type;if(t in n.g){var s,r=n.g[t],i=Zu(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(li(e),0==n.g[t].length&&(delete n.g[t],n.h--))}}function Qs(n,e,t,r){for(var i=0;i<n.length;++i){var s=n[i];if(!s.fa&&s.listener==e&&s.capture==!!t&&s.la==r)return i}return-1}hi.prototype.add=function(n,e,t,r,i){var s=n.toString();(n=this.g[s])||(n=this.g[s]=[],this.h++);var o=Qs(n,e,r,i);return-1<o?(e=n[o],t||(e.ia=!1)):((e=new vm(e,this.src,s,!!r,i)).ia=t,n.push(e)),e};var $s="closure_lm_"+(1e6*Math.random()|0),Ws={};function sc(n,e,t,r,i){if(r&&r.once)return ac(n,e,t,r,i);if(Array.isArray(e)){for(var s=0;s<e.length;s++)sc(n,e[s],t,r,i);return null}return t=Js(t),n&&n[Yn]?n.O(e,t,Wn(r)?!!r.capture:!!r,i):oc(n,e,t,!1,r,i)}function oc(n,e,t,r,i,s){if(!e)throw Error("Invalid event type");var o=Wn(i)?!!i.capture:!!i,a=Zs(n);if(a||(n[$s]=a=new hi(n)),(t=a.add(e,t,r,o,s)).proxy)return t;if(r=function Am(){const e=Rm;return function n(t){return e.call(n.src,n.listener,t)}}(),t.proxy=r,r.src=n,r.listener=t,n.addEventListener)gm||(i=o),void 0===i&&(i=!1),n.addEventListener(e.toString(),r,i);else if(n.attachEvent)n.attachEvent(cc(e.toString()),r);else{if(!n.addListener||!n.removeListener)throw Error("addEventListener and attachEvent are unavailable.");n.addListener(r)}return t}function ac(n,e,t,r,i){if(Array.isArray(e)){for(var s=0;s<e.length;s++)ac(n,e[s],t,r,i);return null}return t=Js(t),n&&n[Yn]?n.P(e,t,Wn(r)?!!r.capture:!!r,i):oc(n,e,t,!0,r,i)}function uc(n,e,t,r,i){if(Array.isArray(e))for(var s=0;s<e.length;s++)uc(n,e[s],t,r,i);else r=Wn(r)?!!r.capture:!!r,t=Js(t),n&&n[Yn]?(n=n.i,(e=String(e).toString())in n.g&&-1<(t=Qs(s=n.g[e],t,r,i))&&(li(s[t]),Array.prototype.splice.call(s,t,1),0==s.length&&(delete n.g[e],n.h--))):n&&(n=Zs(n))&&(e=n.g[e.toString()],n=-1,e&&(n=Qs(e,t,r,i)),(t=-1<n?e[n]:null)&&Hs(t))}function Hs(n){if("number"!=typeof n&&n&&!n.fa){var e=n.src;if(e&&e[Yn])js(e.i,n);else{var t=n.type,r=n.proxy;e.removeEventListener?e.removeEventListener(t,r,n.capture):e.detachEvent?e.detachEvent(cc(t),r):e.addListener&&e.removeListener&&e.removeListener(r),(t=Zs(e))?(js(t,n),0==t.h&&(t.src=null,e[$s]=null)):li(n)}}}function cc(n){return n in Ws?Ws[n]:Ws[n]="on"+n}function Rm(n,e){if(n.fa)n=!0;else{e=new Zn(e,this);var t=n.listener,r=n.la||n.src;n.ia&&Hs(n),n=t.call(r,e)}return n}function Zs(n){return(n=n[$s])instanceof hi?n:null}var Ys="__closure_events_fn_"+(1e9*Math.random()>>>0);function Js(n){return"function"==typeof n?n:(n[Ys]||(n[Ys]=function(e){return n.handleEvent(e)}),n[Ys])}function he(){lt.call(this),this.i=new hi(this),this.S=this,this.J=null}function ge(n,e){var t,r=n.J;if(r)for(t=[];r;r=r.J)t.push(r);if(n=n.S,r=e.type||e,"string"==typeof e)e=new Ee(e,n);else if(e instanceof Ee)e.target=e.target||n;else{var i=e;ic(e=new Ee(r,n),i)}if(i=!0,t)for(var s=t.length-1;0<=s;s--){var o=e.g=t[s];i=di(o,r,!0,e)&&i}if(i=di(o=e.g=n,r,!0,e)&&i,i=di(o,r,!1,e)&&i,t)for(s=0;s<t.length;s++)i=di(o=e.g=t[s],r,!1,e)&&i}function di(n,e,t,r){if(!(e=n.i.g[String(e)]))return!0;e=e.concat();for(var i=!0,s=0;s<e.length;++s){var o=e[s];if(o&&!o.fa&&o.capture==t){var a=o.listener,u=o.la||o.src;o.ia&&js(n.i,o),i=!1!==a.call(u,r)&&i}}return i&&!r.defaultPrevented}le(he,lt),he.prototype[Yn]=!0,he.prototype.removeEventListener=function(n,e,t,r){uc(this,n,e,t,r)},he.prototype.N=function(){if(he.$.N.call(this),this.i){var e,n=this.i;for(e in n.g){for(var t=n.g[e],r=0;r<t.length;r++)li(t[r]);delete n.g[e],n.h--}}this.J=null},he.prototype.O=function(n,e,t,r){return this.i.add(String(n),e,!1,t,r)},he.prototype.P=function(n,e,t,r){return this.i.add(String(n),e,!0,t,r)};var Xs=D.JSON.stringify;function Sm(){var n=eo;let e=null;return n.g&&(e=n.g,n.g=n.g.next,n.g||(n.h=null),e.next=null),e}var lc=new class Pm{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new xm,n=>n.reset());class xm{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Cm(n){var e=1;n=n.split(":");const t=[];for(;0<e&&n.length;)t.push(n.shift()),e--;return n.length&&t.push(n.join(":")),t}function Dm(n){D.setTimeout(()=>{throw n},0)}let Jn,Xn=!1,eo=new class Vm{constructor(){this.h=this.g=null}add(e,t){const r=lc.get();r.set(e,t),this.h?this.h.next=r:this.g=r,this.h=r}},hc=()=>{const n=D.Promise.resolve(void 0);Jn=()=>{n.then(bm)}};var bm=()=>{for(var n;n=Sm();){try{n.h.call(n.g)}catch(t){Dm(t)}var e=lc;e.j(n),100>e.h&&(e.h++,n.next=e.g,e.g=n)}Xn=!1};function fi(n,e){he.call(this),this.h=n||1,this.g=e||D,this.j=Te(this.qb,this),this.l=Date.now()}function to(n){n.ga=!1,n.T&&(n.g.clearTimeout(n.T),n.T=null)}function no(n,e,t){if("function"==typeof n)t&&(n=Te(n,t));else{if(!n||"function"!=typeof n.handleEvent)throw Error("Invalid listener argument");n=Te(n.handleEvent,n)}return 2147483647<Number(e)?-1:D.setTimeout(n,e||0)}function dc(n){n.g=no(()=>{n.g=null,n.i&&(n.i=!1,dc(n))},n.j);const e=n.h;n.h=null,n.m.apply(null,e)}le(fi,he),(A=fi.prototype).ga=!1,A.T=null,A.qb=function(){if(this.ga){var n=Date.now()-this.l;0<n&&n<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-n):(this.T&&(this.g.clearTimeout(this.T),this.T=null),ge(this,"tick"),this.ga&&(to(this),this.start()))}},A.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},A.N=function(){fi.$.N.call(this),to(this),delete this.g};class Nm extends lt{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:dc(this)}N(){super.N(),this.g&&(D.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function er(n){lt.call(this),this.h=n,this.g={}}le(er,lt);var fc=[];function mc(n,e,t,r){Array.isArray(t)||(t&&(fc[0]=t.toString()),t=fc);for(var i=0;i<t.length;i++){var s=sc(e,t[i],r||n.handleEvent,!1,n.h||n);if(!s)break;n.g[s.key]=s}}function gc(n){Ks(n.g,function(e,t){this.g.hasOwnProperty(t)&&Hs(e)},n),n.g={}}function mi(){this.g=!0}function sn(n,e,t,r){n.info(function(){return"XMLHTTP TEXT ("+e+"): "+function Om(n,e){if(!n.g)return e;if(!e)return null;try{var t=JSON.parse(e);if(t)for(n=0;n<t.length;n++)if(Array.isArray(t[n])){var r=t[n];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var o=1;o<i.length;o++)i[o]=""}}}return Xs(t)}catch{return e}}(n,t)+(r?" "+r:"")})}er.prototype.N=function(){er.$.N.call(this),gc(this)},er.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},mi.prototype.Ea=function(){this.g=!1},mi.prototype.info=function(){};var bt={},pc=null;function gi(){return pc=pc||new he}function _c(n){Ee.call(this,bt.Ta,n)}function tr(n){const e=gi();ge(e,new _c(e))}function yc(n,e){Ee.call(this,bt.STAT_EVENT,n),this.stat=e}function Re(n){const e=gi();ge(e,new yc(e,n))}function Ic(n,e){Ee.call(this,bt.Ua,n),this.size=e}function nr(n,e){if("function"!=typeof n)throw Error("Fn must not be null and must be a function");return D.setTimeout(function(){n()},e)}bt.Ta="serverreachability",le(_c,Ee),bt.STAT_EVENT="statevent",le(yc,Ee),bt.Ua="timingevent",le(Ic,Ee);var pi={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},Tc={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function ro(){}function vc(){}ro.prototype.h=null;var oo,rr={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function io(){Ee.call(this,"d")}function so(){Ee.call(this,"c")}function _i(){}function ir(n,e,t,r){this.l=n,this.j=e,this.m=t,this.W=r||1,this.U=new er(this),this.P=Lm,this.V=new fi(n=Ls?125:void 0),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new wc}function wc(){this.i=null,this.g="",this.h=!1}le(io,Ee),le(so,Ee),le(_i,ro),_i.prototype.g=function(){return new XMLHttpRequest},_i.prototype.i=function(){return{}},oo=new _i;var Lm=45e3,Ac={},ao={};function uo(n,e,t){n.L=1,n.A=Ei(Xe(e)),n.u=t,n.S=!0,Rc(n,null)}function Rc(n,e){n.G=Date.now(),sr(n),n.B=Xe(n.A);var t=n.B,r=n.W;Array.isArray(r)||(r=[String(r)]),Fc(t.i,"t",r),n.o=0,t=n.l.J,n.h=new wc,n.g=sl(n.l,t?e:null,!n.u),0<n.O&&(n.M=new Nm(Te(n.Pa,n,n.g),n.O)),mc(n.U,n.g,"readystatechange",n.nb),e=n.I?nc(n.I):{},n.u?(n.v||(n.v="POST"),e["Content-Type"]="application/x-www-form-urlencoded",n.g.ha(n.B,n.v,n.u,e)):(n.v="GET",n.g.ha(n.B,n.v,null,e)),tr(),function km(n,e,t,r,i,s){n.info(function(){if(n.g)if(s)for(var o="",a=s.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+c+"&":o+(l+"=redacted&")}}else o=null;else o=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+e+"\n"+t+"\n"+o})}(n.j,n.v,n.B,n.m,n.W,n.u)}function Pc(n){return!!n.g&&"GET"==n.v&&2!=n.L&&n.l.Ha}function Sc(n,e,t){let i,r=!0;for(;!n.J&&n.o<t.length;){if(i=Bm(n,t),i==ao){4==e&&(n.s=4,Re(14),r=!1),sn(n.j,n.m,null,"[Incomplete Response]");break}if(i==Ac){n.s=4,Re(15),sn(n.j,n.m,t,"[Invalid Chunk]"),r=!1;break}sn(n.j,n.m,i,null),co(n,i)}Pc(n)&&0!=n.o&&(n.h.g=n.h.g.slice(n.o),n.o=0),4!=e||0!=t.length||n.h.h||(n.s=1,Re(16),r=!1),n.i=n.i&&r,r?0<t.length&&!n.ba&&(n.ba=!0,(e=n.l).g==n&&e.ca&&!e.M&&(e.l.info("Great, no buffering proxy detected. Bytes received: "+t.length),_o(e),e.M=!0,Re(11))):(sn(n.j,n.m,t,"[Invalid Chunked Response]"),Nt(n),or(n))}function Bm(n,e){var t=n.o,r=e.indexOf("\n",t);return-1==r?ao:(t=Number(e.substring(t,r)),isNaN(t)?Ac:(r+=1)+t>e.length?ao:(e=e.slice(r,r+t),n.o=r+t,e))}function sr(n){n.Y=Date.now()+n.P,Vc(n,n.P)}function Vc(n,e){if(null!=n.C)throw Error("WatchDog timer not null");n.C=nr(Te(n.lb,n),e)}function yi(n){n.C&&(D.clearTimeout(n.C),n.C=null)}function or(n){0==n.l.H||n.J||tl(n.l,n)}function Nt(n){yi(n);var e=n.M;e&&"function"==typeof e.sa&&e.sa(),n.M=null,to(n.V),gc(n.U),n.g&&(e=n.g,n.g=null,e.abort(),e.sa())}function co(n,e){try{var t=n.l;if(0!=t.H&&(t.g==n||lo(t.i,n)))if(!n.K&&lo(t.i,n)&&3==t.H){try{var r=t.Ja.g.parse(e)}catch{r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!t.u){if(t.g){if(!(t.g.G+3e3<n.G))break e;Si(t),Ri(t)}po(t),Re(18)}}else t.Fa=i[1],0<t.Fa-t.V&&37500>i[2]&&t.G&&0==t.A&&!t.v&&(t.v=nr(Te(t.ib,t),6e3));if(1>=Lc(t.i)&&t.oa){try{t.oa()}catch{}t.oa=void 0}}else Ft(t,11)}else if((n.K||t.g==n)&&Si(t),!Hn(e))for(i=t.Ja.g.parse(e),e=0;e<i.length;e++){let c=i[e];if(t.V=c[0],c=c[1],2==t.H)if("c"==c[0]){t.K=c[1],t.pa=c[2];const l=c[3];null!=l&&(t.ra=l,t.l.info("VER="+t.ra));const h=c[4];null!=h&&(t.Ga=h,t.l.info("SVER="+t.Ga));const d=c[5];null!=d&&"number"==typeof d&&0<d&&(t.L=r=1.5*d,t.l.info("backChannelRequestTimeoutMs_="+r)),r=t;const m=n.g;if(m){const I=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(I){var s=r.i;s.g||-1==I.indexOf("spdy")&&-1==I.indexOf("quic")&&-1==I.indexOf("h2")||(s.j=s.l,s.g=new Set,s.h&&(ho(s,s.h),s.h=null))}if(r.F){const E=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null;E&&(r.Da=E,W(r.I,r.F,E))}}t.H=3,t.h&&t.h.Ba(),t.ca&&(t.S=Date.now()-n.G,t.l.info("Handshake RTT: "+t.S+"ms"));var o=n;if((r=t).wa=il(r,r.J?r.pa:null,r.Y),o.K){Bc(r.i,o);var a=o,u=r.L;u&&a.setTimeout(u),a.C&&(yi(a),sr(a)),r.g=o}else Xc(r);0<t.j.length&&Pi(t)}else"stop"!=c[0]&&"close"!=c[0]||Ft(t,7);else 3==t.H&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?Ft(t,7):go(t):"noop"!=c[0]&&t.h&&t.h.Aa(c),t.A=0)}tr()}catch{}}function xc(n,e){if(n.forEach&&"function"==typeof n.forEach)n.forEach(e,void 0);else if(ai(n)||"string"==typeof n)Array.prototype.forEach.call(n,e,void 0);else for(var t=function Um(n){if(n.ta&&"function"==typeof n.ta)return n.ta();if(!n.Z||"function"!=typeof n.Z){if(typeof Map<"u"&&n instanceof Map)return Array.from(n.keys());if(!(typeof Set<"u"&&n instanceof Set)){if(ai(n)||"string"==typeof n){var e=[];n=n.length;for(var t=0;t<n;t++)e.push(t);return e}e=[],t=0;for(const r in n)e[t++]=r;return e}}}(n),r=function qm(n){if(n.Z&&"function"==typeof n.Z)return n.Z();if(typeof Map<"u"&&n instanceof Map||typeof Set<"u"&&n instanceof Set)return Array.from(n.values());if("string"==typeof n)return n.split("");if(ai(n)){for(var e=[],t=n.length,r=0;r<t;r++)e.push(n[r]);return e}for(r in e=[],t=0,n)e[t++]=n[r];return e}(n),i=r.length,s=0;s<i;s++)e.call(void 0,r[s],t&&t[s],n)}(A=ir.prototype).setTimeout=function(n){this.P=n},A.nb=function(n){n=n.target;const e=this.M;e&&3==je(n)?e.l():this.Pa(n)},A.Pa=function(n){try{if(n==this.g)e:{const l=je(this.g);var e=this.g.Ia();if(this.g.da(),!(3>l)&&(3!=l||Ls||this.g&&(this.h.h||this.g.ja()||$c(this.g)))){this.J||4!=l||7==e||tr(),yi(this);var t=this.g.da();this.ca=t;t:if(Pc(this)){var r=$c(this.g);n="";var i=r.length,s=4==je(this.g);if(!this.h.i){if(typeof TextDecoder>"u"){Nt(this),or(this);var o="";break t}this.h.i=new D.TextDecoder}for(e=0;e<i;e++)this.h.h=!0,n+=this.h.i.decode(r[e],{stream:s&&e==i-1});r.length=0,this.h.g+=n,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==t,function Fm(n,e,t,r,i,s,o){n.info(function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+e+"\n"+t+"\n"+s+" "+o})}(this.j,this.v,this.B,this.m,this.W,l,t),this.i){if(this.aa&&!this.K){t:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!Hn(a)){var c=a;break t}}c=null}if(!(t=c)){this.i=!1,this.s=3,Re(12),Nt(this),or(this);break e}sn(this.j,this.m,t,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,co(this,t)}this.S?(Sc(this,l,o),Ls&&this.i&&3==l&&(mc(this.U,this.V,"tick",this.mb),this.V.start())):(sn(this.j,this.m,o,null),co(this,o)),4==l&&Nt(this),this.i&&!this.J&&(4==l?tl(this.l,this):(this.i=!1,sr(this)))}else(function sg(n){const e={};n=(n.g&&2<=je(n)&&n.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<n.length;r++){if(Hn(n[r]))continue;var t=Cm(n[r]);const i=t[0];if("string"!=typeof(t=t[1]))continue;t=t.trim();const s=e[i]||[];e[i]=s,s.push(t)}!function wm(n,e){for(const t in n)e.call(void 0,n[t],t,n)}(e,function(r){return r.join(", ")})})(this.g),400==t&&0<o.indexOf("Unknown SID")?(this.s=3,Re(12)):(this.s=0,Re(13)),Nt(this),or(this)}}}catch{}},A.mb=function(){if(this.g){var n=je(this.g),e=this.g.ja();this.o<e.length&&(yi(this),Sc(this,n,e),this.i&&4!=n&&sr(this))}},A.cancel=function(){this.J=!0,Nt(this)},A.lb=function(){this.C=null;const n=Date.now();0<=n-this.Y?(function Mm(n,e){n.info(function(){return"TIMEOUT: "+e})}(this.j,this.B),2!=this.L&&(tr(),Re(17)),Nt(this),this.s=2,or(this)):Vc(this,this.Y-n)};var Cc=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function kt(n){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,n instanceof kt){this.h=n.h,Ii(this,n.j),this.s=n.s,this.g=n.g,Ti(this,n.m),this.l=n.l;var e=n.i,t=new cr;t.i=e.i,e.g&&(t.g=new Map(e.g),t.h=e.h),Dc(this,t),this.o=n.o}else n&&(e=String(n).match(Cc))?(this.h=!1,Ii(this,e[1]||"",!0),this.s=ar(e[2]||""),this.g=ar(e[3]||"",!0),Ti(this,e[4]),this.l=ar(e[5]||"",!0),Dc(this,e[6]||"",!0),this.o=ar(e[7]||"")):(this.h=!1,this.i=new cr(null,this.h))}function Xe(n){return new kt(n)}function Ii(n,e,t){n.j=t?ar(e,!0):e,n.j&&(n.j=n.j.replace(/:$/,""))}function Ti(n,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);n.m=e}else n.m=null}function Dc(n,e,t){e instanceof cr?(n.i=e,function Wm(n,e){e&&!n.j&&(ht(n),n.i=null,n.g.forEach(function(t,r){var i=r.toLowerCase();r!=i&&(Nc(this,r),Fc(this,i,t))},n)),n.j=e}(n.i,n.h)):(t||(e=ur(e,Qm)),n.i=new cr(e,n.h))}function W(n,e,t){n.i.set(e,t)}function Ei(n){return W(n,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),n}function ar(n,e){return n?e?decodeURI(n.replace(/%25/g,"%2525")):decodeURIComponent(n):""}function ur(n,e,t){return"string"==typeof n?(n=encodeURI(n).replace(e,zm),t&&(n=n.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),n):null}function zm(n){return"%"+((n=n.charCodeAt(0))>>4&15).toString(16)+(15&n).toString(16)}kt.prototype.toString=function(){var n=[],e=this.j;e&&n.push(ur(e,bc,!0),":");var t=this.g;return(t||"file"==e)&&(n.push("//"),(e=this.s)&&n.push(ur(e,bc,!0),"@"),n.push(encodeURIComponent(String(t)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(t=this.m)&&n.push(":",String(t))),(t=this.l)&&(this.g&&"/"!=t.charAt(0)&&n.push("/"),n.push(ur(t,"/"==t.charAt(0)?jm:Km,!0))),(t=this.i.toString())&&n.push("?",t),(t=this.o)&&n.push("#",ur(t,$m)),n.join("")};var bc=/[#\/\?@]/g,Km=/[#\?:]/g,jm=/[#\?]/g,Qm=/[#\?@]/g,$m=/#/g;function cr(n,e){this.h=this.g=null,this.i=n||null,this.j=!!e}function ht(n){n.g||(n.g=new Map,n.h=0,n.i&&function Gm(n,e){if(n){n=n.split("&");for(var t=0;t<n.length;t++){var r=n[t].indexOf("="),i=null;if(0<=r){var s=n[t].substring(0,r);i=n[t].substring(r+1)}else s=n[t];e(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Nc(n,e){ht(n),e=on(n,e),n.g.has(e)&&(n.i=null,n.h-=n.g.get(e).length,n.g.delete(e))}function kc(n,e){return ht(n),e=on(n,e),n.g.has(e)}function Fc(n,e,t){Nc(n,e),0<t.length&&(n.i=null,n.g.set(on(n,e),Ms(t)),n.h+=t.length)}function on(n,e){return e=String(e),n.j&&(e=e.toLowerCase()),e}(A=cr.prototype).add=function(n,e){ht(this),this.i=null,n=on(this,n);var t=this.g.get(n);return t||this.g.set(n,t=[]),t.push(e),this.h+=1,this},A.forEach=function(n,e){ht(this),this.g.forEach(function(t,r){t.forEach(function(i){n.call(e,i,r,this)},this)},this)},A.ta=function(){ht(this);const n=Array.from(this.g.values()),e=Array.from(this.g.keys()),t=[];for(let r=0;r<e.length;r++){const i=n[r];for(let s=0;s<i.length;s++)t.push(e[r])}return t},A.Z=function(n){ht(this);let e=[];if("string"==typeof n)kc(this,n)&&(e=e.concat(this.g.get(on(this,n))));else{n=Array.from(this.g.values());for(let t=0;t<n.length;t++)e=e.concat(n[t])}return e},A.set=function(n,e){return ht(this),this.i=null,kc(this,n=on(this,n))&&(this.h-=this.g.get(n).length),this.g.set(n,[e]),this.h+=1,this},A.get=function(n,e){return n&&0<(n=this.Z(n)).length?String(n[0]):e},A.toString=function(){if(this.i)return this.i;if(!this.g)return"";const n=[],e=Array.from(this.g.keys());for(var t=0;t<e.length;t++){var r=e[t];const s=encodeURIComponent(String(r)),o=this.Z(r);for(r=0;r<o.length;r++){var i=s;""!==o[r]&&(i+="="+encodeURIComponent(String(o[r]))),n.push(i)}}return this.i=n.join("&")};var Hm=class{constructor(n,e){this.g=n,this.map=e}};function Mc(n){this.l=n||Zm,n=D.PerformanceNavigationTiming?0<(n=D.performance.getEntriesByType("navigation")).length&&("hq"==n[0].nextHopProtocol||"h2"==n[0].nextHopProtocol):!!(D.g&&D.g.Ka&&D.g.Ka()&&D.g.Ka().dc),this.j=n?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var Zm=10;function Oc(n){return!!n.h||!!n.g&&n.g.size>=n.j}function Lc(n){return n.h?1:n.g?n.g.size:0}function lo(n,e){return n.h?n.h==e:!!n.g&&n.g.has(e)}function ho(n,e){n.g?n.g.add(e):n.h=e}function Bc(n,e){n.h&&n.h==e?n.h=null:n.g&&n.g.has(e)&&n.g.delete(e)}function qc(n){if(null!=n.h)return n.i.concat(n.h.F);if(null!=n.g&&0!==n.g.size){let e=n.i;for(const t of n.g.values())e=e.concat(t.F);return e}return Ms(n.i)}Mc.prototype.cancel=function(){if(this.i=qc(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const n of this.g.values())n.cancel();this.g.clear()}};var Ym=class{stringify(n){return D.JSON.stringify(n,void 0)}parse(n){return D.JSON.parse(n,void 0)}};function Jm(){this.g=new Ym}function Xm(n,e,t){const r=t||"";try{xc(n,function(i,s){let o=i;Wn(i)&&(o=Xs(i)),e.push(r+s+"="+encodeURIComponent(o))})}catch(i){throw e.push(r+"type="+encodeURIComponent("_badmap")),i}}function vi(n,e,t,r,i){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch{}}function lr(n){this.l=n.ec||null,this.j=n.ob||!1}function wi(n,e){he.call(this),this.F=n,this.u=e,this.m=void 0,this.readyState=fo,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}le(lr,ro),lr.prototype.g=function(){return new wi(this.l,this.j)},lr.prototype.i=function(n){return function(){return n}}({}),le(wi,he);var fo=0;function Uc(n){n.j.read().then(n.Xa.bind(n)).catch(n.ka.bind(n))}function hr(n){n.readyState=4,n.l=null,n.j=null,n.A=null,dr(n)}function dr(n){n.onreadystatechange&&n.onreadystatechange.call(n)}(A=wi.prototype).open=function(n,e){if(this.readyState!=fo)throw this.abort(),Error("Error reopening a connection");this.C=n,this.B=e,this.readyState=1,dr(this)},A.send=function(n){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};n&&(e.body=n),(this.F||D).fetch(new Request(this.B,e)).then(this.$a.bind(this),this.ka.bind(this))},A.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,hr(this)),this.readyState=fo},A.$a=function(n){if(this.g&&(this.l=n,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=n.headers,this.readyState=2,dr(this)),this.g&&(this.readyState=3,dr(this),this.g)))if("arraybuffer"===this.responseType)n.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(typeof D.ReadableStream<"u"&&"body"in n){if(this.j=n.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Uc(this)}else n.text().then(this.Za.bind(this),this.ka.bind(this))},A.Xa=function(n){if(this.g){if(this.u&&n.value)this.response.push(n.value);else if(!this.u){var e=n.value?n.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!n.done}))&&(this.response=this.responseText+=e)}n.done?hr(this):dr(this),3==this.readyState&&Uc(this)}},A.Za=function(n){this.g&&(this.response=this.responseText=n,hr(this))},A.Ya=function(n){this.g&&(this.response=n,hr(this))},A.ka=function(){this.g&&hr(this)},A.setRequestHeader=function(n,e){this.v.append(n,e)},A.getResponseHeader=function(n){return this.h&&this.h.get(n.toLowerCase())||""},A.getAllResponseHeaders=function(){if(!this.h)return"";const n=[],e=this.h.entries();for(var t=e.next();!t.done;)n.push((t=t.value)[0]+": "+t[1]),t=e.next();return n.join("\r\n")},Object.defineProperty(wi.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(n){this.m=n?"include":"same-origin"}});var tg=D.JSON.parse;function te(n){he.call(this),this.headers=new Map,this.u=n||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Gc,this.L=this.M=!1}le(te,he);var Gc="",ng=/^https?$/i,rg=["POST","PUT"];function zc(n,e){n.h=!1,n.g&&(n.l=!0,n.g.abort(),n.l=!1),n.j=e,n.m=5,Kc(n),Ai(n)}function Kc(n){n.F||(n.F=!0,ge(n,"complete"),ge(n,"error"))}function jc(n){if(n.h&&typeof ks<"u"&&(!n.C[1]||4!=je(n)||2!=n.da()))if(n.v&&4==je(n))no(n.La,0,n);else if(ge(n,"readystatechange"),4==je(n)){n.h=!1;try{const o=n.da();e:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break e;default:e=!1}var t;if(!(t=e)){var r;if(r=0===o){var i=String(n.I).match(Cc)[1]||null;!i&&D.self&&D.self.location&&(i=D.self.location.protocol.slice(0,-1)),r=!ng.test(i?i.toLowerCase():"")}t=r}if(t)ge(n,"complete"),ge(n,"success");else{n.m=6;try{var s=2<je(n)?n.g.statusText:""}catch{s=""}n.j=s+" ["+n.da()+"]",Kc(n)}}finally{Ai(n)}}}function Ai(n,e){if(n.g){Qc(n);const t=n.g,r=n.C[0]?()=>{}:null;n.g=null,n.C=null,e||ge(n,"ready");try{t.onreadystatechange=r}catch{}}}function Qc(n){n.g&&n.L&&(n.g.ontimeout=null),n.A&&(D.clearTimeout(n.A),n.A=null)}function je(n){return n.g?n.g.readyState:0}function $c(n){try{if(!n.g)return null;if("response"in n.g)return n.g.response;switch(n.K){case Gc:case"text":return n.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in n.g)return n.g.mozResponseArrayBuffer}return null}catch{return null}}function Wc(n){let e="";return Ks(n,function(t,r){e+=r,e+=":",e+=t,e+="\r\n"}),e}function mo(n,e,t){e:{for(r in t){var r=!1;break e}r=!0}r||(t=Wc(t),"string"==typeof n?null!=t&&encodeURIComponent(String(t)):W(n,e,t))}function fr(n,e,t){return t&&t.internalChannelParams&&t.internalChannelParams[n]||e}function Hc(n){this.Ga=0,this.j=[],this.l=new mi,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=fr("failFast",!1,n),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=fr("baseRetryDelayMs",5e3,n),this.hb=fr("retryDelaySeedMs",1e4,n),this.eb=fr("forwardChannelMaxRetries",2,n),this.xa=fr("forwardChannelRequestTimeoutMs",2e4,n),this.va=n&&n.xmlHttpFactory||void 0,this.Ha=n&&n.useFetchStreams||!1,this.L=void 0,this.J=n&&n.supportsCrossDomainXhr||!1,this.K="",this.i=new Mc(n&&n.concurrentRequestLimit),this.Ja=new Jm,this.P=n&&n.fastHandshake||!1,this.O=n&&n.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=n&&n.bc||!1,n&&n.Ea&&this.l.Ea(),n&&n.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&n&&n.detectBufferingProxy||!1,this.qa=void 0,n&&n.longPollingTimeout&&0<n.longPollingTimeout&&(this.qa=n.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function go(n){if(Zc(n),3==n.H){var e=n.W++,t=Xe(n.I);if(W(t,"SID",n.K),W(t,"RID",e),W(t,"TYPE","terminate"),mr(n,t),(e=new ir(n,n.l,e)).L=2,e.A=Ei(Xe(t)),t=!1,D.navigator&&D.navigator.sendBeacon)try{t=D.navigator.sendBeacon(e.A.toString(),"")}catch{}!t&&D.Image&&((new Image).src=e.A,t=!0),t||(e.g=sl(e.l,null),e.g.ha(e.A)),e.G=Date.now(),sr(e)}rl(n)}function Ri(n){n.g&&(_o(n),n.g.cancel(),n.g=null)}function Zc(n){Ri(n),n.u&&(D.clearTimeout(n.u),n.u=null),Si(n),n.i.cancel(),n.m&&("number"==typeof n.m&&D.clearTimeout(n.m),n.m=null)}function Pi(n){if(!Oc(n.i)&&!n.m){n.m=!0;var e=n.Na;Jn||hc(),Xn||(Jn(),Xn=!0),eo.add(e,n),n.C=0}}function Yc(n,e){var t;t=e?e.m:n.W++;const r=Xe(n.I);W(r,"SID",n.K),W(r,"RID",t),W(r,"AID",n.V),mr(n,r),n.o&&n.s&&mo(r,n.o,n.s),t=new ir(n,n.l,t,n.C+1),null===n.o&&(t.I=n.s),e&&(n.j=e.F.concat(n.j)),e=Jc(n,t,1e3),t.setTimeout(Math.round(.5*n.xa)+Math.round(.5*n.xa*Math.random())),ho(n.i,t),uo(t,r,e)}function mr(n,e){n.na&&Ks(n.na,function(t,r){W(e,r,t)}),n.h&&xc({},function(t,r){W(e,r,t)})}function Jc(n,e,t){t=Math.min(n.j.length,t);var r=n.h?Te(n.h.Va,n.h,n):null;e:{var i=n.j;let s=-1;for(;;){const o=["count="+t];-1==s?0<t?(s=i[0].g,o.push("ofs="+s)):s=0:o.push("ofs="+s);let a=!0;for(let u=0;u<t;u++){let c=i[u].g;const l=i[u].map;if(c-=s,0>c)s=Math.max(0,i[u].g-100),a=!1;else try{Xm(l,o,"req"+c+"_")}catch{r&&r(l)}}if(a){r=o.join("&");break e}}}return n=n.j.splice(0,t),e.F=n,r}function Xc(n){if(!n.g&&!n.u){n.ba=1;var e=n.Ma;Jn||hc(),Xn||(Jn(),Xn=!0),eo.add(e,n),n.A=0}}function po(n){return!(n.g||n.u||3<=n.A||(n.ba++,n.u=nr(Te(n.Ma,n),nl(n,n.A)),n.A++,0))}function _o(n){null!=n.B&&(D.clearTimeout(n.B),n.B=null)}function el(n){n.g=new ir(n,n.l,"rpc",n.ba),null===n.o&&(n.g.I=n.s),n.g.O=0;var e=Xe(n.wa);W(e,"RID","rpc"),W(e,"SID",n.K),W(e,"AID",n.V),W(e,"CI",n.G?"0":"1"),!n.G&&n.qa&&W(e,"TO",n.qa),W(e,"TYPE","xmlhttp"),mr(n,e),n.o&&n.s&&mo(e,n.o,n.s),n.L&&n.g.setTimeout(n.L);var t=n.g;n=n.pa,t.L=1,t.A=Ei(Xe(e)),t.u=null,t.S=!0,Rc(t,n)}function Si(n){null!=n.v&&(D.clearTimeout(n.v),n.v=null)}function tl(n,e){var t=null;if(n.g==e){Si(n),_o(n),n.g=null;var r=2}else{if(!lo(n.i,e))return;t=e.F,Bc(n.i,e),r=1}if(0!=n.H)if(e.i)if(1==r){t=e.u?e.u.length:0,e=Date.now()-e.G;var i=n.C;ge(r=gi(),new Ic(r,t)),Pi(n)}else Xc(n);else if(3==(i=e.s)||0==i&&0<e.ca||!(1==r&&function og(n,e){return!(Lc(n.i)>=n.i.j-(n.m?1:0)||(n.m?(n.j=e.F.concat(n.j),0):1==n.H||2==n.H||n.C>=(n.cb?0:n.eb)||(n.m=nr(Te(n.Na,n,e),nl(n,n.C)),n.C++,0)))}(n,e)||2==r&&po(n)))switch(t&&0<t.length&&(e=n.i,e.i=e.i.concat(t)),i){case 1:Ft(n,5);break;case 4:Ft(n,10);break;case 3:Ft(n,6);break;default:Ft(n,2)}}function nl(n,e){let t=n.ab+Math.floor(Math.random()*n.hb);return n.isActive()||(t*=2),t*e}function Ft(n,e){if(n.l.info("Error code "+e),2==e){var t=null;n.h&&(t=null);var r=Te(n.pb,n);t||(t=new kt("//www.google.com/images/cleardot.gif"),D.location&&"http"==D.location.protocol||Ii(t,"https"),Ei(t)),function eg(n,e){const t=new mi;if(D.Image){const r=new Image;r.onload=ui(vi,t,r,"TestLoadImage: loaded",!0,e),r.onerror=ui(vi,t,r,"TestLoadImage: error",!1,e),r.onabort=ui(vi,t,r,"TestLoadImage: abort",!1,e),r.ontimeout=ui(vi,t,r,"TestLoadImage: timeout",!1,e),D.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=n}else e(!1)}(t.toString(),r)}else Re(2);n.H=0,n.h&&n.h.za(e),rl(n),Zc(n)}function rl(n){if(n.H=0,n.ma=[],n.h){const e=qc(n.i);(0!=e.length||0!=n.j.length)&&(Yu(n.ma,e),Yu(n.ma,n.j),n.i.i.length=0,Ms(n.j),n.j.length=0),n.h.ya()}}function il(n,e,t){var r=t instanceof kt?Xe(t):new kt(t);if(""!=r.g)e&&(r.g=e+"."+r.g),Ti(r,r.m);else{var i=D.location;r=i.protocol,e=e?e+"."+i.hostname:i.hostname,i=+i.port;var s=new kt(null);r&&Ii(s,r),e&&(s.g=e),i&&Ti(s,i),t&&(s.l=t),r=s}return e=n.Da,(t=n.F)&&e&&W(r,t,e),W(r,"VER",n.ra),mr(n,r),r}function sl(n,e,t){if(e&&!n.J)throw Error("Can't create secondary domain capable XhrIo object.");return(e=new te(n.Ha&&!n.va?new lr({ob:t}):n.va)).Oa(n.J),e}function ol(){}function Vi(){if(rn&&!(10<=Number(Im)))throw Error("Environmental error: no available transport.")}function Ne(n,e){he.call(this),this.g=new Hc(e),this.l=n,this.h=e&&e.messageUrlParams||null,n=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(n?n["X-Client-Protocol"]="webchannel":n={"X-Client-Protocol":"webchannel"}),this.g.s=n,n=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(n?n["X-WebChannel-Content-Type"]=e.messageContentType:n={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.Ca&&(n?n["X-WebChannel-Client-Profile"]=e.Ca:n={"X-WebChannel-Client-Profile":e.Ca}),this.g.U=n,(n=e&&e.cc)&&!Hn(n)&&(this.g.o=n),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!Hn(e)&&(this.g.F=e,null!==(n=this.h)&&e in n&&e in(n=this.h)&&delete n[e]),this.j=new an(this)}function al(n){io.call(this),n.__headers__&&(this.headers=n.__headers__,this.statusCode=n.__status__,delete n.__headers__,delete n.__status__);var e=n.__sm__;if(e){e:{for(const t in e){n=t;break e}n=void 0}(this.i=n)&&(n=this.i,e=null!==e&&n in e?e[n]:void 0),this.data=e}else this.data=n}function ul(){so.call(this),this.status=1}function an(n){this.g=n}function Ue(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function yo(n,e,t){t||(t=0);var r=Array(16);if("string"==typeof e)for(var i=0;16>i;++i)r[i]=e.charCodeAt(t++)|e.charCodeAt(t++)<<8|e.charCodeAt(t++)<<16|e.charCodeAt(t++)<<24;else for(i=0;16>i;++i)r[i]=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24;var s=n.g[3],o=(e=n.g[0])+(s^(t=n.g[1])&((i=n.g[2])^s))+r[0]+3614090360&4294967295;o=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=(t=(i=(s=(e=t+(o<<7&4294967295|o>>>25))+((o=s+(i^e&(t^i))+r[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=i+(t^s&(e^t))+r[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=t+(e^i&(s^e))+r[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^t&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^e&(t^i))+r[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=i+(t^s&(e^t))+r[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=t+(e^i&(s^e))+r[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^t&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^e&(t^i))+r[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=i+(t^s&(e^t))+r[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=t+(e^i&(s^e))+r[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^t&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^e&(t^i))+r[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=i+(t^s&(e^t))+r[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=t+(e^i&(s^e))+r[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^s&(t^i))+r[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=s+(t^i&(e^t))+r[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=i+(e^t&(s^e))+r[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=t+(s^e&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=e+(i^s&(t^i))+r[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=s+(t^i&(e^t))+r[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=i+(e^t&(s^e))+r[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=t+(s^e&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=e+(i^s&(t^i))+r[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=s+(t^i&(e^t))+r[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=i+(e^t&(s^e))+r[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=t+(s^e&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=e+(i^s&(t^i))+r[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=s+(t^i&(e^t))+r[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=i+(e^t&(s^e))+r[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=t+(s^e&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=e+(t^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=s+(e^t^i)+r[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^e^t)+r[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=t+(i^s^e)+r[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=e+(t^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=s+(e^t^i)+r[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^e^t)+r[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=t+(i^s^e)+r[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=e+(t^i^s)+r[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=s+(e^t^i)+r[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^e^t)+r[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=t+(i^s^e)+r[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=e+(t^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=s+(e^t^i)+r[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^e^t)+r[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=t+(i^s^e)+r[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=e+(i^(t|~s))+r[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=s+(t^(e|~i))+r[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=i+(e^(s|~t))+r[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=t+(s^(i|~e))+r[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=e+(i^(t|~s))+r[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=s+(t^(e|~i))+r[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=i+(e^(s|~t))+r[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=t+(s^(i|~e))+r[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=e+(i^(t|~s))+r[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=s+(t^(e|~i))+r[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=i+(e^(s|~t))+r[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=t+(s^(i|~e))+r[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((s=(e=t+((o=e+(i^(t|~s))+r[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=s+(t^(e|~i))+r[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((i=s+((o=i+(e^(s|~t))+r[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~e))+r[9]+3951481745&4294967295,n.g[0]=n.g[0]+e&4294967295,n.g[1]=n.g[1]+(i+(o<<21&4294967295|o>>>11))&4294967295,n.g[2]=n.g[2]+i&4294967295,n.g[3]=n.g[3]+s&4294967295}function G(n,e){this.h=e;for(var t=[],r=!0,i=n.length-1;0<=i;i--){var s=0|n[i];r&&s==e||(t[i]=s,r=!1)}this.g=t}(A=te.prototype).Oa=function(n){this.M=n},A.ha=function(n,e,t,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+n);e=e?e.toUpperCase():"GET",this.I=n,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():oo.g(),this.C=function Ec(n){return n.h||(n.h=n.i())}(this.u?this.u:oo),this.g.onreadystatechange=Te(this.La,this);try{this.G=!0,this.g.open(e,String(n),!0),this.G=!1}catch(s){return void zc(this,s)}if(n=t||"",t=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)t.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const s of r.keys())t.set(s,r.get(s))}r=Array.from(t.keys()).find(s=>"content-type"==s.toLowerCase()),i=D.FormData&&n instanceof D.FormData,!(0<=Zu(rg,e))||r||i||t.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[s,o]of t)this.g.setRequestHeader(s,o);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{Qc(this),0<this.B&&((this.L=function ig(n){return rn&&"number"==typeof n.timeout&&void 0!==n.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=Te(this.ua,this)):this.A=no(this.ua,this.B,this)),this.v=!0,this.g.send(n),this.v=!1}catch(s){zc(this,s)}},A.ua=function(){typeof ks<"u"&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,ge(this,"timeout"),this.abort(8))},A.abort=function(n){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=n||7,ge(this,"complete"),ge(this,"abort"),Ai(this))},A.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Ai(this,!0)),te.$.N.call(this)},A.La=function(){this.s||(this.G||this.v||this.l?jc(this):this.kb())},A.kb=function(){jc(this)},A.isActive=function(){return!!this.g},A.da=function(){try{return 2<je(this)?this.g.status:-1}catch{return-1}},A.ja=function(){try{return this.g?this.g.responseText:""}catch{return""}},A.Wa=function(n){if(this.g){var e=this.g.responseText;return n&&0==e.indexOf(n)&&(e=e.substring(n.length)),tg(e)}},A.Ia=function(){return this.m},A.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(A=Hc.prototype).ra=8,A.H=1,A.Na=function(n){if(this.m)if(this.m=null,1==this.H){if(!n){this.W=Math.floor(1e5*Math.random()),n=this.W++;const i=new ir(this,this.l,n);let s=this.s;if(this.U&&(s?(s=nc(s),ic(s,this.U)):s=this.U),null!==this.o||this.O||(i.I=s,s=null),this.P)e:{for(var e=0,t=0;t<this.j.length;t++){var r=this.j[t];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(e+=r)){e=t;break e}if(4096===e||t===this.j.length-1){e=t+1;break e}}e=1e3}else e=1e3;e=Jc(this,i,e),W(t=Xe(this.I),"RID",n),W(t,"CVER",22),this.F&&W(t,"X-HTTP-Session-Id",this.F),mr(this,t),s&&(this.O?e="headers="+encodeURIComponent(String(Wc(s)))+"&"+e:this.o&&mo(t,this.o,s)),ho(this.i,i),this.bb&&W(t,"TYPE","init"),this.P?(W(t,"$req",e),W(t,"SID","null"),i.aa=!0,uo(i,t,null)):uo(i,t,e),this.H=2}}else 3==this.H&&(n?Yc(this,n):0==this.j.length||Oc(this.i)||Yc(this))},A.Ma=function(){if(this.u=null,el(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var n=2*this.S;this.l.info("BP detection timer enabled: "+n),this.B=nr(Te(this.jb,this),n)}},A.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Re(10),Ri(this),el(this))},A.ib=function(){null!=this.v&&(this.v=null,Ri(this),po(this),Re(19))},A.pb=function(n){n?(this.l.info("Successfully pinged google.com"),Re(2)):(this.l.info("Failed to ping google.com"),Re(1))},A.isActive=function(){return!!this.h&&this.h.isActive(this)},(A=ol.prototype).Ba=function(){},A.Aa=function(){},A.za=function(){},A.ya=function(){},A.isActive=function(){return!0},A.Va=function(){},Vi.prototype.g=function(n,e){return new Ne(n,e)},le(Ne,he),Ne.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var n=this.g,e=this.l,t=this.h||void 0;Re(0),n.Y=e,n.na=t||{},n.G=n.aa,n.I=il(n,null,n.Y),Pi(n)},Ne.prototype.close=function(){go(this.g)},Ne.prototype.u=function(n){var e=this.g;if("string"==typeof n){var t={};t.__data__=n,n=t}else this.v&&((t={}).__data__=Xs(n),n=t);e.j.push(new Hm(e.fb++,n)),3==e.H&&Pi(e)},Ne.prototype.N=function(){this.g.h=null,delete this.j,go(this.g),delete this.g,Ne.$.N.call(this)},le(al,io),le(ul,so),le(an,ol),an.prototype.Ba=function(){ge(this.g,"a")},an.prototype.Aa=function(n){ge(this.g,new al(n))},an.prototype.za=function(n){ge(this.g,new ul)},an.prototype.ya=function(){ge(this.g,"b")},le(Ue,function ag(){this.blockSize=-1}),Ue.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Ue.prototype.j=function(n,e){void 0===e&&(e=n.length);for(var t=e-this.blockSize,r=this.m,i=this.h,s=0;s<e;){if(0==i)for(;s<=t;)yo(this,n,s),s+=this.blockSize;if("string"==typeof n){for(;s<e;)if(r[i++]=n.charCodeAt(s++),i==this.blockSize){yo(this,r),i=0;break}}else for(;s<e;)if(r[i++]=n[s++],i==this.blockSize){yo(this,r),i=0;break}}this.h=i,this.i+=e},Ue.prototype.l=function(){var n=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);n[0]=128;for(var e=1;e<n.length-8;++e)n[e]=0;var t=8*this.i;for(e=n.length-8;e<n.length;++e)n[e]=255&t,t/=256;for(this.j(n),n=Array(16),e=t=0;4>e;++e)for(var r=0;32>r;r+=8)n[t++]=this.g[e]>>>r&255;return n};var ug={};function Io(n){return-128<=n&&128>n?function pm(n,e){var t=ug;return Object.prototype.hasOwnProperty.call(t,n)?t[n]:t[n]=e(n)}(n,function(e){return new G([0|e],0>e?-1:0)}):new G([0|n],0>n?-1:0)}function Qe(n){if(isNaN(n)||!isFinite(n))return un;if(0>n)return pe(Qe(-n));for(var e=[],t=1,r=0;n>=t;r++)e[r]=n/t|0,t*=To;return new G(e,0)}var To=4294967296,un=Io(0),Eo=Io(1),ll=Io(16777216);function et(n){if(0!=n.h)return!1;for(var e=0;e<n.g.length;e++)if(0!=n.g[e])return!1;return!0}function Me(n){return-1==n.h}function pe(n){for(var e=n.g.length,t=[],r=0;r<e;r++)t[r]=~n.g[r];return new G(t,~n.h).add(Eo)}function xi(n,e){return n.add(pe(e))}function Ci(n,e){for(;(65535&n[e])!=n[e];)n[e+1]+=n[e]>>>16,n[e]&=65535,e++}function gr(n,e){this.g=n,this.h=e}function Di(n,e){if(et(e))throw Error("division by zero");if(et(n))return new gr(un,un);if(Me(n))return e=Di(pe(n),e),new gr(pe(e.g),pe(e.h));if(Me(e))return e=Di(n,pe(e)),new gr(pe(e.g),e.h);if(30<n.g.length){if(Me(n)||Me(e))throw Error("slowDivide_ only works with positive integers.");for(var t=Eo,r=e;0>=r.X(n);)t=hl(t),r=hl(r);var i=cn(t,1),s=cn(r,1);for(r=cn(r,2),t=cn(t,2);!et(r);){var o=s.add(r);0>=o.X(n)&&(i=i.add(t),s=o),r=cn(r,1),t=cn(t,1)}return e=xi(n,i.R(e)),new gr(i,e)}for(i=un;0<=n.X(e);){for(t=Math.max(1,Math.floor(n.ea()/e.ea())),r=48>=(r=Math.ceil(Math.log(t)/Math.LN2))?1:Math.pow(2,r-48),o=(s=Qe(t)).R(e);Me(o)||0<o.X(n);)o=(s=Qe(t-=r)).R(e);et(s)&&(s=Eo),i=i.add(s),n=xi(n,o)}return new gr(i,n)}function hl(n){for(var e=n.g.length+1,t=[],r=0;r<e;r++)t[r]=n.D(r)<<1|n.D(r-1)>>>31;return new G(t,n.h)}function cn(n,e){var t=e>>5;e%=32;for(var r=n.g.length-t,i=[],s=0;s<r;s++)i[s]=0<e?n.D(s+t)>>>e|n.D(s+t+1)<<32-e:n.D(s+t);return new G(i,n.h)}(A=G.prototype).ea=function(){if(Me(this))return-pe(this).ea();for(var n=0,e=1,t=0;t<this.g.length;t++){var r=this.D(t);n+=(0<=r?r:To+r)*e,e*=To}return n},A.toString=function(n){if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if(et(this))return"0";if(Me(this))return"-"+pe(this).toString(n);for(var e=Qe(Math.pow(n,6)),t=this,r="";;){var i=Di(t,e).g,s=((0<(t=xi(t,i.R(e))).g.length?t.g[0]:t.h)>>>0).toString(n);if(et(t=i))return s+r;for(;6>s.length;)s="0"+s;r=s+r}},A.D=function(n){return 0>n?0:n<this.g.length?this.g[n]:this.h},A.X=function(n){return Me(n=xi(this,n))?-1:et(n)?0:1},A.abs=function(){return Me(this)?pe(this):this},A.add=function(n){for(var e=Math.max(this.g.length,n.g.length),t=[],r=0,i=0;i<=e;i++){var s=r+(65535&this.D(i))+(65535&n.D(i)),o=(s>>>16)+(this.D(i)>>>16)+(n.D(i)>>>16);r=o>>>16,t[i]=(o&=65535)<<16|(s&=65535)}return new G(t,-2147483648&t[t.length-1]?-1:0)},A.R=function(n){if(et(this)||et(n))return un;if(Me(this))return Me(n)?pe(this).R(pe(n)):pe(pe(this).R(n));if(Me(n))return pe(this.R(pe(n)));if(0>this.X(ll)&&0>n.X(ll))return Qe(this.ea()*n.ea());for(var e=this.g.length+n.g.length,t=[],r=0;r<2*e;r++)t[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<n.g.length;i++){var s=this.D(r)>>>16,o=65535&this.D(r),a=n.D(i)>>>16,u=65535&n.D(i);t[2*r+2*i]+=o*u,Ci(t,2*r+2*i),t[2*r+2*i+1]+=s*u,Ci(t,2*r+2*i+1),t[2*r+2*i+1]+=o*a,Ci(t,2*r+2*i+1),t[2*r+2*i+2]+=s*a,Ci(t,2*r+2*i+2)}for(r=0;r<e;r++)t[r]=t[2*r+1]<<16|t[2*r];for(r=e;r<2*e;r++)t[r]=0;return new G(t,0)},A.gb=function(n){return Di(this,n).h},A.and=function(n){for(var e=Math.max(this.g.length,n.g.length),t=[],r=0;r<e;r++)t[r]=this.D(r)&n.D(r);return new G(t,this.h&n.h)},A.or=function(n){for(var e=Math.max(this.g.length,n.g.length),t=[],r=0;r<e;r++)t[r]=this.D(r)|n.D(r);return new G(t,this.h|n.h)},A.xor=function(n){for(var e=Math.max(this.g.length,n.g.length),t=[],r=0;r<e;r++)t[r]=this.D(r)^n.D(r);return new G(t,this.h^n.h)},Vi.prototype.createWebChannel=Vi.prototype.g,Ne.prototype.send=Ne.prototype.u,Ne.prototype.open=Ne.prototype.m,Ne.prototype.close=Ne.prototype.close,pi.NO_ERROR=0,pi.TIMEOUT=8,pi.HTTP_ERROR=6,Tc.COMPLETE="complete",vc.EventType=rr,rr.OPEN="a",rr.CLOSE="b",rr.ERROR="c",rr.MESSAGE="d",he.prototype.listen=he.prototype.O,te.prototype.listenOnce=te.prototype.P,te.prototype.getLastError=te.prototype.Sa,te.prototype.getLastErrorCode=te.prototype.Ia,te.prototype.getStatus=te.prototype.da,te.prototype.getResponseJson=te.prototype.Wa,te.prototype.getResponseText=te.prototype.ja,te.prototype.send=te.prototype.ha,te.prototype.setWithCredentials=te.prototype.Oa,Ue.prototype.digest=Ue.prototype.l,Ue.prototype.reset=Ue.prototype.reset,Ue.prototype.update=Ue.prototype.j,G.prototype.add=G.prototype.add,G.prototype.multiply=G.prototype.R,G.prototype.modulo=G.prototype.gb,G.prototype.compare=G.prototype.X,G.prototype.toNumber=G.prototype.ea,G.prototype.toString=G.prototype.toString,G.prototype.getBits=G.prototype.D,G.fromNumber=Qe,G.fromString=function cl(n,e){if(0==n.length)throw Error("number format error: empty string");if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if("-"==n.charAt(0))return pe(cl(n.substring(1),e));if(0<=n.indexOf("-"))throw Error('number format error: interior "-" character');for(var t=Qe(Math.pow(e,8)),r=un,i=0;i<n.length;i+=8){var s=Math.min(8,n.length-i),o=parseInt(n.substring(i,i+s),e);8>s?(s=Qe(Math.pow(e,s)),r=r.R(s).add(Qe(o))):r=(r=r.R(t)).add(Qe(o))}return r};var cg=qe.createWebChannelTransport=function(){return new Vi},lg=qe.getStatEventTarget=function(){return gi()},vo=qe.ErrorCode=pi,hg=qe.EventType=Tc,dg=qe.Event=bt,dl=qe.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},bi=(qe.FetchXmlHttpFactory=lr,qe.WebChannel=vc),fg=qe.XhrIo=te,mg=qe.Md5=Ue,ln=qe.Integer=G;const fl="@firebase/firestore";class de{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}de.UNAUTHENTICATED=new de(null),de.GOOGLE_CREDENTIALS=new de("google-credentials-uid"),de.FIRST_PARTY=new de("first-party-uid"),de.MOCK_USER=new de("mock-user");let hn="10.9.0";const dt=new ze.Yd("@firebase/firestore");function dn(){return dt.logLevel}function y(n,...e){if(dt.logLevel<=ze.in.DEBUG){const t=e.map(wo);dt.debug(`Firestore (${hn}): ${n}`,...t)}}function ie(n,...e){if(dt.logLevel<=ze.in.ERROR){const t=e.map(wo);dt.error(`Firestore (${hn}): ${n}`,...t)}}function Ce(n,...e){if(dt.logLevel<=ze.in.WARN){const t=e.map(wo);dt.warn(`Firestore (${hn}): ${n}`,...t)}}function wo(n){if("string"==typeof n)return n;try{return JSON.stringify(n)}catch{return n}}function R(n="Unexpected state"){const e=`FIRESTORE (${hn}) INTERNAL ASSERTION FAILED: `+n;throw ie(e),new Error(e)}function P(n,e){n||R()}function v(n,e){return n}const g={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _ extends q.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class ue{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class ml{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class _g{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(de.UNAUTHENTICATED))}shutdown(){}}class yg{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Ig{constructor(e){this.t=e,this.currentUser=de.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){var r=this;let i=this.i;const s=c=>this.i!==i?(i=this.i,t(c)):Promise.resolve();let o=new ue;this.o=()=>{this.i++,this.currentUser=this.u(),o.resolve(),o=new ue,e.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const c=o;e.enqueueRetryable((0,p.Z)(function*(){yield c.promise,yield s(r.currentUser)}))},u=c=>{y("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(c=>u(c)),setTimeout(()=>{if(!this.auth){const c=this.t.getImmediate({optional:!0});c?u(c):(y("FirebaseAuthCredentialsProvider","Auth not yet detected"),o.resolve(),o=new ue)}},0),a()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(y("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(P("string"==typeof r.accessToken),new ml(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return P(null===e||"string"==typeof e),new de(e)}}class Tg{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=de.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Eg{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new Tg(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(de.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class gl{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class vg{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const r=s=>{null!=s.error&&y("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);const o=s.token!==this.R;return this.R=s.token,y("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>r(s))};const i=s=>{y("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){const s=this.A.getImmediate({optional:!0});s?i(s):y("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(P("string"==typeof t.token),this.R=t.token,new gl(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function wg(n){const e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}class pl{static newId(){const t=62*Math.floor(256/62);let r="";for(;r.length<20;){const i=wg(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<t&&(r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(i[s]%62))}return r}}function C(n,e){return n<e?-1:n>e?1:0}function fn(n,e,t){return n.length===e.length&&n.every((r,i)=>t(r,e[i]))}function _l(n){return n+"\0"}class X{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new _(g.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new _(g.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _(g.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new _(g.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return X.fromMillis(Date.now())}static fromDate(e){return X.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),r=Math.floor(1e6*(e-1e3*t));return new X(t,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?C(this.nanoseconds,e.nanoseconds):C(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -62135596800).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class V{constructor(e){this.timestamp=e}static fromTimestamp(e){return new V(e)}static min(){return new V(new X(0,0))}static max(){return new V(new X(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class pr{constructor(e,t,r){void 0===t?t=0:t>e.length&&R(),void 0===r?r=e.length-t:r>e.length-t&&R(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return 0===pr.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof pr?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const r=Math.min(e.length,t.length);for(let i=0;i<r;i++){const s=e.get(i),o=t.get(i);if(s<o)return-1;if(s>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class M extends pr{construct(e,t,r){return new M(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const r of e){if(r.indexOf("//")>=0)throw new _(g.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(i=>i.length>0))}return new M(t)}static emptyPath(){return new M([])}}const Ag=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class H extends pr{construct(e,t,r){return new H(e,t,r)}static isValidIdentifier(e){return Ag.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),H.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new H(["__name__"])}static fromServerFormat(e){const t=[];let r="",i=0;const s=()=>{if(0===r.length)throw new _(g.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""};let o=!1;for(;i<e.length;){const a=e[i];if("\\"===a){if(i+1===e.length)throw new _(g.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const u=e[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new _(g.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,i+=2}else"`"===a?(o=!o,i++):"."!==a||o?(r+=a,i++):(s(),i++)}if(s(),o)throw new _(g.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new H(t)}static emptyPath(){return new H([])}}class w{constructor(e){this.path=e}static fromPath(e){return new w(M.fromString(e))}static fromName(e){return new w(M.fromString(e).popFirst(5))}static empty(){return new w(M.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===M.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return M.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new w(new M(e.slice()))}}class mn{constructor(e,t,r,i){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=i}}function Ao(n){return n.fields.find(e=>2===e.kind)}function Mt(n){return n.fields.filter(e=>2!==e.kind)}mn.UNKNOWN_ID=-1;class Ot{constructor(e,t){this.fieldPath=e,this.kind=t}}class gn{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new gn(0,ke.min())}}function yl(n,e){const t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=V.fromTimestamp(1e9===r?new X(t+1,0):new X(t,r));return new ke(i,w.empty(),e)}function Il(n){return new ke(n.readTime,n.key,-1)}class ke{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new ke(V.min(),w.empty(),-1)}static max(){return new ke(V.max(),w.empty(),-1)}}function Ro(n,e){let t=n.readTime.compareTo(e.readTime);return 0!==t?t:(t=w.comparator(n.documentKey,e.documentKey),0!==t?t:C(n.largestBatchId,e.largestBatchId))}const Tl="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class El{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}function ft(n){return Po.apply(this,arguments)}function Po(){return Po=(0,p.Z)(function*(n){if(n.code!==g.FAILED_PRECONDITION||n.message!==Tl)throw n;y("LocalStore","Unexpectedly lost primary lease")}),Po.apply(this,arguments)}class f{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&R(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new f((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(r,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof f?t:f.resolve(t)}catch(t){return f.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):f.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):f.reject(t)}static resolve(e){return new f((t,r)=>{t(e)})}static reject(e){return new f((t,r)=>{r(e)})}static waitFor(e){return new f((t,r)=>{let i=0,s=0,o=!1;e.forEach(a=>{++i,a.next(()=>{++s,o&&s===i&&t()},u=>r(u))}),o=!0,s===i&&t()})}static or(e){let t=f.resolve(!1);for(const r of e)t=t.next(i=>i?f.resolve(i):r());return t}static forEach(e,t){const r=[];return e.forEach((i,s)=>{r.push(t.call(this,i,s))}),this.waitFor(r)}static mapArray(e,t){return new f((r,i)=>{const s=e.length,o=new Array(s);let a=0;for(let u=0;u<s;u++){const c=u;t(e[c]).next(l=>{o[c]=l,++a,a===s&&r(o)},l=>i(l))}})}static doWhile(e,t){return new f((r,i)=>{const s=()=>{!0===e()?t().next(()=>{s()},i):r()};s()})}}class Ni{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new ue,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new _r(e,t.error)):this.V.resolve()},this.transaction.onerror=r=>{const i=So(r.target.error);this.V.reject(new _r(e,i))}}static open(e,t,r,i){try{return new Ni(t,e.transaction(i,r))}catch(s){throw new _r(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(y("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new Vg(t)}}class Oe{constructor(e,t,r){this.name=e,this.version=t,this.p=r,12.2===Oe.S((0,q.z$)())&&ie("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return y("SimpleDb","Removing database:",e),Lt(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,q.hl)())return!1;if(Oe.C())return!0;const e=(0,q.z$)(),t=Oe.S(e),r=0<t&&t<10,i=Oe.v(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)}static C(){var e;return typeof process<"u"&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(r)}static v(e){const t=e.match(/Android ([\d.]+)/i),r=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(r)}O(e){var t=this;return(0,p.Z)(function*(){return t.db||(y("SimpleDb","Opening database:",t.name),t.db=yield new Promise((r,i)=>{const s=indexedDB.open(t.name,t.version);s.onsuccess=o=>{r(o.target.result)},s.onblocked=()=>{i(new _r(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=o=>{const a=o.target.error;i("VersionError"===a.name?new _(g.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh."):"InvalidStateError"===a.name?new _(g.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+a):new _r(e,a))},s.onupgradeneeded=o=>{y("SimpleDb",'Database "'+t.name+'" requires upgrade from version:',o.oldVersion),t.p.N(o.target.result,s.transaction,o.oldVersion,t.version).next(()=>{y("SimpleDb","Database upgrade to version "+t.version+" complete")})}})),t.L&&(t.db.onversionchange=r=>t.L(r)),t.db})()}B(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,r,i){var s=this;return(0,p.Z)(function*(){const o="readonly"===t;let a=0;for(;;){++a;try{s.db=yield s.O(e);const u=Ni.open(s.db,e,o?"readonly":"readwrite",r),c=i(u).next(l=>(u.g(),l)).catch(l=>(u.abort(l),f.reject(l))).toPromise();return c.catch(()=>{}),yield u.m,c}catch(u){const c=u,l="FirebaseError"!==c.name&&a<3;if(y("SimpleDb","Transaction failed with error:",c.message,"Retrying:",l),s.close(),!l)return Promise.reject(c)}}})()}close(){this.db&&this.db.close(),this.db=void 0}}class Sg{constructor(e){this.k=e,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(e){this.k=e}done(){this.q=!0}U(e){this.K=e}delete(){return Lt(this.k.delete())}}class _r extends _{constructor(e,t){super(g.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function mt(n){return"IndexedDbTransactionError"===n.name}class Vg{constructor(e){this.store=e}put(e,t){let r;return void 0!==t?(y("SimpleDb","PUT",this.store.name,e,t),r=this.store.put(t,e)):(y("SimpleDb","PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),Lt(r)}add(e){return y("SimpleDb","ADD",this.store.name,e,e),Lt(this.store.add(e))}get(e){return Lt(this.store.get(e)).next(t=>(void 0===t&&(t=null),y("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return y("SimpleDb","DELETE",this.store.name,e),Lt(this.store.delete(e))}count(){return y("SimpleDb","COUNT",this.store.name),Lt(this.store.count())}W(e,t){const r=this.options(e,t),i=r.index?this.store.index(r.index):this.store;if("function"==typeof i.getAll){const s=i.getAll(r.range);return new f((o,a)=>{s.onerror=u=>{a(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{const s=this.cursor(r),o=[];return this.G(s,(a,u)=>{o.push(u)}).next(()=>o)}}j(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new f((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}H(e,t){y("SimpleDb","DELETE ALL",this.store.name);const r=this.options(e,t);r.J=!1;const i=this.cursor(r);return this.G(i,(s,o,a)=>a.delete())}Y(e,t){let r;t?r=e:(r={},t=e);const i=this.cursor(r);return this.G(i,t)}Z(e){const t=this.cursor({});return new f((r,i)=>{t.onerror=s=>{const o=So(s.target.error);i(o)},t.onsuccess=s=>{const o=s.target.result;o?e(o.primaryKey,o.value).next(a=>{a?o.continue():r()}):r()}})}G(e,t){const r=[];return new f((i,s)=>{e.onerror=o=>{s(o.target.error)},e.onsuccess=o=>{const a=o.target.result;if(!a)return void i();const u=new Sg(a),c=t(a.primaryKey,a.value,u);if(c instanceof f){const l=c.catch(h=>(u.done(),f.reject(h)));r.push(l)}u.isDone?i():null===u.$?a.continue():a.continue(u.$)}}).next(()=>f.waitFor(r))}options(e,t){let r;return void 0!==e&&("string"==typeof e?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const r=this.store.index(e.index);return e.J?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Lt(n){return new f((e,t)=>{n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{const i=So(r.target.error);t(i)}})}let vl=!1;function So(n){const e=Oe.S((0,q.z$)());if(e>=12.2&&e<13){const t="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(t)>=0){const r=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return vl||(vl=!0,setTimeout(()=>{throw r},0)),r}}return n}class xg{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(e){var t=this;y("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(0,p.Z)(function*(){t.task=null;try{y("IndexBackfiller",`Documents written: ${yield t.X.te()}`)}catch(r){mt(r)?y("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",r):yield ft(r)}yield t.ee(6e4)}))}}class Cg{constructor(e,t){this.localStore=e,this.persistence=t}te(e=50){var t=this;return(0,p.Z)(function*(){return t.persistence.runTransaction("Backfill Indexes","readwrite-primary",r=>t.ne(r,e))})()}ne(e,t){const r=new Set;let i=t,s=!0;return f.doWhile(()=>!0===s&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(o=>{if(null!==o&&!r.has(o))return y("IndexBackfiller",`Processing collection: ${o}`),this.re(e,o,i).next(a=>{i-=a,r.add(o)});s=!1})).next(()=>t-i)}re(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,r).next(s=>{const o=s.changes;return this.localStore.indexManager.updateIndexEntries(e,o).next(()=>this.ie(i,s)).next(a=>(y("IndexBackfiller",`Updating offset: ${a}`),this.localStore.indexManager.updateCollectionGroup(e,t,a))).next(()=>o.size)}))}ie(e,t){let r=e;return t.changes.forEach((i,s)=>{const o=Il(s);Ro(o,r)>0&&(r=o)}),new ke(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}let Fe=(()=>{class n{constructor(t,r){this.previousValue=t,r&&(r.sequenceNumberHandler=i=>this.se(i),this.oe=i=>r.writeSequenceNumber(i))}se(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.oe&&this.oe(t),t}}return n._e=-1,n})();function yr(n){return null==n}function Ir(n){return 0===n&&1/n==-1/0}function wl(n){return"number"==typeof n&&Number.isInteger(n)&&!Ir(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function ve(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=Al(e)),e=Dg(n.get(t),e);return Al(e)}function Dg(n,e){let t=e;const r=n.length;for(let i=0;i<r;i++){const s=n.charAt(i);switch(s){case"\0":t+="\x01\x10";break;case"\x01":t+="\x01\x11";break;default:t+=s}}return t}function Al(n){return n+"\x01\x01"}function $e(n){const e=n.length;if(P(e>=2),2===e)return P("\x01"===n.charAt(0)&&"\x01"===n.charAt(1)),M.emptyPath();const t=e-2,r=[];let i="";for(let s=0;s<e;){const o=n.indexOf("\x01",s);switch((o<0||o>t)&&R(),n.charAt(o+1)){case"\x01":const a=n.substring(s,o);let u;0===i.length?u=a:(i+=a,u=i,i=""),r.push(u);break;case"\x10":i+=n.substring(s,o),i+="\0";break;case"\x11":i+=n.substring(s,o+1);break;default:R()}s=o+2}return new M(r)}const Rl=["userId","batchId"];function ki(n,e){return[n,ve(e)]}function Pl(n,e,t){return[n,ve(e),t]}const bg={},Ng=["prefixPath","collectionGroup","readTime","documentId"],kg=["prefixPath","collectionGroup","documentId"],Fg=["collectionGroup","readTime","prefixPath","documentId"],Mg=["canonicalId","targetId"],Og=["targetId","path"],Lg=["path","targetId"],Bg=["collectionId","parent"],qg=["indexId","uid"],Ug=["uid","sequenceNumber"],Gg=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],zg=["indexId","uid","orderedDocumentKey"],Kg=["userId","collectionPath","documentId"],jg=["userId","collectionPath","largestBatchId"],Qg=["userId","collectionGroup","largestBatchId"],Sl=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],$g=[...Sl,"documentOverlays"],Vl=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],xl=Vl,Wg=[...xl,"indexConfiguration","indexState","indexEntries"];class Vo extends El{constructor(e,t){super(),this.ae=e,this.currentSequenceNumber=t}}function fe(n,e){const t=v(n);return Oe.M(t.ae,e)}function Cl(n){let e=0;for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function gt(n,e){for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function Dl(n){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}class Q{constructor(e,t){this.comparator=e,this.root=t||_e.EMPTY}insert(e,t){return new Q(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,_e.BLACK,null,null))}remove(e){return new Q(this.comparator,this.root.remove(e,this.comparator).copy(null,null,_e.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const r=this.comparator(e,t.key);if(0===r)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){const i=this.comparator(e,r.key);if(0===i)return t+r.left.size;i<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){const e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Fi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Fi(this.root,e,this.comparator,!1)}getReverseIterator(){return new Fi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Fi(this.root,e,this.comparator,!0)}}class Fi{constructor(e,t,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?r(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class _e{constructor(e,t,r,i,s){this.key=e,this.value=t,this.color=r??_e.RED,this.left=i??_e.EMPTY,this.right=s??_e.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,i,s){return new _e(e??this.key,t??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let i=this;const s=r(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,r),null):0===s?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return _e.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===t(e,i.key)){if(i.right.isEmpty())return _e.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,_e.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,_e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw R();const e=this.left.check();if(e!==this.right.check())throw R();return e+(this.isRed()?0:1)}}_e.EMPTY=null,_e.RED=!0,_e.BLACK=!1,_e.EMPTY=new class{constructor(){this.size=0}get key(){throw R()}get value(){throw R()}get color(){throw R()}get left(){throw R()}get right(){throw R()}copy(e,t,r,i,s){return this}insert(e,t,r){return new _e(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class K{constructor(e){this.comparator=e,this.data=new Q(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){const r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){const i=r.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let r;for(r=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new bl(this.data.getIterator())}getIteratorFrom(e){return new bl(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof K)||this.size!==e.size)return!1;const t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){const i=t.getNext().key,s=r.getNext().key;if(0!==this.comparator(i,s))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new K(this.comparator);return t.data=e,t}}class bl{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function pn(n){return n.hasNext()?n.getNext():void 0}class De{constructor(e){this.fields=e,e.sort(H.comparator)}static empty(){return new De([])}unionWith(e){let t=new K(H.comparator);for(const r of this.fields)t=t.add(r);for(const r of e)t=t.add(r);return new De(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return fn(this.fields,e.fields,(t,r)=>t.isEqual(r))}}class Nl extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class ce{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new Nl("Invalid base64 string: "+s):s}}(e);return new ce(t)}static fromUint8Array(e){const t=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(e);return new ce(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(t){const r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return C(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ce.EMPTY_BYTE_STRING=new ce("");const Zg=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function pt(n){if(P(!!n),"string"==typeof n){let e=0;const t=Zg.exec(n);if(P(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}const r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:ne(n.seconds),nanos:ne(n.nanos)}}function ne(n){return"number"==typeof n?n:"string"==typeof n?Number(n):0}function tt(n){return"string"==typeof n?ce.fromBase64String(n):ce.fromUint8Array(n)}function Mi(n){var e,t;return"server_timestamp"===(null===(t=((null===(e=n?.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Oi(n){const e=n.mapValue.fields.__previous_value__;return Mi(e)?Oi(e):e}function Tr(n){const e=pt(n.mapValue.fields.__local_write_time__.timestampValue);return new X(e.seconds,e.nanos)}class Yg{constructor(e,t,r,i,s,o,a,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=u,this.useFetchStreams=c}}class _t{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new _t("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof _t&&e.projectId===this.projectId&&e.database===this.database}}const yt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Li={nullValue:"NULL_VALUE"};function It(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?Mi(n)?4:Ol(n)?9007199254740991:10:R()}function We(n,e){if(n===e)return!0;const t=It(n);if(t!==It(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return Tr(n).isEqual(Tr(e));case 3:return function(i,s){if("string"==typeof i.timestampValue&&"string"==typeof s.timestampValue&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;const o=pt(i.timestampValue),a=pt(s.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return s=e,tt(n.bytesValue).isEqual(tt(s.bytesValue));case 7:return n.referenceValue===e.referenceValue;case 8:return function(i,s){return ne(i.geoPointValue.latitude)===ne(s.geoPointValue.latitude)&&ne(i.geoPointValue.longitude)===ne(s.geoPointValue.longitude)}(n,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return ne(i.integerValue)===ne(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){const o=ne(i.doubleValue),a=ne(s.doubleValue);return o===a?Ir(o)===Ir(a):isNaN(o)&&isNaN(a)}return!1}(n,e);case 9:return fn(n.arrayValue.values||[],e.arrayValue.values||[],We);case 10:return function(i,s){const o=i.mapValue.fields||{},a=s.mapValue.fields||{};if(Cl(o)!==Cl(a))return!1;for(const u in o)if(o.hasOwnProperty(u)&&(void 0===a[u]||!We(o[u],a[u])))return!1;return!0}(n,e);default:return R()}var s}function Er(n,e){return void 0!==(n.values||[]).find(t=>We(t,e))}function Tt(n,e){if(n===e)return 0;const t=It(n),r=It(e);if(t!==r)return C(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return C(n.booleanValue,e.booleanValue);case 2:return function(s,o){const a=ne(s.integerValue||s.doubleValue),u=ne(o.integerValue||o.doubleValue);return a<u?-1:a>u?1:a===u?0:isNaN(a)?isNaN(u)?0:-1:1}(n,e);case 3:return kl(n.timestampValue,e.timestampValue);case 4:return kl(Tr(n),Tr(e));case 5:return C(n.stringValue,e.stringValue);case 6:return function(s,o){const a=tt(s),u=tt(o);return a.compareTo(u)}(n.bytesValue,e.bytesValue);case 7:return function(s,o){const a=s.split("/"),u=o.split("/");for(let c=0;c<a.length&&c<u.length;c++){const l=C(a[c],u[c]);if(0!==l)return l}return C(a.length,u.length)}(n.referenceValue,e.referenceValue);case 8:return function(s,o){const a=C(ne(s.latitude),ne(o.latitude));return 0!==a?a:C(ne(s.longitude),ne(o.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return function(s,o){const a=s.values||[],u=o.values||[];for(let c=0;c<a.length&&c<u.length;++c){const l=Tt(a[c],u[c]);if(l)return l}return C(a.length,u.length)}(n.arrayValue,e.arrayValue);case 10:return function(s,o){if(s===yt.mapValue&&o===yt.mapValue)return 0;if(s===yt.mapValue)return 1;if(o===yt.mapValue)return-1;const a=s.fields||{},u=Object.keys(a),c=o.fields||{},l=Object.keys(c);u.sort(),l.sort();for(let h=0;h<u.length&&h<l.length;++h){const d=C(u[h],l[h]);if(0!==d)return d;const m=Tt(a[u[h]],c[l[h]]);if(0!==m)return m}return C(u.length,l.length)}(n.mapValue,e.mapValue);default:throw R()}}function kl(n,e){if("string"==typeof n&&"string"==typeof e&&n.length===e.length)return C(n,e);const t=pt(n),r=pt(e),i=C(t.seconds,r.seconds);return 0!==i?i:C(t.nanos,r.nanos)}function _n(n){return xo(n)}function xo(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){const r=pt(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?tt(n.bytesValue).toBase64():"referenceValue"in n?w.fromName(n.referenceValue).toString():"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",i=!0;for(const s of t.values||[])i?i=!1:r+=",",r+=xo(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){const r=Object.keys(t.fields||{}).sort();let i="{",s=!0;for(const o of r)s?s=!1:i+=",",i+=`${o}:${xo(t.fields[o])}`;return i+"}"}(n.mapValue):R()}function Bt(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function Co(n){return!!n&&"integerValue"in n}function vr(n){return!!n&&"arrayValue"in n}function Fl(n){return!!n&&"nullValue"in n}function Ml(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function qi(n){return!!n&&"mapValue"in n}function wr(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&"object"==typeof n.timestampValue)return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){const e={mapValue:{fields:{}}};return gt(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=wr(r)),e}if(n.arrayValue){const e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=wr(n.arrayValue.values[t]);return e}return Object.assign({},n)}function Ol(n){return"__max__"===(((n.mapValue||{}).fields||{}).__type__||{}).stringValue}function Jg(n){return"nullValue"in n?Li:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?Bt(_t.empty(),w.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?{mapValue:{}}:R()}function Xg(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?Bt(_t.empty(),w.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?{mapValue:{}}:"mapValue"in n?yt:R()}function Ll(n,e){const t=Tt(n.value,e.value);return 0!==t?t:n.inclusive&&!e.inclusive?-1:!n.inclusive&&e.inclusive?1:0}function Bl(n,e){const t=Tt(n.value,e.value);return 0!==t?t:n.inclusive&&!e.inclusive?1:!n.inclusive&&e.inclusive?-1:0}class ye{constructor(e){this.value=e}static empty(){return new ye({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!qi(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=wr(t)}setAll(e){let t=H.emptyPath(),r={},i=[];e.forEach((o,a)=>{if(!t.isImmediateParentOf(a)){const u=this.getFieldsMap(t);this.applyChanges(u,r,i),r={},i=[],t=a.popLast()}o?r[a.lastSegment()]=wr(o):i.push(a.lastSegment())});const s=this.getFieldsMap(t);this.applyChanges(s,r,i)}delete(e){const t=this.field(e.popLast());qi(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return We(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let i=t.mapValue.fields[e.get(r)];qi(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,r){gt(t,(i,s)=>e[i]=s);for(const i of r)delete e[i]}clone(){return new ye(wr(this.value))}}function ql(n){const e=[];return gt(n.fields,(t,r)=>{const i=new H([t]);if(qi(r)){const s=ql(r.mapValue).fields;if(0===s.length)e.push(i);else for(const o of s)e.push(i.child(o))}else e.push(i)}),new De(e)}class Z{constructor(e,t,r,i,s,o,a){this.key=e,this.documentType=t,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=a}static newInvalidDocument(e){return new Z(e,0,V.min(),V.min(),V.min(),ye.empty(),0)}static newFoundDocument(e,t,r,i){return new Z(e,1,t,V.min(),r,i,0)}static newNoDocument(e,t){return new Z(e,2,t,V.min(),V.min(),ye.empty(),0)}static newUnknownDocument(e,t){return new Z(e,3,t,V.min(),V.min(),ye.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(V.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ye.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ye.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=V.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Z&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Z(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Et{constructor(e,t){this.position=e,this.inclusive=t}}function Ul(n,e,t){let r=0;for(let i=0;i<n.position.length;i++){const s=e[i],o=n.position[i];if(r=s.field.isKeyField()?w.comparator(w.fromName(o.referenceValue),t.key):Tt(o,t.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Gl(n,e){if(null===n)return null===e;if(null===e||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!We(n.position[t],e.position[t]))return!1;return!0}class Ar{constructor(e,t="asc"){this.field=e,this.dir=t}}function ep(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}class zl{}class O extends zl{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,r):new tp(e,t,r):"array-contains"===t?new ip(e,r):"in"===t?new Hl(e,r):"not-in"===t?new sp(e,r):"array-contains-any"===t?new op(e,r):new O(e,t,r)}static createKeyFieldInFilter(e,t,r){return"in"===t?new np(e,r):new rp(e,r)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Tt(t,this.value)):null!==t&&It(this.value)===It(t)&&this.matchesComparison(Tt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return R()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class z extends zl{constructor(e,t){super(),this.filters=e,this.op=t,this.ue=null}static create(e,t){return new z(e,t)}matches(e){return yn(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function yn(n){return"and"===n.op}function Do(n){return"or"===n.op}function bo(n){return Kl(n)&&yn(n)}function Kl(n){for(const e of n.filters)if(e instanceof z)return!1;return!0}function No(n){if(n instanceof O)return n.field.canonicalString()+n.op.toString()+_n(n.value);if(bo(n))return n.filters.map(e=>No(e)).join(",");{const e=n.filters.map(t=>No(t)).join(",");return`${n.op}(${e})`}}function jl(n,e){return n instanceof O?(r=n,(i=e)instanceof O&&r.op===i.op&&r.field.isEqual(i.field)&&We(r.value,i.value)):n instanceof z?function(r,i){return i instanceof z&&r.op===i.op&&r.filters.length===i.filters.length&&r.filters.reduce((s,o,a)=>s&&jl(o,i.filters[a]),!0)}(n,e):void R();var r,i}function Ql(n,e){const t=n.filters.concat(e);return z.create(t,n.op)}function $l(n){return n instanceof O?`${(t=n).field.canonicalString()} ${t.op} ${_n(t.value)}`:n instanceof z?function(t){return t.op.toString()+" {"+t.getFilters().map($l).join(" ,")+"}"}(n):"Filter";var t}class tp extends O{constructor(e,t,r){super(e,t,r),this.key=w.fromName(r.referenceValue)}matches(e){const t=w.comparator(e.key,this.key);return this.matchesComparison(t)}}class np extends O{constructor(e,t){super(e,"in",t),this.keys=Wl(0,t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class rp extends O{constructor(e,t){super(e,"not-in",t),this.keys=Wl(0,t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function Wl(n,e){var t;return((null===(t=e.arrayValue)||void 0===t?void 0:t.values)||[]).map(r=>w.fromName(r.referenceValue))}class ip extends O{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return vr(t)&&Er(t.arrayValue,this.value)}}class Hl extends O{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Er(this.value.arrayValue,t)}}class sp extends O{constructor(e,t){super(e,"not-in",t)}matches(e){if(Er(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Er(this.value.arrayValue,t)}}class op extends O{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!vr(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>Er(this.value.arrayValue,r))}}class ap{constructor(e,t=null,r=[],i=[],s=null,o=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=a,this.ce=null}}function ko(n,e=null,t=[],r=[],i=null,s=null,o=null){return new ap(n,e,t,r,i,s,o)}function qt(n){const e=v(n);if(null===e.ce){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>No(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>{return(s=r).field.canonicalString()+s.dir;var s}).join(","),yr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>_n(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>_n(r)).join(",")),e.ce=t}return e.ce}function Rr(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!ep(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!jl(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!Gl(n.startAt,e.startAt)&&Gl(n.endAt,e.endAt)}function Ui(n){return w.isDocumentKey(n.path)&&null===n.collectionGroup&&0===n.filters.length}function Gi(n,e){return n.filters.filter(t=>t instanceof O&&t.field.isEqual(e))}function Zl(n,e,t){let r=Li,i=!0;for(const s of Gi(n,e)){let o=Li,a=!0;switch(s.op){case"<":case"<=":o=Jg(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,a=!1;break;case"!=":case"not-in":o=Li}Ll({value:r,inclusive:i},{value:o,inclusive:a})<0&&(r=o,i=a)}if(null!==t)for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){const o=t.position[s];Ll({value:r,inclusive:i},{value:o,inclusive:t.inclusive})<0&&(r=o,i=t.inclusive);break}return{value:r,inclusive:i}}function Yl(n,e,t){let r=yt,i=!0;for(const s of Gi(n,e)){let o=yt,a=!0;switch(s.op){case">=":case">":o=Xg(s.value),a=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,a=!1;break;case"!=":case"not-in":o=yt}Bl({value:r,inclusive:i},{value:o,inclusive:a})>0&&(r=o,i=a)}if(null!==t)for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){const o=t.position[s];Bl({value:r,inclusive:i},{value:o,inclusive:t.inclusive})>0&&(r=o,i=t.inclusive);break}return{value:r,inclusive:i}}class nt{constructor(e,t=null,r=[],i=[],s=null,o="F",a=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=a,this.endAt=u,this.le=null,this.he=null,this.Pe=null}}function Jl(n,e,t,r,i,s,o,a){return new nt(n,e,t,r,i,s,o,a)}function In(n){return new nt(n)}function Xl(n){return 0===n.filters.length&&null===n.limit&&null==n.startAt&&null==n.endAt&&(0===n.explicitOrderBy.length||1===n.explicitOrderBy.length&&n.explicitOrderBy[0].field.isKeyField())}function Fo(n){return null!==n.collectionGroup}function Tn(n){const e=v(n);if(null===e.le){e.le=[];const t=new Set;for(const s of e.explicitOrderBy)e.le.push(s),t.add(s.field.canonicalString());const r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new K(H.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(a=a.add(c.field))})}),a})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.le.push(new Ar(s,r))}),t.has(H.keyField().canonicalString())||e.le.push(new Ar(H.keyField(),r))}return e.le}function Pe(n){const e=v(n);return e.he||(e.he=function eh(n,e){if("F"===n.limitType)return ko(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(i=>new Ar(i.field,"desc"===i.dir?"asc":"desc"));const t=n.endAt?new Et(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Et(n.startAt.position,n.startAt.inclusive):null;return ko(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}(e,Tn(n))),e.he}function Mo(n,e){const t=n.filters.concat([e]);return new nt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function zi(n,e,t){return new nt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function Pr(n,e){return Rr(Pe(n),Pe(e))&&n.limitType===e.limitType}function th(n){return`${qt(Pe(n))}|lt:${n.limitType}`}function En(n){return`Query(target=${function(t){let r=t.path.canonicalString();return null!==t.collectionGroup&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(i=>$l(i)).join(", ")}]`),yr(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(i=>{return`${(o=i).field.canonicalString()} (${o.dir})`;var o}).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(i=>_n(i)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(i=>_n(i)).join(",")),`Target(${r})`}(Pe(n))}; limitType=${n.limitType})`}function Sr(n,e){return e.isFoundDocument()&&function(r,i){const s=i.key.path;return null!==r.collectionGroup?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):w.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,e)&&function(r,i){for(const s of Tn(r))if(!s.field.isKeyField()&&null===i.data.field(s.field))return!1;return!0}(n,e)&&function(r,i){for(const s of r.filters)if(!s.matches(i))return!1;return!0}(n,e)&&(i=e,!((r=n).startAt&&!function(o,a,u){const c=Ul(o,a,u);return o.inclusive?c<=0:c<0}(r.startAt,Tn(r),i)||r.endAt&&!function(o,a,u){const c=Ul(o,a,u);return o.inclusive?c>=0:c>0}(r.endAt,Tn(r),i)));var r,i}function nh(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function rh(n){return(e,t)=>{let r=!1;for(const i of Tn(n)){const s=up(i,e,t);if(0!==s)return s;r=r||i.field.isKeyField()}return 0}}function up(n,e,t){const r=n.field.isKeyField()?w.comparator(e.key,t.key):function(s,o,a){const u=o.data.field(s),c=a.data.field(s);return null!==u&&null!==c?Tt(u,c):R()}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return R()}}class rt{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r)for(const[i,s]of r)if(this.equalsFn(i,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const r=this.mapKeyFn(e),i=this.inner[r];if(void 0===i)return this.inner[r]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),r=this.inner[t];if(void 0===r)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return 1===r.length?delete this.inner[t]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(e){gt(this.inner,(t,r)=>{for(const[i,s]of r)e(i,s)})}isEmpty(){return Dl(this.inner)}size(){return this.innerSize}}const cp=new Q(w.comparator);function be(){return cp}const ih=new Q(w.comparator);function Vr(...n){let e=ih;for(const t of n)e=e.insert(t.key,t);return e}function sh(n){let e=ih;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function He(){return xr()}function oh(){return xr()}function xr(){return new rt(n=>n.toString(),(n,e)=>n.isEqual(e))}const lp=new Q(w.comparator),hp=new K(w.comparator);function k(...n){let e=hp;for(const t of n)e=e.add(t);return e}const dp=new K(C);function Oo(){return dp}function ah(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ir(e)?"-0":e}}function uh(n){return{integerValue:""+n}}function ch(n,e){return wl(e)?uh(e):ah(n,e)}class Ki{constructor(){this._=void 0}}function fp(n,e,t){return n instanceof vn?function(i,s){const o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&Mi(s)&&(s=Oi(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(t,e):n instanceof Ut?hh(n,e):n instanceof Gt?dh(n,e):function(i,s){const o=lh(i,s),a=fh(o)+fh(i.Ie);return Co(o)&&Co(i.Ie)?uh(a):ah(i.serializer,a)}(n,e)}function mp(n,e,t){return n instanceof Ut?hh(n,e):n instanceof Gt?dh(n,e):t}function lh(n,e){return n instanceof wn?Co(r=e)||(s=r)&&"doubleValue"in s?e:{integerValue:0}:null;var r,s}class vn extends Ki{}class Ut extends Ki{constructor(e){super(),this.elements=e}}function hh(n,e){const t=mh(e);for(const r of n.elements)t.some(i=>We(i,r))||t.push(r);return{arrayValue:{values:t}}}class Gt extends Ki{constructor(e){super(),this.elements=e}}function dh(n,e){let t=mh(e);for(const r of n.elements)t=t.filter(i=>!We(i,r));return{arrayValue:{values:t}}}class wn extends Ki{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function fh(n){return ne(n.integerValue||n.doubleValue)}function mh(n){return vr(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}class Cr{constructor(e,t){this.field=e,this.transform=t}}class pp{constructor(e,t){this.version=e,this.transformResults=t}}class ee{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new ee}static exists(e){return new ee(void 0,e)}static updateTime(e){return new ee(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function ji(n,e){return void 0!==n.updateTime?e.isFoundDocument()&&e.version.isEqual(n.updateTime):void 0===n.exists||n.exists===e.isFoundDocument()}class Qi{}function gh(n,e){if(!n.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return n.isNoDocument()?new Rn(n.key,ee.none()):new An(n.key,n.data,ee.none());{const t=n.data,r=ye.empty();let i=new K(H.comparator);for(let s of e.fields)if(!i.has(s)){let o=t.field(s);null===o&&s.length>1&&(s=s.popLast(),o=t.field(s)),null===o?r.delete(s):r.set(s,o),i=i.add(s)}return new it(n.key,r,new De(i.toArray()),ee.none())}}function _p(n,e,t){n instanceof An?function(i,s,o){const a=i.value.clone(),u=yh(i.fieldTransforms,s,o.transformResults);a.setAll(u),s.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(n,e,t):n instanceof it?function(i,s,o){if(!ji(i.precondition,s))return void s.convertToUnknownDocument(o.version);const a=yh(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(_h(i)),u.setAll(a),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,e,t):e.convertToNoDocument(t.version).setHasCommittedMutations()}function Dr(n,e,t,r){return n instanceof An?function(s,o,a,u){if(!ji(s.precondition,o))return a;const c=s.value.clone(),l=Ih(s.fieldTransforms,u,o);return c.setAll(l),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,e,t,r):n instanceof it?function(s,o,a,u){if(!ji(s.precondition,o))return a;const c=Ih(s.fieldTransforms,u,o),l=o.data;return l.setAll(_h(s)),l.setAll(c),o.convertToFoundDocument(o.version,l).setHasLocalMutations(),null===a?null:a.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(h=>h.field))}(n,e,t,r):(a=t,ji(n.precondition,o=e)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a);var o,a}function yp(n,e){let t=null;for(const r of n.fieldTransforms){const i=e.data.field(r.field),s=lh(r.transform,i||null);null!=s&&(null===t&&(t=ye.empty()),t.set(r.field,s))}return t||null}function ph(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&(i=e.fieldTransforms,!!(void 0===(r=n.fieldTransforms)&&void 0===i||r&&i&&fn(r,i,(s,o)=>function gp(n,e){return n.field.isEqual(e.field)&&(i=e.transform,(r=n.transform)instanceof Ut&&i instanceof Ut||r instanceof Gt&&i instanceof Gt?fn(r.elements,i.elements,We):r instanceof wn&&i instanceof wn?We(r.Ie,i.Ie):r instanceof vn&&i instanceof vn);var r,i}(s,o))))&&(0===n.type?n.value.isEqual(e.value):1!==n.type||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask));var r,i}class An extends Qi{constructor(e,t,r,i=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class it extends Qi{constructor(e,t,r,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function _h(n){const e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){const r=n.data.field(t);e.set(t,r)}}),e}function yh(n,e,t){const r=new Map;P(n.length===t.length);for(let i=0;i<t.length;i++){const s=n[i],o=s.transform,a=e.data.field(s.field);r.set(s.field,mp(o,a,t[i]))}return r}function Ih(n,e,t){const r=new Map;for(const i of n){const s=i.transform,o=t.data.field(i.field);r.set(i.field,fp(s,o,e))}return r}class Rn extends Qi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Lo extends Qi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Bo{constructor(e,t,r,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(e,t){const r=t.mutationResults;for(let i=0;i<this.mutations.length;i++){const s=this.mutations[i];s.key.isEqual(e.key)&&_p(s,e,r[i])}}applyToLocalView(e,t){for(const r of this.baseMutations)r.key.isEqual(e.key)&&(t=Dr(r,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=Dr(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const r=oh();return this.mutations.forEach(i=>{const s=e.get(i.key),o=s.overlayedDocument;let a=this.applyToLocalView(o,s.mutatedFields);a=t.has(i.key)?null:a;const u=gh(o,a);null!==u&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(V.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),k())}isEqual(e){return this.batchId===e.batchId&&fn(this.mutations,e.mutations,(t,r)=>ph(t,r))&&fn(this.baseMutations,e.baseMutations,(t,r)=>ph(t,r))}}class qo{constructor(e,t,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=i}static from(e,t,r){P(e.mutations.length===r.length);let i=function(){return lp}();const s=e.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new qo(e,t,r,i)}}class Uo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Tp{constructor(e,t){this.count=e,this.unchangedNames=t}}var ae,L;function Th(n){switch(n){default:return R();case g.CANCELLED:case g.UNKNOWN:case g.DEADLINE_EXCEEDED:case g.RESOURCE_EXHAUSTED:case g.INTERNAL:case g.UNAVAILABLE:case g.UNAUTHENTICATED:return!1;case g.INVALID_ARGUMENT:case g.NOT_FOUND:case g.ALREADY_EXISTS:case g.PERMISSION_DENIED:case g.FAILED_PRECONDITION:case g.ABORTED:case g.OUT_OF_RANGE:case g.UNIMPLEMENTED:case g.DATA_LOSS:return!0}}function Eh(n){if(void 0===n)return ie("GRPC error has no .code"),g.UNKNOWN;switch(n){case ae.OK:return g.OK;case ae.CANCELLED:return g.CANCELLED;case ae.UNKNOWN:return g.UNKNOWN;case ae.DEADLINE_EXCEEDED:return g.DEADLINE_EXCEEDED;case ae.RESOURCE_EXHAUSTED:return g.RESOURCE_EXHAUSTED;case ae.INTERNAL:return g.INTERNAL;case ae.UNAVAILABLE:return g.UNAVAILABLE;case ae.UNAUTHENTICATED:return g.UNAUTHENTICATED;case ae.INVALID_ARGUMENT:return g.INVALID_ARGUMENT;case ae.NOT_FOUND:return g.NOT_FOUND;case ae.ALREADY_EXISTS:return g.ALREADY_EXISTS;case ae.PERMISSION_DENIED:return g.PERMISSION_DENIED;case ae.FAILED_PRECONDITION:return g.FAILED_PRECONDITION;case ae.ABORTED:return g.ABORTED;case ae.OUT_OF_RANGE:return g.OUT_OF_RANGE;case ae.UNIMPLEMENTED:return g.UNIMPLEMENTED;case ae.DATA_LOSS:return g.DATA_LOSS;default:return R()}}(L=ae||(ae={}))[L.OK=0]="OK",L[L.CANCELLED=1]="CANCELLED",L[L.UNKNOWN=2]="UNKNOWN",L[L.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",L[L.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",L[L.NOT_FOUND=5]="NOT_FOUND",L[L.ALREADY_EXISTS=6]="ALREADY_EXISTS",L[L.PERMISSION_DENIED=7]="PERMISSION_DENIED",L[L.UNAUTHENTICATED=16]="UNAUTHENTICATED",L[L.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",L[L.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",L[L.ABORTED=10]="ABORTED",L[L.OUT_OF_RANGE=11]="OUT_OF_RANGE",L[L.UNIMPLEMENTED=12]="UNIMPLEMENTED",L[L.INTERNAL=13]="INTERNAL",L[L.UNAVAILABLE=14]="UNAVAILABLE",L[L.DATA_LOSS=15]="DATA_LOSS";function vh(){return new TextEncoder}const Ep=new ln([4294967295,4294967295],0);function wh(n){const e=vh().encode(n),t=new mg;return t.update(e),new Uint8Array(t.digest())}function Ah(n){const e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new ln([t,r],0),new ln([i,s],0)]}class Go{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new br(`Invalid padding: ${t}`);if(r<0)throw new br(`Invalid hash count: ${r}`);if(e.length>0&&0===this.hashCount)throw new br(`Invalid hash count: ${r}`);if(0===e.length&&0!==t)throw new br(`Invalid padding when bitmap length is 0: ${t}`);this.Te=8*e.length-t,this.Ee=ln.fromNumber(this.Te)}de(e,t,r){let i=e.add(t.multiply(ln.fromNumber(r)));return 1===i.compare(Ep)&&(i=new ln([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Ee).toNumber()}Ae(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Te)return!1;const t=wh(e),[r,i]=Ah(t);for(let s=0;s<this.hashCount;s++){const o=this.de(r,i,s);if(!this.Ae(o))return!1}return!0}static create(e,t,r){const i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),o=new Go(s,i,t);return r.forEach(a=>o.insert(a)),o}insert(e){if(0===this.Te)return;const t=wh(e),[r,i]=Ah(t);for(let s=0;s<this.hashCount;s++){const o=this.de(r,i,s);this.Re(o)}}Re(e){const t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class br extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Nr{constructor(e,t,r,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,r){const i=new Map;return i.set(e,kr.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new Nr(V.min(),i,new Q(C),be(),k())}}class kr{constructor(e,t,r,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new kr(r,t,k(),k(),k())}}class Wi{constructor(e,t,r,i){this.Ve=e,this.removedTargetIds=t,this.key=r,this.me=i}}class Rh{constructor(e,t){this.targetId=e,this.fe=t}}class Ph{constructor(e,t,r=ce.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=i}}class Sh{constructor(){this.ge=0,this.pe=xh(),this.ye=ce.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(e){e.approximateByteSize()>0&&(this.Se=!0,this.ye=e)}ve(){let e=k(),t=k(),r=k();return this.pe.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:r=r.add(i);break;default:R()}}),new kr(this.ye,this.we,e,t,r)}Fe(){this.Se=!1,this.pe=xh()}Me(e,t){this.Se=!0,this.pe=this.pe.insert(e,t)}xe(e){this.Se=!0,this.pe=this.pe.remove(e)}Oe(){this.ge+=1}Ne(){this.ge-=1,P(this.ge>=0)}Le(){this.Se=!0,this.we=!0}}class vp{constructor(e){this.Be=e,this.ke=new Map,this.qe=be(),this.Qe=Vh(),this.Ke=new Q(C)}$e(e){for(const t of e.Ve)e.me&&e.me.isFoundDocument()?this.Ue(t,e.me):this.We(t,e.key,e.me);for(const t of e.removedTargetIds)this.We(t,e.key,e.me)}Ge(e){this.forEachTarget(e,t=>{const r=this.ze(t);switch(e.state){case 0:this.je(t)&&r.Ce(e.resumeToken);break;case 1:r.Ne(),r.be||r.Fe(),r.Ce(e.resumeToken);break;case 2:r.Ne(),r.be||this.removeTarget(t);break;case 3:this.je(t)&&(r.Le(),r.Ce(e.resumeToken));break;case 4:this.je(t)&&(this.He(t),r.Ce(e.resumeToken));break;default:R()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ke.forEach((r,i)=>{this.je(i)&&t(i)})}Je(e){const t=e.targetId,r=e.fe.count,i=this.Ye(t);if(i){const s=i.target;if(Ui(s))if(0===r){const o=new w(s.path);this.We(t,o,Z.newNoDocument(o,V.min()))}else P(1===r);else{const o=this.Ze(t);if(o!==r){const a=this.Xe(e),u=a?this.et(a,e,o):1;0!==u&&(this.He(t),this.Ke=this.Ke.insert(t,2===u?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}Xe(e){const t=e.fe.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=t;let o,a;try{o=tt(r).toUint8Array()}catch(u){if(u instanceof Nl)return Ce("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{a=new Go(o,i,s)}catch(u){return Ce(u instanceof br?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return 0===a.Te?null:a}et(e,t,r){return t.fe.count===r-this.rt(e,t.targetId)?0:2}rt(e,t){const r=this.Be.getRemoteKeysForTarget(t);let i=0;return r.forEach(s=>{const o=this.Be.nt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;e.mightContain(a)||(this.We(t,s,null),i++)}),i}it(e){const t=new Map;this.ke.forEach((s,o)=>{const a=this.Ye(o);if(a){if(s.current&&Ui(a.target)){const u=new w(a.target.path);null!==this.qe.get(u)||this.st(o,u)||this.We(o,u,Z.newNoDocument(u,e))}s.De&&(t.set(o,s.ve()),s.Fe())}});let r=k();this.Qe.forEach((s,o)=>{let a=!0;o.forEachWhile(u=>{const c=this.Ye(u);return!c||"TargetPurposeLimboResolution"===c.purpose||(a=!1,!1)}),a&&(r=r.add(s))}),this.qe.forEach((s,o)=>o.setReadTime(e));const i=new Nr(e,t,this.Ke,this.qe,r);return this.qe=be(),this.Qe=Vh(),this.Ke=new Q(C),i}Ue(e,t){if(!this.je(e))return;const r=this.st(e,t.key)?2:0;this.ze(e).Me(t.key,r),this.qe=this.qe.insert(t.key,t),this.Qe=this.Qe.insert(t.key,this.ot(t.key).add(e))}We(e,t,r){if(!this.je(e))return;const i=this.ze(e);this.st(e,t)?i.Me(t,1):i.xe(t),this.Qe=this.Qe.insert(t,this.ot(t).delete(e)),r&&(this.qe=this.qe.insert(t,r))}removeTarget(e){this.ke.delete(e)}Ze(e){const t=this.ze(e).ve();return this.Be.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Oe(e){this.ze(e).Oe()}ze(e){let t=this.ke.get(e);return t||(t=new Sh,this.ke.set(e,t)),t}ot(e){let t=this.Qe.get(e);return t||(t=new K(C),this.Qe=this.Qe.insert(e,t)),t}je(e){const t=null!==this.Ye(e);return t||y("WatchChangeAggregator","Detected inactive target",e),t}Ye(e){const t=this.ke.get(e);return t&&t.be?null:this.Be._t(e)}He(e){this.ke.set(e,new Sh),this.Be.getRemoteKeysForTarget(e).forEach(t=>{this.We(e,t,null)})}st(e,t){return this.Be.getRemoteKeysForTarget(e).has(t)}}function Vh(){return new Q(w.comparator)}function xh(){return new Q(w.comparator)}const wp={asc:"ASCENDING",desc:"DESCENDING"},Ap={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Rp={and:"AND",or:"OR"};class Pp{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function zo(n,e){return n.useProto3Json||yr(e)?e:{value:e}}function Pn(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Ch(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function Sp(n,e){return Pn(n,e.toTimestamp())}function se(n){return P(!!n),V.fromTimestamp(function(t){const r=pt(t);return new X(r.seconds,r.nanos)}(n))}function Ko(n,e){return jo(n,e).canonicalString()}function jo(n,e){const t=(i=n,new M(["projects",i.projectId,"databases",i.database])).child("documents");var i;return void 0===e?t:t.child(e)}function Dh(n){const e=M.fromString(n);return P(Uh(e)),e}function Fr(n,e){return Ko(n.databaseId,e.path)}function Ze(n,e){const t=Dh(e);if(t.get(1)!==n.databaseId.projectId)throw new _(g.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new _(g.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new w(kh(t))}function bh(n,e){return Ko(n.databaseId,e)}function Nh(n){const e=Dh(n);return 4===e.length?M.emptyPath():kh(e)}function Qo(n){return new M(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function kh(n){return P(n.length>4&&"documents"===n.get(4)),n.popFirst(5)}function Fh(n,e,t){return{name:Fr(n,e),fields:t.value.mapValue.fields}}function Mh(n,e,t){const r=Ze(n,e.name),i=se(e.updateTime),s=e.createTime?se(e.createTime):V.min(),o=new ye({mapValue:{fields:e.fields}}),a=Z.newFoundDocument(r,i,s,o);return t&&a.setHasCommittedMutations(),t?a.setHasCommittedMutations():a}function Mr(n,e){let t;if(e instanceof An)t={update:Fh(n,e.key,e.value)};else if(e instanceof Rn)t={delete:Fr(n,e.key)};else if(e instanceof it)t={update:Fh(n,e.key,e.data),updateMask:Fp(e.fieldMask)};else{if(!(e instanceof Lo))return R();t={verify:Fr(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(s,o){const a=o.transform;if(a instanceof vn)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof Ut)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof Gt)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof wn)return{fieldPath:o.field.canonicalString(),increment:a.Ie};throw R()}(0,r))),e.precondition.isNone||(t.currentDocument=void 0!==(s=e.precondition).updateTime?{updateTime:Sp(n,s.updateTime)}:void 0!==s.exists?{exists:s.exists}:R()),t;var s}function $o(n,e){const t=e.currentDocument?void 0!==(s=e.currentDocument).updateTime?ee.updateTime(se(s.updateTime)):void 0!==s.exists?ee.exists(s.exists):ee.none():ee.none(),r=e.updateTransforms?e.updateTransforms.map(i=>function(o,a){let u=null;"setToServerValue"in a?(P("REQUEST_TIME"===a.setToServerValue),u=new vn):"appendMissingElements"in a?u=new Ut(a.appendMissingElements.values||[]):"removeAllFromArray"in a?u=new Gt(a.removeAllFromArray.values||[]):"increment"in a?u=new wn(o,a.increment):R();const c=H.fromServerFormat(a.fieldPath);return new Cr(c,u)}(n,i)):[];var s;if(e.update){const i=Ze(n,e.update.name),s=new ye({mapValue:{fields:e.update.fields}});if(e.updateMask){const o=new De((e.updateMask.fieldPaths||[]).map(l=>H.fromServerFormat(l)));return new it(i,s,o,t,r)}return new An(i,s,t,r)}if(e.delete){const i=Ze(n,e.delete);return new Rn(i,t)}if(e.verify){const i=Ze(n,e.verify);return new Lo(i,t)}return R()}function Oh(n,e){return{documents:[bh(n,e.path)]}}function Wo(n,e){const t={structuredQuery:{}},r=e.path;let i;null!==e.collectionGroup?(i=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=bh(n,i);const s=function(c){if(0!==c.length)return qh(z.create(c,"and"))}(e.filters);s&&(t.structuredQuery.where=s);const o=function(c){if(0!==c.length)return c.map(l=>{return{field:vt((d=l).field),direction:bp(d.dir)};var d})}(e.orderBy);o&&(t.structuredQuery.orderBy=o);const a=zo(n,e.limit);return null!==a&&(t.structuredQuery.limit=a),e.startAt&&(t.structuredQuery.startAt={before:(c=e.startAt).inclusive,values:c.position}),e.endAt&&(t.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(e.endAt)),{ut:t,parent:i};var c}function Lh(n){let e=Nh(n.parent);const t=n.structuredQuery,r=t.from?t.from.length:0;let i=null;if(r>0){P(1===r);const l=t.from[0];l.allDescendants?i=l.collectionId:e=e.child(l.collectionId)}let s=[];t.where&&(s=function(h){const d=Bh(h);return d instanceof z&&bo(d)?d.getFilters():[d]}(t.where));let o=[];t.orderBy&&(o=t.orderBy.map(d=>{return new Ar(Sn((I=d).field),function(T){switch(T){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(I.direction));var I}));let a=null;t.limit&&(a=function(h){let d;return d="object"==typeof h?h.value:h,yr(d)?null:d}(t.limit));let u=null;var h;t.startAt&&(u=new Et((h=t.startAt).values||[],!!h.before));let c=null;return t.endAt&&(c=function(h){return new Et(h.values||[],!h.before)}(t.endAt)),Jl(e,i,o,s,a,"F",u,c)}function Bh(n){return void 0!==n.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const r=Sn(t.unaryFilter.field);return O.create(r,"==",{doubleValue:NaN});case"IS_NULL":const i=Sn(t.unaryFilter.field);return O.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Sn(t.unaryFilter.field);return O.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const o=Sn(t.unaryFilter.field);return O.create(o,"!=",{nullValue:"NULL_VALUE"});default:return R()}}(n):void 0!==n.fieldFilter?O.create(Sn((t=n).fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return R()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==n.compositeFilter?function(t){return z.create(t.compositeFilter.filters.map(r=>Bh(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return R()}}(t.compositeFilter.op))}(n):R();var t}function bp(n){return wp[n]}function Np(n){return Ap[n]}function kp(n){return Rp[n]}function vt(n){return{fieldPath:n.canonicalString()}}function Sn(n){return H.fromServerFormat(n.fieldPath)}function qh(n){return n instanceof O?function(t){if("=="===t.op){if(Ml(t.value))return{unaryFilter:{field:vt(t.field),op:"IS_NAN"}};if(Fl(t.value))return{unaryFilter:{field:vt(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Ml(t.value))return{unaryFilter:{field:vt(t.field),op:"IS_NOT_NAN"}};if(Fl(t.value))return{unaryFilter:{field:vt(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:vt(t.field),op:Np(t.op),value:t.value}}}(n):n instanceof z?function(t){const r=t.getFilters().map(i=>qh(i));return 1===r.length?r[0]:{compositeFilter:{op:kp(t.op),filters:r}}}(n):R()}function Fp(n){const e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function Uh(n){return n.length>=4&&"projects"===n.get(0)&&"databases"===n.get(2)}class st{constructor(e,t,r,i,s=V.min(),o=V.min(),a=ce.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=u}withSequenceNumber(e){return new st(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new st(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new st(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new st(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Gh{constructor(e){this.ct=e}}function zh(n,e){const t=e.key,r={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:Hi(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document={name:Fr(s=n.ct,(o=e).key),fields:o.data.value.mapValue.fields,updateTime:Pn(s,o.version.toTimestamp()),createTime:Pn(s,o.createTime.toTimestamp())};else if(e.isNoDocument())r.noDocument={path:t.path.toArray(),readTime:zt(e.version)};else{if(!e.isUnknownDocument())return R();r.unknownDocument={path:t.path.toArray(),version:zt(e.version)}}var s,o;return r}function Hi(n){const e=n.toTimestamp();return[e.seconds,e.nanoseconds]}function zt(n){const e=n.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Kt(n){const e=new X(n.seconds,n.nanoseconds);return V.fromTimestamp(e)}function jt(n,e){const t=(e.baseMutations||[]).map(s=>$o(n.ct,s));for(let s=0;s<e.mutations.length-1;++s)s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform&&(e.mutations[s].updateTransforms=e.mutations[s+1].transform.fieldTransforms,e.mutations.splice(s+1,1),++s);const r=e.mutations.map(s=>$o(n.ct,s)),i=X.fromMillis(e.localWriteTimeMs);return new Bo(e.batchId,i,t,r)}function Or(n){const e=Kt(n.readTime),t=void 0!==n.lastLimboFreeSnapshotVersion?Kt(n.lastLimboFreeSnapshotVersion):V.min();let r;return r=void 0!==n.query.documents?(P(1===(s=n.query).documents.length),Pe(In(Nh(s.documents[0])))):function(s){return Pe(Lh(s))}(n.query),new st(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,e,t,ce.fromBase64String(n.resumeToken));var s}function Kh(n,e){const t=zt(e.snapshotVersion),r=zt(e.lastLimboFreeSnapshotVersion);let i;i=Ui(e.target)?Oh(n.ct,e.target):Wo(n.ct,e.target).ut;const s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:qt(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Ho(n){const e=Lh({parent:n.parent,structuredQuery:n.structuredQuery});return"LAST"===n.limitType?zi(e,e.limit,"L"):e}function Zo(n,e){return new Uo(e.largestBatchId,$o(n.ct,e.overlayMutation))}function jh(n,e){const t=e.path.lastSegment();return[n,ve(e.path.popLast()),t]}function Qh(n,e,t,r){return{indexId:n,uid:e,sequenceNumber:t,readTime:zt(r.readTime),documentKey:ve(r.documentKey.path),largestBatchId:r.largestBatchId}}class Op{getBundleMetadata(e,t){return $h(e).get(t).next(r=>{if(r)return{id:(s=r).bundleId,createTime:Kt(s.createTime),version:s.version};var s})}saveBundleMetadata(e,t){return $h(e).put({bundleId:(i=t).id,createTime:zt(se(i.createTime)),version:i.version});var i}getNamedQuery(e,t){return Wh(e).get(t).next(r=>{if(r)return{name:(s=r).name,query:Ho(s.bundledQuery),readTime:Kt(s.readTime)};var s})}saveNamedQuery(e,t){return Wh(e).put({name:(i=t).name,readTime:zt(se(i.readTime)),bundledQuery:i.bundledQuery});var i}}function $h(n){return fe(n,"bundles")}function Wh(n){return fe(n,"namedQueries")}class Zi{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){return new Zi(e,t.uid||"")}getOverlay(e,t){return Lr(e).get(jh(this.userId,t)).next(r=>r?Zo(this.serializer,r):null)}getOverlays(e,t){const r=He();return f.forEach(t,i=>this.getOverlay(e,i).next(s=>{null!==s&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){const i=[];return r.forEach((s,o)=>{const a=new Uo(t,o);i.push(this.ht(e,a))}),f.waitFor(i)}removeOverlaysForBatchId(e,t,r){const i=new Set;t.forEach(o=>i.add(ve(o.getCollectionPath())));const s=[];return i.forEach(o=>{const a=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(Lr(e).H("collectionPathOverlayIndex",a))}),f.waitFor(s)}getOverlaysForCollection(e,t,r){const i=He(),s=ve(t),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Lr(e).W("collectionPathOverlayIndex",o).next(a=>{for(const u of a){const c=Zo(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(e,t,r,i){const s=He();let o;const a=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Lr(e).Y({index:"collectionGroupOverlayIndex",range:a},(u,c,l)=>{const h=Zo(this.serializer,c);s.size()<i||h.largestBatchId===o?(s.set(h.getKey(),h),o=h.largestBatchId):l.done()}).next(()=>s)}ht(e,t){return Lr(e).put(function(i,s,o){const[a,u,c]=jh(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:Mr(i.ct,o.mutation)}}(this.serializer,this.userId,t))}}function Lr(n){return fe(n,"documentOverlays")}class Qt{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(ne(e.integerValue));else if("doubleValue"in e){const r=ne(e.doubleValue);isNaN(r)?this.Et(t,13):(this.Et(t,15),Ir(r)?t.dt(0):t.dt(r))}else if("timestampValue"in e){const r=e.timestampValue;this.Et(t,20),"string"==typeof r?t.At(r):(t.At(`${r.seconds||""}`),t.dt(r.nanos||0))}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(tt(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){const r=e.geoPointValue;this.Et(t,45),t.dt(r.latitude||0),t.dt(r.longitude||0)}else"mapValue"in e?Ol(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):R()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){const r=e.fields||{};this.Et(t,55);for(const i of Object.keys(r))this.Rt(i,t),this.It(r[i],t)}wt(e,t){const r=e.values||[];this.Et(t,50);for(const i of r)this.It(i,t)}gt(e,t){this.Et(t,37),w.fromName(e).path.forEach(r=>{this.Et(t,60),this.St(r,t)})}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}function Lp(n){if(0===n)return 8;let e=0;return!(n>>4)&&(e+=4,n<<=4),!(n>>6)&&(e+=2,n<<=2),!(n>>7)&&(e+=1),e}function Hh(n){const e=64-function(r){let i=0;for(let s=0;s<8;++s){const o=Lp(255&r[s]);if(i+=o,8!==o)break}return i}(n);return Math.ceil(e/8)}Qt.bt=new Qt;class Bp{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){const t=e[Symbol.iterator]();let r=t.next();for(;!r.done;)this.Ct(r.value),r=t.next();this.vt()}Ft(e){const t=e[Symbol.iterator]();let r=t.next();for(;!r.done;)this.Mt(r.value),r=t.next();this.xt()}Ot(e){for(const t of e){const r=t.charCodeAt(0);if(r<128)this.Ct(r);else if(r<2048)this.Ct(960|r>>>6),this.Ct(128|63&r);else if(t<"\ud800"||"\udbff"<t)this.Ct(480|r>>>12),this.Ct(128|63&r>>>6),this.Ct(128|63&r);else{const i=t.codePointAt(0);this.Ct(240|i>>>18),this.Ct(128|63&i>>>12),this.Ct(128|63&i>>>6),this.Ct(128|63&i)}}this.vt()}Nt(e){for(const t of e){const r=t.charCodeAt(0);if(r<128)this.Mt(r);else if(r<2048)this.Mt(960|r>>>6),this.Mt(128|63&r);else if(t<"\ud800"||"\udbff"<t)this.Mt(480|r>>>12),this.Mt(128|63&r>>>6),this.Mt(128|63&r);else{const i=t.codePointAt(0);this.Mt(240|i>>>18),this.Mt(128|63&i>>>12),this.Mt(128|63&i>>>6),this.Mt(128|63&i)}}this.xt()}Lt(e){const t=this.Bt(e),r=Hh(t);this.kt(1+r),this.buffer[this.position++]=255&r;for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=255&t[i]}qt(e){const t=this.Bt(e),r=Hh(t);this.kt(1+r),this.buffer[this.position++]=~(255&r);for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Bt(e){const t=function(s){const o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(e),r=0!=(128&t[0]);t[0]^=r?255:128;for(let i=1;i<t.length;++i)t[i]^=r?255:0;return t}Ct(e){const t=255&e;0===t?(this.Kt(0),this.Kt(255)):255===t?(this.Kt(255),this.Kt(0)):this.Kt(t)}Mt(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(e)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(e){const t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);const i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}}class qp{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Lt(e)}Tt(){this.Gt.Qt()}}class Up{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}}class Br{constructor(){this.Gt=new Bp,this.zt=new qp(this.Gt),this.jt=new Up(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return 0===e?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class $t{constructor(e,t,r,i){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=i}Jt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new $t(this.indexId,this.documentKey,this.arrayValue,r)}}function wt(n,e){let t=n.indexId-e.indexId;return 0!==t?t:(t=Zh(n.arrayValue,e.arrayValue),0!==t?t:(t=Zh(n.directionalValue,e.directionalValue),0!==t?t:w.comparator(n.documentKey,e.documentKey)))}function Zh(n,e){for(let t=0;t<n.length&&t<e.length;++t){const r=n[t]-e[t];if(0!==r)return r}return n.length-e.length}class Yh{constructor(e){this.Yt=new K((t,r)=>H.comparator(t.field,r.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Zt=e.orderBy,this.Xt=[];for(const t of e.filters){const r=t;r.isInequality()?this.Yt=this.Yt.add(r):this.Xt.push(r)}}get en(){return this.Yt.size>1}tn(e){if(P(e.collectionGroup===this.collectionId),this.en)return!1;const t=Ao(e);if(void 0!==t&&!this.nn(t))return!1;const r=Mt(e);let i=new Set,s=0,o=0;for(;s<r.length&&this.nn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Yt.size>0){const a=this.Yt.getIterator().getNext();if(!i.has(a.field.canonicalString())){const u=r[s];if(!this.rn(a,u)||!this.sn(this.Zt[o++],u))return!1}++s}for(;s<r.length;++s)if(o>=this.Zt.length||!this.sn(this.Zt[o++],r[s]))return!1;return!0}on(){if(this.en)return null;let e=new K(H.comparator);const t=[];for(const r of this.Xt)if(!r.field.isKeyField())if("array-contains"===r.op||"array-contains-any"===r.op)t.push(new Ot(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new Ot(r.field,0))}for(const r of this.Zt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new Ot(r.field,"asc"===r.dir?0:1)));return new mn(mn.UNKNOWN_ID,this.collectionId,t,gn.empty())}nn(e){for(const t of this.Xt)if(this.rn(t,e))return!0;return!1}rn(e,t){return!(void 0===e||!e.field.isEqual(t.fieldPath))&&2===t.kind==("array-contains"===e.op||"array-contains-any"===e.op)}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Jh(n){var e,t;if(P(n instanceof O||n instanceof z),n instanceof O){if(n instanceof Hl){const i=(null===(t=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===t?void 0:t.map(s=>O.create(n.field,"==",s)))||[];return z.create(i,"or")}return n}const r=n.filters.map(i=>Jh(i));return z.create(r,n.op)}function Gp(n){if(0===n.getFilters().length)return[];const e=Xo(Jh(n));return P(Xh(e)),Yo(e)||Jo(e)?[e]:e.getFilters()}function Yo(n){return n instanceof O}function Jo(n){return n instanceof z&&bo(n)}function Xh(n){return Yo(n)||Jo(n)||function(t){if(t instanceof z&&Do(t)){for(const r of t.getFilters())if(!Yo(r)&&!Jo(r))return!1;return!0}return!1}(n)}function Xo(n){if(P(n instanceof O||n instanceof z),n instanceof O)return n;if(1===n.filters.length)return Xo(n.filters[0]);const e=n.filters.map(r=>Xo(r));let t=z.create(e,n.op);return t=Yi(t),Xh(t)?t:(P(t instanceof z),P(yn(t)),P(t.filters.length>1),t.filters.reduce((r,i)=>ea(r,i)))}function ea(n,e){let t;return P(n instanceof O||n instanceof z),P(e instanceof O||e instanceof z),t=n instanceof O?e instanceof O?z.create([n,e],"and"):ed(n,e):e instanceof O?ed(e,n):function(i,s){if(P(i.filters.length>0&&s.filters.length>0),yn(i)&&yn(s))return Ql(i,s.getFilters());const o=Do(i)?i:s,a=Do(i)?s:i,u=o.filters.map(c=>ea(c,a));return z.create(u,"or")}(n,e),Yi(t)}function ed(n,e){if(yn(e))return Ql(e,n.getFilters());{const t=e.filters.map(r=>ea(n,r));return z.create(t,"or")}}function Yi(n){if(P(n instanceof O||n instanceof z),n instanceof O)return n;const e=n.getFilters();if(1===e.length)return Yi(e[0]);if(Kl(n))return n;const t=e.map(i=>Yi(i)),r=[];return t.forEach(i=>{i instanceof O?r.push(i):i instanceof z&&(i.op===n.op?r.push(...i.filters):r.push(i))}),1===r.length?r[0]:z.create(r,n.op)}class zp{constructor(){this._n=new ta}addToCollectionParentIndex(e,t){return this._n.add(t),f.resolve()}getCollectionParents(e,t){return f.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return f.resolve()}deleteFieldIndex(e,t){return f.resolve()}deleteAllFieldIndexes(e){return f.resolve()}createTargetIndexes(e,t){return f.resolve()}getDocumentsMatchingTarget(e,t){return f.resolve(null)}getIndexType(e,t){return f.resolve(0)}getFieldIndexes(e,t){return f.resolve([])}getNextCollectionGroupToUpdate(e){return f.resolve(null)}getMinOffset(e,t){return f.resolve(ke.min())}getMinOffsetFromCollectionGroup(e,t){return f.resolve(ke.min())}updateCollectionGroup(e,t,r){return f.resolve()}updateIndexEntries(e,t){return f.resolve()}}class ta{constructor(){this.index={}}add(e){const t=e.lastSegment(),r=e.popLast(),i=this.index[t]||new K(M.comparator),s=!i.has(r);return this.index[t]=i.add(r),s}has(e){const t=e.lastSegment(),r=e.popLast(),i=this.index[t];return i&&i.has(r)}getEntries(e){return(this.index[e]||new K(M.comparator)).toArray()}}const Ji=new Uint8Array(0);class Kp{constructor(e,t){this.databaseId=t,this.an=new ta,this.un=new rt(r=>qt(r),(r,i)=>Rr(r,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.an.has(t)){const r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.an.add(t)});const s={collectionId:r,parent:ve(i)};return td(e).put(s)}return f.resolve()}getCollectionParents(e,t){const r=[],i=IDBKeyRange.bound([t,""],[_l(t),""],!1,!0);return td(e).W(i).next(s=>{for(const o of s){if(o.collectionId!==t)break;r.push($e(o.parent))}return r})}addFieldIndex(e,t){const r=qr(e),i={indexId:(a=t).indexId,collectionGroup:a.collectionGroup,fields:a.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])};var a;delete i.indexId;const s=r.add(i);if(t.indexState){const o=xn(e);return s.next(a=>{o.put(Qh(a,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const r=qr(e),i=xn(e),s=Vn(e);return r.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=qr(e),r=Vn(e),i=xn(e);return t.H().next(()=>r.H()).next(()=>i.H())}createTargetIndexes(e,t){return f.forEach(this.cn(t),r=>this.getIndexType(e,r).next(i=>{if(0===i||1===i){const s=new Yh(r).on();if(null!=s)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){const r=Vn(e);let i=!0;const s=new Map;return f.forEach(this.cn(t),o=>this.ln(e,o).next(a=>{i&&(i=!!a),s.set(o,a)})).next(()=>{if(i){let o=k();const a=[];return f.forEach(s,(u,c)=>{var S;y("IndexedDbIndexManager",`Using index ${S=u,`id=${S.indexId}|cg=${S.collectionGroup}|f=${S.fields.map(N=>`${N.fieldPath}:${N.kind}`).join(",")}`} to execute ${qt(t)}`);const l=function(S,N){const B=Ao(N);if(void 0===B)return null;for(const U of Gi(S,B.fieldPath))switch(U.op){case"array-contains-any":return U.value.arrayValue.values||[];case"array-contains":return[U.value]}return null}(c,u),h=function(S,N){const B=new Map;for(const U of Mt(N))for(const oe of Gi(S,U.fieldPath))switch(oe.op){case"==":case"in":B.set(U.fieldPath.canonicalString(),oe.value);break;case"not-in":case"!=":return B.set(U.fieldPath.canonicalString(),oe.value),Array.from(B.values())}return null}(c,u),d=function(S,N){const B=[];let U=!0;for(const oe of Mt(N)){const Be=0===oe.kind?Zl(S,oe.fieldPath,S.startAt):Yl(S,oe.fieldPath,S.startAt);B.push(Be.value),U&&(U=Be.inclusive)}return new Et(B,U)}(c,u),m=function(S,N){const B=[];let U=!0;for(const oe of Mt(N)){const Be=0===oe.kind?Yl(S,oe.fieldPath,S.endAt):Zl(S,oe.fieldPath,S.endAt);B.push(Be.value),U&&(U=Be.inclusive)}return new Et(B,U)}(c,u),I=this.hn(u,c,d),E=this.hn(u,c,m),T=this.Pn(u,c,h),x=this.In(u.indexId,l,I,d.inclusive,E,m.inclusive,T);return f.forEach(x,b=>r.j(b,t.limit).next(S=>{S.forEach(N=>{const B=w.fromSegments(N.documentKey);o.has(B)||(o=o.add(B),a.push(B))})}))}).next(()=>a)}return f.resolve(null)})}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:Gp(z.create(e.filters,"and")).map(r=>ko(e.path,e.collectionGroup,e.orderBy,r.getFilters(),e.limit,e.startAt,e.endAt)),this.un.set(e,t),t)}In(e,t,r,i,s,o,a){const u=(null!=t?t.length:1)*Math.max(r.length,s.length),c=u/(null!=t?t.length:1),l=[];for(let h=0;h<u;++h){const d=t?this.Tn(t[h/c]):Ji,m=this.En(e,d,r[h%c],i),I=this.dn(e,d,s[h%c],o),E=a.map(T=>this.En(e,d,T,!0));l.push(...this.createRange(m,I,E))}return l}En(e,t,r,i){const s=new $t(e,w.empty(),t,r);return i?s:s.Jt()}dn(e,t,r,i){const s=new $t(e,w.empty(),t,r);return i?s.Jt():s}ln(e,t){const r=new Yh(t),i=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let o=null;for(const a of s)r.tn(a)&&(!o||a.fields.length>o.fields.length)&&(o=a);return o})}getIndexType(e,t){let r=2;const i=this.cn(t);return f.forEach(i,s=>this.ln(e,s).next(o=>{o?0!==r&&o.fields.length<function(u){let c=new K(H.comparator),l=!1;for(const h of u.filters)for(const d of h.getFlattenedFilters())d.field.isKeyField()||("array-contains"===d.op||"array-contains-any"===d.op?l=!0:c=c.add(d.field));for(const h of u.orderBy)h.field.isKeyField()||(c=c.add(h.field));return c.size+(l?1:0)}(s)&&(r=1):r=0})).next(()=>null!==t.limit&&i.length>1&&2===r?1:r)}An(e,t){const r=new Br;for(const i of Mt(e)){const s=t.data.field(i.fieldPath);if(null==s)return null;const o=r.Ht(i.kind);Qt.bt.Pt(s,o)}return r.Wt()}Tn(e){const t=new Br;return Qt.bt.Pt(e,t.Ht(0)),t.Wt()}Rn(e,t){const r=new Br;return Qt.bt.Pt(Bt(this.databaseId,t),r.Ht(function(s){const o=Mt(s);return 0===o.length?0:o[o.length-1].kind}(e))),r.Wt()}Pn(e,t,r){if(null===r)return[];let i=[];i.push(new Br);let s=0;for(const o of Mt(e)){const a=r[s++];for(const u of i)if(this.Vn(t,o.fieldPath)&&vr(a))i=this.mn(i,o,a);else{const c=u.Ht(o.kind);Qt.bt.Pt(a,c)}}return this.fn(i)}hn(e,t,r){return this.Pn(e,t,r.position)}fn(e){const t=[];for(let r=0;r<e.length;++r)t[r]=e[r].Wt();return t}mn(e,t,r){const i=[...e],s=[];for(const o of r.arrayValue.values||[])for(const a of i){const u=new Br;u.seed(a.Wt()),Qt.bt.Pt(o,u.Ht(t.kind)),s.push(u)}return s}Vn(e,t){return!!e.filters.find(r=>r instanceof O&&r.field.isEqual(t)&&("in"===r.op||"not-in"===r.op))}getFieldIndexes(e,t){const r=qr(e),i=xn(e);return(t?r.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.W()).next(s=>{const o=[];return f.forEach(s,a=>i.get([a.indexId,this.uid]).next(u=>{o.push(function(l,h){const d=h?new gn(h.sequenceNumber,new ke(Kt(h.readTime),new w($e(h.documentKey)),h.largestBatchId)):gn.empty(),m=l.fields.map(([I,E])=>new Ot(H.fromServerFormat(I),E));return new mn(l.indexId,l.collectionGroup,m,d)}(a,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>0===t.length?null:(t.sort((r,i)=>{const s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return 0!==s?s:C(r.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,r){const i=qr(e),s=xn(e);return this.gn(e).next(o=>i.W("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(a=>f.forEach(a,u=>s.put(Qh(u.indexId,this.uid,o,r)))))}updateIndexEntries(e,t){const r=new Map;return f.forEach(t,(i,s)=>{const o=r.get(i.collectionGroup);return(o?f.resolve(o):this.getFieldIndexes(e,i.collectionGroup)).next(a=>(r.set(i.collectionGroup,a),f.forEach(a,u=>this.pn(e,i,u).next(c=>{const l=this.yn(s,u);return c.isEqual(l)?f.resolve():this.wn(e,s,u,c,l)}))))})}Sn(e,t,r,i){return Vn(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.Rn(r,t.key),documentKey:t.key.path.toArray()})}bn(e,t,r,i){return Vn(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.Rn(r,t.key),t.key.path.toArray()])}pn(e,t,r){const i=Vn(e);let s=new K(wt);return i.Y({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.Rn(r,t)])},(o,a)=>{s=s.add(new $t(r.indexId,t,a.arrayValue,a.directionalValue))}).next(()=>s)}yn(e,t){let r=new K(wt);const i=this.An(t,e);if(null==i)return r;const s=Ao(t);if(null!=s){const o=e.data.field(s.fieldPath);if(vr(o))for(const a of o.arrayValue.values||[])r=r.add(new $t(t.indexId,e.key,this.Tn(a),i))}else r=r.add(new $t(t.indexId,e.key,Ji,i));return r}wn(e,t,r,i,s){y("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const o=[];return function(u,c,l,h,d){const m=u.getIterator(),I=c.getIterator();let E=pn(m),T=pn(I);for(;E||T;){let x=!1,b=!1;if(E&&T){const S=l(E,T);S<0?b=!0:S>0&&(x=!0)}else null!=E?b=!0:x=!0;x?(h(T),T=pn(I)):b?(d(E),E=pn(m)):(E=pn(m),T=pn(I))}}(i,s,wt,a=>{o.push(this.Sn(e,t,r,a))},a=>{o.push(this.bn(e,t,r,a))}),f.waitFor(o)}gn(e){let t=1;return xn(e).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((o,a)=>wt(o,a)).filter((o,a,u)=>!a||0!==wt(o,u[a-1]));const i=[];i.push(e);for(const o of r){const a=wt(o,e),u=wt(o,t);if(0===a)i[0]=e.Jt();else if(a>0&&u<0)i.push(o),i.push(o.Jt());else if(u>0)break}i.push(t);const s=[];for(let o=0;o<i.length;o+=2){if(this.Dn(i[o],i[o+1]))return[];s.push(IDBKeyRange.bound([i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,Ji,[]],[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,Ji,[]]))}return s}Dn(e,t){return wt(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(nd)}getMinOffset(e,t){return f.mapArray(this.cn(t),r=>this.ln(e,r).next(i=>i||R())).next(nd)}}function td(n){return fe(n,"collectionParents")}function Vn(n){return fe(n,"indexEntries")}function qr(n){return fe(n,"indexConfiguration")}function xn(n){return fe(n,"indexState")}function nd(n){P(0!==n.length);let e=n[0].indexState.offset,t=e.largestBatchId;for(let r=1;r<n.length;r++){const i=n[r].indexState.offset;Ro(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new ke(e.readTime,e.documentKey,t)}const rd={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class we{constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}static withCacheSize(e){return new we(e,we.DEFAULT_COLLECTION_PERCENTILE,we.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function id(n,e,t){const r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(t.batchId);let a=0;const u=r.Y({range:o},(l,h,d)=>(a++,d.delete()));s.push(u.next(()=>{P(1===a)}));const c=[];for(const l of t.mutations){const h=Pl(e,l.key.path,t.batchId);s.push(i.delete(h)),c.push(l.key)}return f.waitFor(s).next(()=>c)}function Xi(n){if(!n)return 0;let e;if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw R();e=n.noDocument}return JSON.stringify(e).length}we.DEFAULT_COLLECTION_PERCENTILE=10,we.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,we.DEFAULT=new we(41943040,we.DEFAULT_COLLECTION_PERCENTILE,we.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),we.DISABLED=new we(-1,0,0);class es{constructor(e,t,r,i){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=i,this.Cn={}}static lt(e,t,r,i){P(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new es(s,t,r,i)}checkEmpty(e){let t=!0;const r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return At(e).Y({index:"userMutationsIndex",range:r},(i,s,o)=>{t=!1,o.done()}).next(()=>t)}addMutationBatch(e,t,r,i){const s=Cn(e),o=At(e);return o.add({}).next(a=>{P("number"==typeof a);const u=new Bo(a,t,r,i),c=function(m,I,E){const T=E.baseMutations.map(b=>Mr(m.ct,b)),x=E.mutations.map(b=>Mr(m.ct,b));return{userId:I,batchId:E.batchId,localWriteTimeMs:E.localWriteTime.toMillis(),baseMutations:T,mutations:x}}(this.serializer,this.userId,u),l=[];let h=new K((d,m)=>C(d.canonicalString(),m.canonicalString()));for(const d of i){const m=Pl(this.userId,d.key.path,a);h=h.add(d.key.path.popLast()),l.push(o.put(c)),l.push(s.put(m,bg))}return h.forEach(d=>{l.push(this.indexManager.addToCollectionParentIndex(e,d))}),e.addOnCommittedListener(()=>{this.Cn[a]=u.keys()}),f.waitFor(l).next(()=>u)})}lookupMutationBatch(e,t){return At(e).get(t).next(r=>r?(P(r.userId===this.userId),jt(this.serializer,r)):null)}vn(e,t){return this.Cn[t]?f.resolve(this.Cn[t]):this.lookupMutationBatch(e,t).next(r=>{if(r){const i=r.keys();return this.Cn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return At(e).Y({index:"userMutationsIndex",range:i},(o,a,u)=>{a.userId===this.userId&&(P(a.batchId>=r),s=jt(this.serializer,a)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return At(e).Y({index:"userMutationsIndex",range:t,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return At(e).W("userMutationsIndex",t).next(r=>r.map(i=>jt(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){const r=ki(this.userId,t.path),i=IDBKeyRange.lowerBound(r),s=[];return Cn(e).Y({range:i},(o,a,u)=>{const[c,l,h]=o,d=$e(l);if(c===this.userId&&t.path.isEqual(d))return At(e).get(h).next(m=>{if(!m)throw R();P(m.userId===this.userId),s.push(jt(this.serializer,m))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new K(C);const i=[];return t.forEach(s=>{const o=ki(this.userId,s.path),a=IDBKeyRange.lowerBound(o),u=Cn(e).Y({range:a},(c,l,h)=>{const[d,m,I]=c,E=$e(m);d===this.userId&&s.path.isEqual(E)?r=r.add(I):h.done()});i.push(u)}),f.waitFor(i).next(()=>this.Fn(e,r))}getAllMutationBatchesAffectingQuery(e,t){const r=t.path,i=r.length+1,s=ki(this.userId,r),o=IDBKeyRange.lowerBound(s);let a=new K(C);return Cn(e).Y({range:o},(u,c,l)=>{const[h,d,m]=u,I=$e(d);h===this.userId&&r.isPrefixOf(I)?I.length===i&&(a=a.add(m)):l.done()}).next(()=>this.Fn(e,a))}Fn(e,t){const r=[],i=[];return t.forEach(s=>{i.push(At(e).get(s).next(o=>{if(null===o)throw R();P(o.userId===this.userId),r.push(jt(this.serializer,o))}))}),f.waitFor(i).next(()=>r)}removeMutationBatch(e,t){return id(e.ae,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.Mn(t.batchId)}),f.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}Mn(e){delete this.Cn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return f.resolve();const r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return Cn(e).Y({range:r},(s,o,a)=>{if(s[0]===this.userId){const u=$e(s[1]);i.push(u)}else a.done()}).next(()=>{P(0===i.length)})})}containsKey(e,t){return sd(e,this.userId,t)}xn(e){return od(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sd(n,e,t){const r=ki(e,t.path),i=r[1],s=IDBKeyRange.lowerBound(r);let o=!1;return Cn(n).Y({range:s,J:!0},(a,u,c)=>{const[l,h,d]=a;l===e&&h===i&&(o=!0),c.done()}).next(()=>o)}function At(n){return fe(n,"mutations")}function Cn(n){return fe(n,"documentMutations")}function od(n){return fe(n,"mutationQueues")}class Wt{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new Wt(0)}static Ln(){return new Wt(-1)}}class jp{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Bn(e).next(t=>{const r=new Wt(t.highestTargetId);return t.highestTargetId=r.next(),this.kn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Bn(e).next(t=>V.fromTimestamp(new X(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Bn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.Bn(e).next(i=>(i.highestListenSequenceNumber=t,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.kn(e,i)))}addTargetData(e,t){return this.qn(e,t).next(()=>this.Bn(e).next(r=>(r.targetCount+=1,this.Qn(t,r),this.kn(e,r))))}updateTargetData(e,t){return this.qn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Dn(e).delete(t.targetId)).next(()=>this.Bn(e)).next(r=>(P(r.targetCount>0),r.targetCount-=1,this.kn(e,r)))}removeTargets(e,t,r){let i=0;const s=[];return Dn(e).Y((o,a)=>{const u=Or(a);u.sequenceNumber<=t&&null===r.get(u.targetId)&&(i++,s.push(this.removeTargetData(e,u)))}).next(()=>f.waitFor(s)).next(()=>i)}forEachTarget(e,t){return Dn(e).Y((r,i)=>{const s=Or(i);t(s)})}Bn(e){return ad(e).get("targetGlobalKey").next(t=>(P(null!==t),t))}kn(e,t){return ad(e).put("targetGlobalKey",t)}qn(e,t){return Dn(e).put(Kh(this.serializer,t))}Qn(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.Bn(e).next(t=>t.targetCount)}getTargetData(e,t){const r=qt(t),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]);let s=null;return Dn(e).Y({range:i,index:"queryTargetsIndex"},(o,a,u)=>{const c=Or(a);Rr(t,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(e,t,r){const i=[],s=Rt(e);return t.forEach(o=>{const a=ve(o.path);i.push(s.put({targetId:r,path:a})),i.push(this.referenceDelegate.addReference(e,r,o))}),f.waitFor(i)}removeMatchingKeys(e,t,r){const i=Rt(e);return f.forEach(t,s=>{const o=ve(s.path);return f.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(e,r,s)])})}removeMatchingKeysForTargetId(e,t){const r=Rt(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(e,t){const r=IDBKeyRange.bound([t],[t+1],!1,!0),i=Rt(e);let s=k();return i.Y({range:r,J:!0},(o,a,u)=>{const c=$e(o[1]),l=new w(c);s=s.add(l)}).next(()=>s)}containsKey(e,t){const r=ve(t.path),i=IDBKeyRange.bound([r],[_l(r)],!1,!0);let s=0;return Rt(e).Y({index:"documentTargetsIndex",J:!0,range:i},([o,a],u,c)=>{0!==o&&(s++,c.done())}).next(()=>s>0)}_t(e,t){return Dn(e).get(t).next(r=>r?Or(r):null)}}function Dn(n){return fe(n,"targets")}function ad(n){return fe(n,"targetGlobal")}function Rt(n){return fe(n,"targetDocuments")}function ud([n,e],[t,r]){const i=C(n,t);return 0===i?C(e,r):i}class Qp{constructor(e){this.Kn=e,this.buffer=new K(ud),this.$n=0}Un(){return++this.$n}Wn(e){const t=[e,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(t);else{const r=this.buffer.last();ud(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}}class cd{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(e){var t=this;y("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(0,p.Z)(function*(){t.Gn=null;try{yield t.localStore.collectGarbage(t.garbageCollector)}catch(r){mt(r)?y("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",r):yield ft(r)}yield t.zn(3e5)}))}}class $p{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.Hn(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(0===t)return f.resolve(Fe._e);const r=new Qp(t);return this.jn.forEachTarget(e,i=>r.Wn(i.sequenceNumber)).next(()=>this.jn.Jn(e,i=>r.Wn(i))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.jn.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(y("LruGarbageCollector","Garbage collection skipped; disabled"),f.resolve(rd)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(y("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),rd):this.Yn(e,t))}getCacheSize(e){return this.jn.getCacheSize(e)}Yn(e,t){let r,i,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(h=>(h>this.params.maximumSequenceNumbersToCollect?(y("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${h}`),i=this.params.maximumSequenceNumbersToCollect):i=h,o=Date.now(),this.nthSequenceNumber(e,i))).next(h=>(r=h,a=Date.now(),this.removeTargets(e,r,t))).next(h=>(s=h,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(h=>(c=Date.now(),dn()<=ze.in.DEBUG&&y("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${i} in `+(a-o)+`ms\n\tRemoved ${s} targets in `+(u-a)+`ms\n\tRemoved ${h} documents in `+(c-u)+`ms\nTotal Duration: ${c-l}ms`),f.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:h})))}}class Wp{constructor(e,t){this.db=e,this.garbageCollector=function ld(n,e){return new $p(n,e)}(this,t)}Hn(e){const t=this.Zn(e);return this.db.getTargetCache().getTargetCount(e).next(r=>t.next(i=>r+i))}Zn(e){let t=0;return this.Jn(e,r=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Jn(e,t){return this.Xn(e,(r,i)=>t(i))}addReference(e,t,r){return ts(e,r)}removeReference(e,t,r){return ts(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return ts(e,t)}er(e,t){return function(i,s){let o=!1;return od(i).Z(a=>sd(i,a,s).next(u=>(u&&(o=!0),f.resolve(!u)))).next(()=>o)}(e,t)}removeOrphanedDocuments(e,t){const r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let s=0;return this.Xn(e,(o,a)=>{if(a<=t){const u=this.er(e,o).next(c=>{if(!c)return s++,r.getEntry(e,o).next(()=>(r.removeEntry(o,V.min()),Rt(e).delete([0,ve(o.path)])))});i.push(u)}}).next(()=>f.waitFor(i)).next(()=>r.apply(e)).next(()=>s)}removeTarget(e,t){const r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return ts(e,t)}Xn(e,t){const r=Rt(e);let i,s=Fe._e;return r.Y({index:"documentTargetsIndex"},([o,a],{path:u,sequenceNumber:c})=>{0===o?(s!==Fe._e&&t(new w($e(i)),s),s=c,i=u):s=Fe._e}).next(()=>{s!==Fe._e&&t(new w($e(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function ts(n,e){return Rt(n).put((i=n.currentSequenceNumber,{targetId:0,path:ve(e.path),sequenceNumber:i}));var i}class hd{constructor(){this.changes=new rt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Z.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const r=this.changes.get(t);return void 0!==r?f.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Hp{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return Ht(e).put(r)}removeEntry(e,t,r){return Ht(e).delete(function(s,o){const a=s.path.toArray();return[a.slice(0,a.length-2),a[a.length-2],Hi(o),a[a.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.tr(e,r)))}getEntry(e,t){let r=Z.newInvalidDocument(t);return Ht(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Ur(t))},(i,s)=>{r=this.nr(t,s)}).next(()=>r)}rr(e,t){let r={size:0,document:Z.newInvalidDocument(t)};return Ht(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Ur(t))},(i,s)=>{r={document:this.nr(t,s),size:Xi(s)}}).next(()=>r)}getEntries(e,t){let r=be();return this.ir(e,t,(i,s)=>{const o=this.nr(i,s);r=r.insert(i,o)}).next(()=>r)}sr(e,t){let r=be(),i=new Q(w.comparator);return this.ir(e,t,(s,o)=>{const a=this.nr(s,o);r=r.insert(s,a),i=i.insert(s,Xi(o))}).next(()=>({documents:r,_r:i}))}ir(e,t,r){if(t.isEmpty())return f.resolve();let i=new K(gd);t.forEach(u=>i=i.add(u));const s=IDBKeyRange.bound(Ur(i.first()),Ur(i.last())),o=i.getIterator();let a=o.getNext();return Ht(e).Y({index:"documentKeyIndex",range:s},(u,c,l)=>{const h=w.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;a&&gd(a,h)<0;)r(a,null),a=o.getNext();a&&a.isEqual(h)&&(r(a,c),a=o.hasNext()?o.getNext():null),a?l.U(Ur(a)):l.done()}).next(()=>{for(;a;)r(a,null),a=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(e,t,r,i,s){const o=t.path,a=[o.popLast().toArray(),o.lastSegment(),Hi(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Ht(e).W(IDBKeyRange.bound(a,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let l=be();for(const h of c){const d=this.nr(w.fromSegments(h.prefixPath.concat(h.collectionGroup,h.documentId)),h);d.isFoundDocument()&&(Sr(t,d)||i.has(d.key))&&(l=l.insert(d.key,d))}return l})}getAllFromCollectionGroup(e,t,r,i){let s=be();const o=md(t,r),a=md(t,ke.max());return Ht(e).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,a,!0)},(u,c,l)=>{const h=this.nr(w.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(h.key,h),s.size===i&&l.done()}).next(()=>s)}newChangeBuffer(e){return new Zp(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return fd(e).get("remoteDocumentGlobalKey").next(t=>(P(!!t),t))}tr(e,t){return fd(e).put("remoteDocumentGlobalKey",t)}nr(e,t){if(t){const r=function Mp(n,e){let t;if(e.document)t=Mh(n.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const r=w.fromSegments(e.noDocument.path),i=Kt(e.noDocument.readTime);t=Z.newNoDocument(r,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return R();{const r=w.fromSegments(e.unknownDocument.path),i=Kt(e.unknownDocument.version);t=Z.newUnknownDocument(r,i)}}return e.readTime&&t.setReadTime(function(i){const s=new X(i[0],i[1]);return V.fromTimestamp(s)}(e.readTime)),t}(this.serializer,t);if(!r.isNoDocument()||!r.version.isEqual(V.min()))return r}return Z.newInvalidDocument(e)}}function dd(n){return new Hp(n)}class Zp extends hd{constructor(e,t){super(),this.ar=e,this.trackRemovals=t,this.ur=new rt(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(e){const t=[];let r=0,i=new K((s,o)=>C(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{const a=this.ur.get(s);if(t.push(this.ar.removeEntry(e,s,a.readTime)),o.isValidDocument()){const u=zh(this.ar.serializer,o);i=i.add(s.path.popLast());const c=Xi(u);r+=c-a.size,t.push(this.ar.addEntry(e,s,u))}else if(r-=a.size,this.trackRemovals){const u=zh(this.ar.serializer,o.convertToNoDocument(V.min()));t.push(this.ar.addEntry(e,s,u))}}),i.forEach(s=>{t.push(this.ar.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.ar.updateMetadata(e,r)),f.waitFor(t)}getFromCache(e,t){return this.ar.rr(e,t).next(r=>(this.ur.set(t,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(e,t){return this.ar.sr(e,t).next(({documents:r,_r:i})=>(i.forEach((s,o)=>{this.ur.set(s,{size:o,readTime:r.get(s).readTime})}),r))}}function fd(n){return fe(n,"remoteDocumentGlobal")}function Ht(n){return fe(n,"remoteDocumentsV14")}function Ur(n){const e=n.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function md(n,e){const t=e.documentKey.path.toArray();return[n,Hi(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function gd(n,e){const t=n.path.toArray(),r=e.path.toArray();let i=0;for(let s=0;s<t.length-2&&s<r.length-2;++s)if(i=C(t[s],r[s]),i)return i;return i=C(t.length,r.length),i||(i=C(t[t.length-2],r[r.length-2]),i||C(t[t.length-1],r[r.length-1]))}class Yp{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class pd{constructor(e,t,r,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=i}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(r=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(null!==r&&Dr(r.mutation,i,De.empty(),X.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,k()).next(()=>r))}getLocalViewOfDocuments(e,t,r=k()){const i=He();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,r).next(s=>{let o=Vr();return s.forEach((a,u)=>{o=o.insert(a,u.overlayedDocument)}),o}))}getOverlayedDocuments(e,t){const r=He();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,k()))}populateOverlays(e,t,r){const i=[];return r.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((o,a)=>{t.set(o,a)})})}computeViews(e,t,r,i){let s=be();const o=xr(),a=xr();return t.forEach((u,c)=>{const l=r.get(c.key);i.has(c.key)&&(void 0===l||l.mutation instanceof it)?s=s.insert(c.key,c):void 0!==l?(o.set(c.key,l.mutation.getFieldMask()),Dr(l.mutation,c,l.mutation.getFieldMask(),X.now())):o.set(c.key,De.empty())}),this.recalculateAndSaveOverlays(e,s).next(u=>(u.forEach((c,l)=>o.set(c,l)),t.forEach((c,l)=>{var h;return a.set(c,new Yp(l,null!==(h=o.get(c))&&void 0!==h?h:null))}),a))}recalculateAndSaveOverlays(e,t){const r=xr();let i=new Q((o,a)=>o-a),s=k();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(o=>{for(const a of o)a.keys().forEach(u=>{const c=t.get(u);if(null===c)return;let l=r.get(u)||De.empty();l=a.applyToLocalView(c,l),r.set(u,l);const h=(i.get(a.batchId)||k()).add(u);i=i.insert(a.batchId,h)})}).next(()=>{const o=[],a=i.getReverseIterator();for(;a.hasNext();){const u=a.getNext(),c=u.key,l=u.value,h=oh();l.forEach(d=>{if(!s.has(d)){const m=gh(t.get(d),r.get(d));null!==m&&h.set(d,m),s=s.add(d)}}),o.push(this.documentOverlayCache.saveOverlays(e,c,h))}return f.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,i){return w.isDocumentKey((o=t).path)&&null===o.collectionGroup&&0===o.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Fo(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,i):this.getDocumentsMatchingCollectionQuery(e,t,r,i);var o}getNextDocuments(e,t,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,i).next(s=>{const o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,i-s.size):f.resolve(He());let a=-1,u=s;return o.next(c=>f.forEach(c,(l,h)=>(a<h.largestBatchId&&(a=h.largestBatchId),s.get(l)?f.resolve():this.remoteDocumentCache.getEntry(e,l).next(d=>{u=u.insert(l,d)}))).next(()=>this.populateOverlays(e,c,s)).next(()=>this.computeViews(e,u,c,k())).next(l=>({batchId:a,changes:sh(l)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new w(t)).next(r=>{let i=Vr();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,r,i){const s=t.collectionGroup;let o=Vr();return this.indexManager.getCollectionParents(e,s).next(a=>f.forEach(a,u=>{const c=(h=t,d=u.child(s),new nt(d,null,h.explicitOrderBy.slice(),h.filters.slice(),h.limit,h.limitType,h.startAt,h.endAt));var h,d;return this.getDocumentsMatchingCollectionQuery(e,c,r,i).next(l=>{l.forEach((h,d)=>{o=o.insert(h,d)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(e,t,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,s,i))).next(o=>{s.forEach((u,c)=>{const l=c.getKey();null===o.get(l)&&(o=o.insert(l,Z.newInvalidDocument(l)))});let a=Vr();return o.forEach((u,c)=>{const l=s.get(u);void 0!==l&&Dr(l.mutation,c,De.empty(),X.now()),Sr(t,c)&&(a=a.insert(u,c))}),a})}}class Jp{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return f.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,{id:(i=t).id,version:i.version,createTime:se(i.createTime)}),f.resolve();var i}getNamedQuery(e,t){return f.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,{name:(i=t).name,query:Ho(i.bundledQuery),readTime:se(i.readTime)}),f.resolve();var i}}class Xp{constructor(){this.overlays=new Q(w.comparator),this.hr=new Map}getOverlay(e,t){return f.resolve(this.overlays.get(t))}getOverlays(e,t){const r=He();return f.forEach(t,i=>this.getOverlay(e,i).next(s=>{null!==s&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((i,s)=>{this.ht(e,t,s)}),f.resolve()}removeOverlaysForBatchId(e,t,r){const i=this.hr.get(r);return void 0!==i&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.hr.delete(r)),f.resolve()}getOverlaysForCollection(e,t,r){const i=He(),s=t.length+1,o=new w(t.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){const u=a.getNext().value,c=u.getKey();if(!t.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return f.resolve(i)}getOverlaysForCollectionGroup(e,t,r,i){let s=new Q((c,l)=>c-l);const o=this.overlays.getIterator();for(;o.hasNext();){const c=o.getNext().value;if(c.getKey().getCollectionGroup()===t&&c.largestBatchId>r){let l=s.get(c.largestBatchId);null===l&&(l=He(),s=s.insert(c.largestBatchId,l)),l.set(c.getKey(),c)}}const a=He(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,l)=>a.set(c,l)),!(a.size()>=i)););return f.resolve(a)}ht(e,t,r){const i=this.overlays.get(r.key);if(null!==i){const o=this.hr.get(i.largestBatchId).delete(r.key);this.hr.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new Uo(t,r));let s=this.hr.get(t);void 0===s&&(s=k(),this.hr.set(t,s)),this.hr.set(t,s.add(r.key))}}class na{constructor(){this.Pr=new K(me.Ir),this.Tr=new K(me.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){const r=new me(e,t);this.Pr=this.Pr.add(r),this.Tr=this.Tr.add(r)}dr(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Ar(new me(e,t))}Rr(e,t){e.forEach(r=>this.removeReference(r,t))}Vr(e){const t=new w(new M([])),r=new me(t,e),i=new me(t,e+1),s=[];return this.Tr.forEachInRange([r,i],o=>{this.Ar(o),s.push(o.key)}),s}mr(){this.Pr.forEach(e=>this.Ar(e))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){const t=new w(new M([])),r=new me(t,e),i=new me(t,e+1);let s=k();return this.Tr.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(e){const t=new me(e,0),r=this.Pr.firstAfterOrEqual(t);return null!==r&&e.isEqual(r.key)}}class me{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return w.comparator(e.key,t.key)||C(e.pr,t.pr)}static Er(e,t){return C(e.pr,t.pr)||w.comparator(e.key,t.key)}}class e_{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new K(me.Ir)}checkEmpty(e){return f.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,r,i){const s=this.yr;this.yr++;const o=new Bo(s,t,r,i);this.mutationQueue.push(o);for(const a of i)this.wr=this.wr.add(new me(a.key,s)),this.indexManager.addToCollectionParentIndex(e,a.key.path.popLast());return f.resolve(o)}lookupMutationBatch(e,t){return f.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){const i=this.br(t+1),s=i<0?0:i;return f.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return f.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return f.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const r=new me(t,0),i=new me(t,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([r,i],o=>{const a=this.Sr(o.pr);s.push(a)}),f.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new K(C);return t.forEach(i=>{const s=new me(i,0),o=new me(i,Number.POSITIVE_INFINITY);this.wr.forEachInRange([s,o],a=>{r=r.add(a.pr)})}),f.resolve(this.Dr(r))}getAllMutationBatchesAffectingQuery(e,t){const r=t.path,i=r.length+1;let s=r;w.isDocumentKey(s)||(s=s.child(""));const o=new me(new w(s),0);let a=new K(C);return this.wr.forEachWhile(u=>{const c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(a=a.add(u.pr)),!0)},o),f.resolve(this.Dr(a))}Dr(e){const t=[];return e.forEach(r=>{const i=this.Sr(r);null!==i&&t.push(i)}),t}removeMutationBatch(e,t){P(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let r=this.wr;return f.forEach(t.mutations,i=>{const s=new me(i.key,t.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.wr=r})}Mn(e){}containsKey(e,t){const r=new me(t,0),i=this.wr.firstAfterOrEqual(r);return f.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return f.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){const t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class t_{constructor(e){this.vr=e,this.docs=new Q(w.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const r=t.key,i=this.docs.get(r),s=i?i.size:0,o=this.vr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const r=this.docs.get(t);return f.resolve(r?r.document.mutableCopy():Z.newInvalidDocument(t))}getEntries(e,t){let r=be();return t.forEach(i=>{const s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():Z.newInvalidDocument(i))}),f.resolve(r)}getDocumentsMatchingQuery(e,t,r,i){let s=be();const o=t.path,a=new w(o.child("")),u=this.docs.getIteratorFrom(a);for(;u.hasNext();){const{key:c,value:{document:l}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||Ro(Il(l),r)<=0||(i.has(l.key)||Sr(t,l))&&(s=s.insert(l.key,l.mutableCopy()))}return f.resolve(s)}getAllFromCollectionGroup(e,t,r,i){R()}Fr(e,t){return f.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new n_(this)}getSize(e){return f.resolve(this.size)}}class n_ extends hd{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?t.push(this.ar.addEntry(e,i)):this.ar.removeEntry(r)}),f.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class r_{constructor(e){this.persistence=e,this.Mr=new rt(t=>qt(t),Rr),this.lastRemoteSnapshotVersion=V.min(),this.highestTargetId=0,this.Or=0,this.Nr=new na,this.targetCount=0,this.Lr=Wt.Nn()}forEachTarget(e,t){return this.Mr.forEach((r,i)=>t(i)),f.resolve()}getLastRemoteSnapshotVersion(e){return f.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return f.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),f.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.Or&&(this.Or=t),f.resolve()}qn(e){this.Mr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Lr=new Wt(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,f.resolve()}updateTargetData(e,t){return this.qn(t),f.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,f.resolve()}removeTargets(e,t,r){let i=0;const s=[];return this.Mr.forEach((o,a)=>{a.sequenceNumber<=t&&null===r.get(a.targetId)&&(this.Mr.delete(o),s.push(this.removeMatchingKeysForTargetId(e,a.targetId)),i++)}),f.waitFor(s).next(()=>i)}getTargetCount(e){return f.resolve(this.targetCount)}getTargetData(e,t){const r=this.Mr.get(t)||null;return f.resolve(r)}addMatchingKeys(e,t,r){return this.Nr.dr(t,r),f.resolve()}removeMatchingKeys(e,t,r){this.Nr.Rr(t,r);const i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(o=>{s.push(i.markPotentiallyOrphaned(e,o))}),f.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),f.resolve()}getMatchingKeysForTargetId(e,t){const r=this.Nr.gr(t);return f.resolve(r)}containsKey(e,t){return f.resolve(this.Nr.containsKey(t))}}class ra{constructor(e,t){this.Br={},this.overlays={},this.kr=new Fe(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new r_(this),this.indexManager=new zp,this.remoteDocumentCache=new t_(r=>this.referenceDelegate.Kr(r)),this.serializer=new Gh(t),this.$r=new Jp(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Xp,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.Br[e.toKey()];return r||(r=new e_(t,this.referenceDelegate),this.Br[e.toKey()]=r),r}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,r){y("MemoryPersistence","Starting transaction:",e);const i=new i_(this.kr.next());return this.referenceDelegate.Ur(),r(i).next(s=>this.referenceDelegate.Wr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Gr(e,t){return f.or(Object.values(this.Br).map(r=>()=>r.containsKey(e,t)))}}class i_ extends El{constructor(e){super(),this.currentSequenceNumber=e}}class ns{constructor(e){this.persistence=e,this.zr=new na,this.jr=null}static Hr(e){return new ns(e)}get Jr(){if(this.jr)return this.jr;throw R()}addReference(e,t,r){return this.zr.addReference(r,t),this.Jr.delete(r.toString()),f.resolve()}removeReference(e,t,r){return this.zr.removeReference(r,t),this.Jr.add(r.toString()),f.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),f.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach(i=>this.Jr.add(i.toString()));const r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Jr.add(s.toString()))}).next(()=>r.removeTargetData(e,t))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return f.forEach(this.Jr,r=>{const i=w.fromPath(r);return this.Yr(e,i).next(s=>{s||t.removeEntry(i,V.min())})}).next(()=>(this.jr=null,t.apply(e)))}updateLimboDocument(e,t){return this.Yr(e,t).next(r=>{r?this.Jr.delete(t.toString()):this.Jr.add(t.toString())})}Kr(e){return 0}Yr(e,t){return f.or([()=>f.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class s_{constructor(e){this.serializer=e}N(e,t,r,i){const s=new Ni("createOrUpgrade",t);var u;r<1&&i>=1&&(e.createObjectStore("owner"),(u=e).createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Rl,{unique:!0}),u.createObjectStore("documentMutations"),_d(e),function(u){u.createObjectStore("remoteDocuments")}(e));let o=f.resolve();return r<3&&i>=3&&(0!==r&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(e),_d(e)),o=o.next(()=>function(u){const c=u.store("targetGlobal"),l={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:V.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",l)}(s))),r<4&&i>=4&&(0!==r&&(o=o.next(()=>function(u,c){return c.store("mutations").W().next(l=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Rl,{unique:!0});const h=c.store("mutations"),d=l.map(m=>h.put(m));return f.waitFor(d)})}(e,s))),o=o.next(()=>{!function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)})),r<5&&i>=5&&(o=o.next(()=>this.Xr(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(e),this.ei(s)))),r<7&&i>=7&&(o=o.next(()=>this.ti(s))),r<8&&i>=8&&(o=o.next(()=>this.ni(e,s))),r<9&&i>=9&&(o=o.next(()=>{!function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")}(e)})),r<10&&i>=10&&(o=o.next(()=>this.ri(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),r<12&&i>=12&&(o=o.next(()=>{!function(u){const c=u.createObjectStore("documentOverlays",{keyPath:Kg});c.createIndex("collectionPathOverlayIndex",jg,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",Qg,{unique:!1})}(e)})),r<13&&i>=13&&(o=o.next(()=>function(u){const c=u.createObjectStore("remoteDocumentsV14",{keyPath:Ng});c.createIndex("documentKeyIndex",kg),c.createIndex("collectionGroupIndex",Fg)}(e)).next(()=>this.ii(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.si(e,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:qg}).createIndex("sequenceNumberIndex",Ug,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:Gg}).createIndex("documentKeyIndex",zg,{unique:!1})}(e))),o}ei(e){let t=0;return e.store("remoteDocuments").Y((r,i)=>{t+=Xi(i)}).next(()=>{const r={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}Xr(e){const t=e.store("mutationQueues"),r=e.store("mutations");return t.W().next(i=>f.forEach(i,s=>{const o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.W("userMutationsIndex",o).next(a=>f.forEach(a,u=>{P(u.userId===s.userId);const c=jt(this.serializer,u);return id(e,s.userId,c).next(()=>{})}))}))}ti(e){const t=e.store("targetDocuments"),r=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return r.Y((o,a)=>{const u=new M(o),c=[0,ve(u)];s.push(t.get(c).next(l=>l?f.resolve():t.put({targetId:0,path:ve(u),sequenceNumber:i.highestListenSequenceNumber})))}).next(()=>f.waitFor(s))})}ni(e,t){e.createObjectStore("collectionParents",{keyPath:Bg});const r=t.store("collectionParents"),i=new ta,s=o=>{if(i.add(o)){const a=o.lastSegment(),u=o.popLast();return r.put({collectionId:a,parent:ve(u)})}};return t.store("remoteDocuments").Y({J:!0},(o,a)=>{const u=new M(o);return s(u.popLast())}).next(()=>t.store("documentMutations").Y({J:!0},([o,a,u],c)=>{const l=$e(a);return s(l.popLast())}))}ri(e){const t=e.store("targets");return t.Y((r,i)=>{const s=Or(i),o=Kh(this.serializer,s);return t.put(o)})}ii(e,t){const r=t.store("remoteDocuments"),i=[];return r.Y((s,o)=>{const a=t.store("remoteDocumentsV14"),u=(h=o,h.document?new w(M.fromString(h.document.name).popFirst(5)):h.noDocument?w.fromSegments(h.noDocument.path):h.unknownDocument?w.fromSegments(h.unknownDocument.path):R()).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};var h;i.push(a.put(c))}).next(()=>f.waitFor(i))}si(e,t){const r=t.store("mutations"),i=dd(this.serializer),s=new ra(ns.Hr,this.serializer.ct);return r.W().next(o=>{const a=new Map;return o.forEach(u=>{var c;let l=null!==(c=a.get(u.userId))&&void 0!==c?c:k();jt(this.serializer,u).keys().forEach(h=>l=l.add(h)),a.set(u.userId,l)}),f.forEach(a,(u,c)=>{const l=new de(c),h=Zi.lt(this.serializer,l),d=s.getIndexManager(l),m=es.lt(l,this.serializer,d,s.referenceDelegate);return new pd(i,m,h,d).recalculateAndSaveOverlaysForDocumentKeys(new Vo(t,Fe._e),u).next()})})}}function _d(n){n.createObjectStore("targetDocuments",{keyPath:Og}).createIndex("documentTargetsIndex",Lg,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Mg,{unique:!0}),n.createObjectStore("targetGlobal")}const ia="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sa{constructor(e,t,r,i,s,o,a,u,c,l,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.oi=s,this.window=o,this.document=a,this._i=c,this.ai=l,this.ui=h,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=d=>Promise.resolve(),!sa.D())throw new _(g.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Wp(this,i),this.Ti=t+"main",this.serializer=new Gh(u),this.Ei=new Oe(this.Ti,this.ui,new s_(this.serializer)),this.Qr=new jp(this.referenceDelegate,this.serializer),this.remoteDocumentCache=dd(this.serializer),this.$r=new Op,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===l&&ie("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new _(g.FAILED_PRECONDITION,ia);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Qr.getHighestSequenceNumber(e))}).then(e=>{this.kr=new Fe(e,this._i)}).then(()=>{this.qr=!0}).catch(e=>(this.Ei&&this.Ei.close(),Promise.reject(e)))}fi(e){var t=this;return this.Ii=function(){var r=(0,p.Z)(function*(i){if(t.started)return e(i)});return function(i){return r.apply(this,arguments)}}(),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ei.B(function(){var t=(0,p.Z)(function*(r){null===r.newVersion&&(yield e())});return function(r){return t.apply(this,arguments)}}())}setNetworkEnabled(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.oi.enqueueAndForget((0,p.Z)(function*(){t.started&&(yield t.Ai())})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>is(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.gi(e).next(t=>{t||(this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)))})}).next(()=>this.pi(e)).next(t=>this.isPrimary&&!t?this.yi(e).next(()=>!1):!!t&&this.wi(e).next(()=>!0))).catch(e=>{if(mt(e))return y("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return y("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.oi.enqueueRetryable(()=>this.Ii(e)),this.isPrimary=e})}gi(e){return Gr(e).get("owner").next(t=>f.resolve(this.Si(t)))}bi(e){return is(e).delete(this.clientId)}Di(){var e=this;return(0,p.Z)(function*(){if(e.isPrimary&&!e.Ci(e.Pi,18e5)){e.Pi=Date.now();const t=yield e.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",r=>{const i=fe(r,"clientMetadata");return i.W().next(s=>{const o=e.vi(s,18e5),a=s.filter(u=>-1===o.indexOf(u));return f.forEach(a,u=>i.delete(u.clientId)).next(()=>a)})}).catch(()=>[]);if(e.di)for(const r of t)e.di.removeItem(e.Fi(r.clientId))}})()}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Ai().then(()=>this.Di()).then(()=>this.mi()))}Si(e){return!!e&&e.ownerId===this.clientId}pi(e){return this.ai?f.resolve(!0):Gr(e).get("owner").next(t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)){if(this.Si(t)&&this.networkEnabled)return!0;if(!this.Si(t)){if(!t.allowTabSynchronization)throw new _(g.FAILED_PRECONDITION,ia);return!1}}return!(!this.networkEnabled||!this.inForeground)||is(e).W().next(r=>void 0===this.vi(r,5e3).find(i=>!(this.clientId===i.clientId||!(!this.networkEnabled&&i.networkEnabled||!this.inForeground&&i.inForeground&&this.networkEnabled===i.networkEnabled))))}).next(t=>(this.isPrimary!==t&&y("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){var e=this;return(0,p.Z)(function*(){e.qr=!1,e.xi(),e.hi&&(e.hi.cancel(),e.hi=null),e.Oi(),e.Ni(),yield e.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{const r=new Vo(t,Fe._e);return e.yi(r).next(()=>e.bi(r))}),e.Ei.close(),e.Li()})()}vi(e,t){return e.filter(r=>this.Ci(r.updateTimeMs,t)&&!this.Mi(r.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",e=>is(e).W().next(t=>this.vi(t,18e5).map(r=>r.clientId)))}get started(){return this.qr}getMutationQueue(e,t){return es.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Kp(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Zi.lt(this.serializer,e)}getBundleCache(){return this.$r}runTransaction(e,t,r){y("IndexedDbPersistence","Starting transaction:",e);const i="readonly"===t?"readonly":"readwrite",s=15===(u=this.ui)?Wg:14===u?xl:13===u?Vl:12===u?$g:11===u?Sl:void R();var u;let o;return this.Ei.runTransaction(e,i,s,a=>(o=new Vo(a,this.kr?this.kr.next():Fe._e),"readwrite-primary"===t?this.gi(o).next(u=>!!u||this.pi(o)).next(u=>{if(!u)throw ie(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.oi.enqueueRetryable(()=>this.Ii(!1)),new _(g.FAILED_PRECONDITION,Tl);return r(o)}).next(u=>this.wi(o).next(()=>u)):this.ki(o).next(()=>r(o)))).then(a=>(o.raiseOnCommittedEvent(),a))}ki(e){return Gr(e).get("owner").next(t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)&&!this.Si(t)&&!(this.ai||this.allowTabSynchronization&&t.allowTabSynchronization))throw new _(g.FAILED_PRECONDITION,ia)})}wi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Gr(e).put("owner",t)}static D(){return Oe.D()}yi(e){const t=Gr(e);return t.get("owner").next(r=>this.Si(r)?(y("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):f.resolve())}Ci(e,t){const r=Date.now();return!(e<r-t||e>r&&(ie(`Detected an update time that is in the future: ${e} > ${r}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai()))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const t=/(?:Version|Mobile)\/1[456]/;(0,q.G6)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(e){var t;try{const r=null!==(null===(t=this.di)||void 0===t?void 0:t.getItem(this.Fi(e)));return y("IndexedDbPersistence",`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return ie("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(e){ie("Failed to set zombie client id.",e)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch{}}Fi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Gr(n){return fe(n,"owner")}function is(n){return fe(n,"clientMetadata")}function oa(n,e){let t=n.projectId;return n.isDefaultDatabase||(t+="."+n.database),"firestore/"+e+"/"+t+"/"}class aa{constructor(e,t,r,i){this.targetId=e,this.fromCache=t,this.qi=r,this.Qi=i}static Ki(e,t){let r=k(),i=k();for(const s of t.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new aa(e,t.fromCache,r,i)}}class o_{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class yd{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=(0,q.G6)()?8:Oe.v((0,q.z$)())>0?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,r,i){const s={result:null};return this.ji(e,t).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Hi(e,t,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;const o=new o_;return this.Ji(e,t,o).next(a=>{if(s.result=a,this.Ui)return this.Yi(e,t,o,a.size)})}).next(()=>s.result)}Yi(e,t,r,i){return r.documentReadCount<this.Wi?(dn()<=ze.in.DEBUG&&y("QueryEngine","SDK will not create cache indexes for query:",En(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),f.resolve()):(dn()<=ze.in.DEBUG&&y("QueryEngine","Query:",En(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Gi*i?(dn()<=ze.in.DEBUG&&y("QueryEngine","The SDK decides to create cache indexes for query:",En(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Pe(t))):f.resolve())}ji(e,t){if(Xl(t))return f.resolve(null);let r=Pe(t);return this.indexManager.getIndexType(e,r).next(i=>0===i?null:(null!==t.limit&&1===i&&(t=zi(t,null,"F"),r=Pe(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(s=>{const o=k(...s);return this.zi.getDocuments(e,o).next(a=>this.indexManager.getMinOffset(e,r).next(u=>{const c=this.Zi(t,a);return this.Xi(t,c,o,u.readTime)?this.ji(e,zi(t,null,"F")):this.es(e,c,t,u)}))})))}Hi(e,t,r,i){return Xl(t)||i.isEqual(V.min())?f.resolve(null):this.zi.getDocuments(e,r).next(s=>{const o=this.Zi(t,s);return this.Xi(t,o,r,i)?f.resolve(null):(dn()<=ze.in.DEBUG&&y("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),En(t)),this.es(e,o,t,yl(i,-1)).next(a=>a))})}Zi(e,t){let r=new K(rh(e));return t.forEach((i,s)=>{Sr(e,s)&&(r=r.add(s))}),r}Xi(e,t,r,i){if(null===e.limit)return!1;if(r.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Ji(e,t,r){return dn()<=ze.in.DEBUG&&y("QueryEngine","Using full collection scan to execute query:",En(t)),this.zi.getDocumentsMatchingQuery(e,t,ke.min(),r)}es(e,t,r,i){return this.zi.getDocumentsMatchingQuery(e,r,i).next(s=>(t.forEach(o=>{s=s.insert(o.key,o)}),s))}}class a_{constructor(e,t,r,i){this.persistence=e,this.ts=t,this.serializer=i,this.ns=new Q(C),this.rs=new rt(s=>qt(s),Rr),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(r)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new pd(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.ns))}}function Id(n,e,t,r){return new a_(n,e,t,r)}function Td(n,e){return ua.apply(this,arguments)}function ua(){return ua=(0,p.Z)(function*(n,e){const t=v(n);return yield t.persistence.runTransaction("Handle user change","readonly",r=>{let i;return t.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,t._s(e),t.mutationQueue.getAllMutationBatches(r))).next(s=>{const o=[],a=[];let u=k();for(const c of i){o.push(c.batchId);for(const l of c.mutations)u=u.add(l.key)}for(const c of s){a.push(c.batchId);for(const l of c.mutations)u=u.add(l.key)}return t.localDocuments.getDocuments(r,u).next(c=>({us:c,removedBatchIds:o,addedBatchIds:a}))})})}),ua.apply(this,arguments)}function Ed(n){const e=v(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Qr.getLastRemoteSnapshotVersion(t))}function vd(n,e,t){let r=k(),i=k();return t.forEach(s=>r=r.add(s)),e.getEntries(n,r).next(s=>{let o=be();return t.forEach((a,u)=>{const c=s.get(a);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(a)),u.isNoDocument()&&u.version.isEqual(V.min())?(e.removeEntry(a,u.readTime),o=o.insert(a,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||0===u.version.compareTo(c.version)&&c.hasPendingWrites?(e.addEntry(u),o=o.insert(a,u)):y("LocalStore","Ignoring outdated watch update for ",a,". Current version:",c.version," Watch version:",u.version)}),{cs:o,ls:i}})}function l_(n,e){const t=v(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(void 0===e&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function bn(n,e){const t=v(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return t.Qr.getTargetData(r,e).next(s=>s?(i=s,f.resolve(i)):t.Qr.allocateTargetId(r).next(o=>(i=new st(e,o,"TargetPurposeListen",r.currentSequenceNumber),t.Qr.addTargetData(r,i).next(()=>i))))}).then(r=>{const i=t.ns.get(r.targetId);return(null===i||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.ns=t.ns.insert(r.targetId,r),t.rs.set(e,r.targetId)),r})}function Nn(n,e,t){return ca.apply(this,arguments)}function ca(){return ca=(0,p.Z)(function*(n,e,t){const r=v(n),i=r.ns.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!mt(o))throw o;y("LocalStore",`Failed to update sequence numbers for target ${e}: ${o}`)}r.ns=r.ns.remove(e),r.rs.delete(i.target)}),ca.apply(this,arguments)}function ss(n,e,t){const r=v(n);let i=V.min(),s=k();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,l){const h=v(u),d=h.rs.get(l);return void 0!==d?f.resolve(h.ns.get(d)):h.Qr.getTargetData(c,l)}(r,o,Pe(e)).next(a=>{if(a)return i=a.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(o,a.targetId).next(u=>{s=u})}).next(()=>r.ts.getDocumentsMatchingQuery(o,e,t?i:V.min(),t?s:k())).next(a=>(Rd(r,nh(e),a),{documents:a,hs:s})))}function wd(n,e){const t=v(n),r=v(t.Qr),i=t.ns.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>r._t(s,e).next(o=>o?o.target:null))}function Ad(n,e){const t=v(n),r=t.ss.get(e)||V.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.os.getAllFromCollectionGroup(i,e,yl(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Rd(t,e,i),i))}function Rd(n,e,t){let r=n.ss.get(e)||V.min();t.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.ss.set(e,r)}function la(){return la=(0,p.Z)(function*(n,e,t,r){const i=v(n);let s=k(),o=be();for(const c of t){const l=e.Ps(c.metadata.name);c.document&&(s=s.add(l));const h=e.Is(c);h.setReadTime(e.Ts(c.metadata.readTime)),o=o.insert(l,h)}const a=i.os.newChangeBuffer({trackRemovals:!0}),u=yield bn(i,(l=r,Pe(In(M.fromString(`__bundle__/docs/${l}`)))));var l;return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>vd(c,a,o).next(l=>(a.apply(c),l)).next(l=>i.Qr.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.Qr.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,l.cs,l.ls)).next(()=>l.cs)))}),la.apply(this,arguments)}function d_(n,e){return ha.apply(this,arguments)}function ha(){return ha=(0,p.Z)(function*(n,e,t=k()){const r=yield bn(n,Pe(Ho(e.bundledQuery))),i=v(n);return i.persistence.runTransaction("Save named query","readwrite",s=>{const o=se(e.readTime);if(r.snapshotVersion.compareTo(o)>=0)return i.$r.saveNamedQuery(s,e);const a=r.withResumeToken(ce.EMPTY_BYTE_STRING,o);return i.ns=i.ns.insert(a.targetId,a),i.Qr.updateTargetData(s,a).next(()=>i.Qr.removeMatchingKeysForTargetId(s,r.targetId)).next(()=>i.Qr.addMatchingKeys(s,t,r.targetId)).next(()=>i.$r.saveNamedQuery(s,e))})}),ha.apply(this,arguments)}function Pd(n,e){return`firestore_clients_${n}_${e}`}function Sd(n,e,t){let r=`firestore_mutations_${n}_${t}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function da(n,e){return`firestore_targets_${n}_${e}`}class os{constructor(e,t,r,i){this.user=e,this.batchId=t,this.state=r,this.error=i}static Es(e,t,r){const i=JSON.parse(r);let s,o="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code,o&&(s=new _(i.error.code,i.error.message))),o?new os(e,t,i.state,s):(ie("SharedClientState",`Failed to parse mutation state for ID '${t}': ${r}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class zr{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Es(e,t){const r=JSON.parse(t);let i,s="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new _(r.error.code,r.error.message))),s?new zr(e,r.state,i):(ie("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class as{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){const r=JSON.parse(t);let i="object"==typeof r&&r.activeTargetIds instanceof Array,s=Oo();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=wl(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new as(e,s):(ie("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class fa{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new fa(t.clientId,t.onlineState):(ie("SharedClientState",`Failed to parse online state: ${e}`),null)}}class ma{constructor(){this.activeTargetIds=Oo()}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class ga{constructor(e,t,r,i,s){this.window=e,this.oi=t,this.persistenceKey=r,this.Vs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new Q(C),this.started=!1,this.ys=[];const o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=Pd(this.persistenceKey,this.Vs),this.Ss=`firestore_sequence_number_${this.persistenceKey}`,this.ps=this.ps.insert(this.Vs,new ma),this.bs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.vs=`firestore_online_state_${this.persistenceKey}`,this.Fs=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(e){return!(!e||!e.localStorage)}start(){var e=this;return(0,p.Z)(function*(){const t=yield e.syncEngine.Bi();for(const i of t){if(i===e.Vs)continue;const s=e.getItem(Pd(e.persistenceKey,i));if(s){const o=as.Es(i,s);o&&(e.ps=e.ps.insert(o.clientId,o))}}e.Ms();const r=e.storage.getItem(e.vs);if(r){const i=e.xs(r);i&&e.Os(i)}for(const i of e.ys)e.gs(i);e.ys=[],e.window.addEventListener("pagehide",()=>e.shutdown()),e.started=!0})()}writeSequenceNumber(e){this.setItem(this.Ss,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(e){let t=!1;return this.ps.forEach((r,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.Ls(e,"pending")}updateMutationState(e,t,r){this.Ls(e,t,r),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const r=this.storage.getItem(da(this.persistenceKey,e));if(r){const i=zr.Es(e,r);i&&(t=i.state)}}return this.ks.As(e),this.Ms(),t}removeLocalQueryTarget(e){this.ks.Rs(e),this.Ms()}isLocalQueryTarget(e){return this.ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(da(this.persistenceKey,e))}updateQueryState(e,t,r){this.qs(e,t,r)}handleUserChange(e,t,r){t.forEach(i=>{this.Bs(i)}),this.currentUser=e,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Qs(e)}notifyBundleLoaded(e){this.Ks(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return y("SharedClientState","READ",e,t),t}setItem(e,t){y("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){y("SharedClientState","REMOVE",e),this.storage.removeItem(e)}gs(e){var t=this;const r=e;if(r.storageArea===this.storage){if(y("SharedClientState","EVENT",r.key,r.newValue),r.key===this.ws)return void ie("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((0,p.Z)(function*(){if(t.started){if(null!==r.key)if(t.bs.test(r.key)){if(null==r.newValue){const i=t.$s(r.key);return t.Us(i,null)}{const i=t.Ws(r.key,r.newValue);if(i)return t.Us(i.clientId,i)}}else if(t.Ds.test(r.key)){if(null!==r.newValue){const i=t.Gs(r.key,r.newValue);if(i)return t.zs(i)}}else if(t.Cs.test(r.key)){if(null!==r.newValue){const i=t.js(r.key,r.newValue);if(i)return t.Hs(i)}}else if(r.key===t.vs){if(null!==r.newValue){const i=t.xs(r.newValue);if(i)return t.Os(i)}}else if(r.key===t.Ss){const i=function(o){let a=Fe._e;if(null!=o)try{const u=JSON.parse(o);P("number"==typeof u),a=u}catch(u){ie("SharedClientState","Failed to read sequence number from WebStorage",u)}return a}(r.newValue);i!==Fe._e&&t.sequenceNumberHandler(i)}else if(r.key===t.Fs){const i=t.Js(r.newValue);yield Promise.all(i.map(s=>t.syncEngine.Ys(s)))}}else t.ys.push(r)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(e,t,r){const i=new os(this.currentUser,e,t,r),s=Sd(this.persistenceKey,this.currentUser,e);this.setItem(s,i.ds())}Bs(e){const t=Sd(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Qs(e){this.storage.setItem(this.vs,JSON.stringify({clientId:this.Vs,onlineState:e}))}qs(e,t,r){const i=da(this.persistenceKey,e),s=new zr(e,t,r);this.setItem(i,s.ds())}Ks(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Fs,t)}$s(e){const t=this.bs.exec(e);return t?t[1]:null}Ws(e,t){const r=this.$s(e);return as.Es(r,t)}Gs(e,t){const r=this.Ds.exec(e),i=Number(r[1]);return os.Es(new de(void 0!==r[2]?r[2]:null),i,t)}js(e,t){const r=this.Cs.exec(e),i=Number(r[1]);return zr.Es(i,t)}xs(e){return fa.Es(e)}Js(e){return JSON.parse(e)}zs(e){var t=this;return(0,p.Z)(function*(){if(e.user.uid===t.currentUser.uid)return t.syncEngine.Zs(e.batchId,e.state,e.error);y("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})()}Hs(e){return this.syncEngine.Xs(e.targetId,e.state,e.error)}Us(e,t){const r=t?this.ps.insert(e,t):this.ps.remove(e),i=this.Ns(this.ps),s=this.Ns(r),o=[],a=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||a.push(u)}),this.syncEngine.eo(o,a).then(()=>{this.ps=r})}Os(e){this.ps.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ns(e){let t=Oo();return e.forEach((r,i)=>{t=t.unionWith(i.activeTargetIds)}),t}}class Vd{constructor(){this.no=new ma,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,r){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new ma,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class f_{io(e){}shutdown(){}}class xd{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){y("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){y("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return typeof window<"u"&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let us=null;function pa(){return null===us?us=268435456+Math.round(2147483648*Math.random()):us++,"0x"+us.toString(16)}const m_={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class g_{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}onMessage(e){this.Ao=e}close(){this.ho()}send(e){this.lo(e)}Ro(){this.Io()}Vo(e){this.Eo(e)}mo(e){this.Ao(e)}}const Ae="WebChannelConnection";class p_ extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const r=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.fo=r+"://"+t.host,this.po=`projects/${i}/databases/${s}`,this.yo="(default)"===this.databaseId.database?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get wo(){return!1}So(t,r,i,s,o){const a=pa(),u=this.bo(t,r.toUriEncodedString());y("RestConnection",`Sending RPC '${t}' ${a}:`,u,i);const c={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(c,s,o),this.Co(t,u,c,i).then(l=>(y("RestConnection",`Received RPC '${t}' ${a}: `,l),l),l=>{throw Ce("RestConnection",`RPC '${t}' ${a} failed with error: `,l,"url: ",u,"request:",i),l})}vo(t,r,i,s,o,a){return this.So(t,r,i,s,o)}Do(t,r,i){t["X-Goog-Api-Client"]="gl-js/ fire/"+hn,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>t[o]=s),i&&i.headers.forEach((s,o)=>t[o]=s)}bo(t,r){return`${this.fo}/v1/${r}:${m_[t]}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Co(e,t,r,i){const s=pa();return new Promise((o,a)=>{const u=new fg;u.setWithCredentials(!0),u.listenOnce(hg.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case vo.NO_ERROR:const l=u.getResponseJson();y(Ae,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(l)),o(l);break;case vo.TIMEOUT:y(Ae,`RPC '${e}' ${s} timed out`),a(new _(g.DEADLINE_EXCEEDED,"Request time out"));break;case vo.HTTP_ERROR:const h=u.getStatus();if(y(Ae,`RPC '${e}' ${s} failed with status:`,h,"response text:",u.getResponseText()),h>0){let d=u.getResponseJson();Array.isArray(d)&&(d=d[0]);const m=d?.error;if(m&&m.status&&m.message){const I=function(T){const x=T.toLowerCase().replace(/_/g,"-");return Object.values(g).indexOf(x)>=0?x:g.UNKNOWN}(m.status);a(new _(I,m.message))}else a(new _(g.UNKNOWN,"Server responded with status "+u.getStatus()))}else a(new _(g.UNAVAILABLE,"Connection failed."));break;default:R()}}finally{y(Ae,`RPC '${e}' ${s} completed.`)}});const c=JSON.stringify(i);y(Ae,`RPC '${e}' ${s} sending request:`,i),u.send(t,"POST",c,r,15)})}Fo(e,t,r){const i=pa(),s=[this.fo,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=cg(),a=lg(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.useFetchStreams=!0),this.Do(u.initMessageHeaders,t,r),u.encodeInitMessageHeaders=!0;const l=s.join("");y(Ae,`Creating RPC '${e}' stream ${i}: ${l}`,u);const h=o.createWebChannel(l,u);let d=!1,m=!1;const I=new g_({lo:T=>{m?y(Ae,`Not sending because RPC '${e}' stream ${i} is closed:`,T):(d||(y(Ae,`Opening RPC '${e}' stream ${i} transport.`),h.open(),d=!0),y(Ae,`RPC '${e}' stream ${i} sending:`,T),h.send(T))},ho:()=>h.close()}),E=(T,x,b)=>{T.listen(x,S=>{try{b(S)}catch(N){setTimeout(()=>{throw N},0)}})};return E(h,bi.EventType.OPEN,()=>{m||y(Ae,`RPC '${e}' stream ${i} transport opened.`)}),E(h,bi.EventType.CLOSE,()=>{m||(m=!0,y(Ae,`RPC '${e}' stream ${i} transport closed`),I.Vo())}),E(h,bi.EventType.ERROR,T=>{m||(m=!0,Ce(Ae,`RPC '${e}' stream ${i} transport errored:`,T),I.Vo(new _(g.UNAVAILABLE,"The operation could not be completed")))}),E(h,bi.EventType.MESSAGE,T=>{var x;if(!m){const b=T.data[0];P(!!b);const N=b.error||(null===(x=b[0])||void 0===x?void 0:x.error);if(N){y(Ae,`RPC '${e}' stream ${i} received error:`,N);const B=N.status;let U=function(UI){const nm=ae[UI];if(void 0!==nm)return Eh(nm)}(B),oe=N.message;void 0===U&&(U=g.INTERNAL,oe="Unknown error status: "+B+" with message "+N.message),m=!0,I.Vo(new _(U,oe)),h.close()}else y(Ae,`RPC '${e}' stream ${i} received:`,b),I.mo(b)}}),E(a,dg.STAT_EVENT,T=>{T.stat===dl.PROXY?y(Ae,`RPC '${e}' stream ${i} detected buffering proxy`):T.stat===dl.NOPROXY&&y(Ae,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{I.Ro()},0),I}}function Cd(){return typeof window<"u"?window:null}function cs(){return typeof document<"u"?document:null}function Kr(n){return new Pp(n,!0)}class _a{constructor(e,t,r=1e3,i=1.5,s=6e4){this.oi=e,this.timerId=t,this.Mo=r,this.xo=i,this.Oo=s,this.No=0,this.Lo=null,this.Bo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(e){this.cancel();const t=Math.floor(this.No+this.Qo()),r=Math.max(0,Date.now()-this.Bo),i=Math.max(0,t-r);i>0&&y("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.No} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.Lo=this.oi.enqueueAfterDelay(this.timerId,i,()=>(this.Bo=Date.now(),e())),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){null!==this.Lo&&(this.Lo.skipDelay(),this.Lo=null)}cancel(){null!==this.Lo&&(this.Lo.cancel(),this.Lo=null)}Qo(){return(Math.random()-.5)*this.No}}class Dd{constructor(e,t,r,i,s,o,a,u){this.oi=e,this.$o=r,this.Uo=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=u,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new _a(e,t)}Ho(){return 1===this.state||5===this.state||this.Jo()}Jo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Yo()}stop(){var e=this;return(0,p.Z)(function*(){e.Ho()&&(yield e.close(0))})()}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&null===this.Go&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,()=>this.e_()))}t_(e){this.n_(),this.stream.send(e)}e_(){var e=this;return(0,p.Z)(function*(){if(e.Jo())return e.close(0)})()}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}close(e,t){var r=this;return(0,p.Z)(function*(){r.n_(),r.r_(),r.jo.cancel(),r.Wo++,4!==e?r.jo.reset():t&&t.code===g.RESOURCE_EXHAUSTED?(ie(t.toString()),ie("Using maximum backoff delay to prevent overloading the backend."),r.jo.ko()):t&&t.code===g.UNAUTHENTICATED&&3!==r.state&&(r.authCredentialsProvider.invalidateToken(),r.appCheckCredentialsProvider.invalidateToken()),null!==r.stream&&(r.i_(),r.stream.close(),r.stream=null),r.state=e,yield r.listener.To(t)})()}i_(){}auth(){this.state=1;const e=this.s_(this.Wo),t=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.Wo===t&&this.o_(r,i)},r=>{e(()=>{const i=new _(g.UNKNOWN,"Fetching auth token failed: "+r.message);return this.__(i)})})}o_(e,t){const r=this.s_(this.Wo);this.stream=this.a_(e,t),this.stream.Po(()=>{r(()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,()=>(this.Jo()&&(this.state=3),Promise.resolve())),this.listener.Po()))}),this.stream.To(i=>{r(()=>this.__(i))}),this.stream.onMessage(i=>{r(()=>this.onMessage(i))})}Yo(){var e=this;this.state=5,this.jo.qo((0,p.Z)(function*(){e.state=0,e.start()}))}__(e){return y("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}s_(e){return t=>{this.oi.enqueueAndForget(()=>this.Wo===e?t():(y("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class __ extends Dd{constructor(e,t,r,i,s,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}a_(e,t){return this.connection.Fo("Listen",e,t)}onMessage(e){this.jo.reset();const t=function xp(n,e){let t;if("targetChange"in e){const r="NO_CHANGE"===(c=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===c?1:"REMOVE"===c?2:"CURRENT"===c?3:"RESET"===c?4:R(),i=e.targetChange.targetIds||[],s=function(c,l){return c.useProto3Json?(P(void 0===l||"string"==typeof l),ce.fromBase64String(l||"")):(P(void 0===l||l instanceof Uint8Array),ce.fromUint8Array(l||new Uint8Array))}(n,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(c){const l=void 0===c.code?g.UNKNOWN:Eh(c.code);return new _(l,c.message||"")}(o);t=new Ph(r,i,s,a||null)}else if("documentChange"in e){const r=e.documentChange,i=Ze(n,r.document.name),s=se(r.document.updateTime),o=r.document.createTime?se(r.document.createTime):V.min(),a=new ye({mapValue:{fields:r.document.fields}}),u=Z.newFoundDocument(i,s,o,a);t=new Wi(r.targetIds||[],r.removedTargetIds||[],u.key,u)}else if("documentDelete"in e){const r=e.documentDelete,i=Ze(n,r.document),s=r.readTime?se(r.readTime):V.min(),o=Z.newNoDocument(i,s);t=new Wi([],r.removedTargetIds||[],o.key,o)}else if("documentRemove"in e){const r=e.documentRemove,i=Ze(n,r.document);t=new Wi([],r.removedTargetIds||[],i,null)}else{if(!("filter"in e))return R();{const r=e.filter,{count:i=0,unchangedNames:s}=r,o=new Tp(i,s);t=new Rh(r.targetId,o)}}var c;return t}(this.serializer,e),r=function(s){if(!("targetChange"in s))return V.min();const o=s.targetChange;return o.targetIds&&o.targetIds.length?V.min():o.readTime?se(o.readTime):V.min()}(e);return this.listener.u_(t,r)}c_(e){const t={};t.database=Qo(this.serializer),t.addTarget=function(s,o){let a;const u=o.target;if(a=Ui(u)?{documents:Oh(s,u)}:{query:Wo(s,u).ut},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=Ch(s,o.resumeToken);const c=zo(s,o.expectedCount);null!==c&&(a.expectedCount=c)}else if(o.snapshotVersion.compareTo(V.min())>0){a.readTime=Pn(s,o.snapshotVersion.toTimestamp());const c=zo(s,o.expectedCount);null!==c&&(a.expectedCount=c)}return a}(this.serializer,e);const r=function Dp(n,e){const t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return R()}}(e.purpose);return null==t?null:{"goog-listen-tags":t}}(0,e);r&&(t.labels=r),this.t_(t)}l_(e){const t={};t.database=Qo(this.serializer),t.removeTarget=e,this.t_(t)}}class y_ extends Dd{constructor(e,t,r,i,s,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(e,t){return this.connection.Fo("Write",e,t)}onMessage(e){if(P(!!e.streamToken),this.lastStreamToken=e.streamToken,this.h_){this.jo.reset();const t=function Cp(n,e){return n&&n.length>0?(P(void 0!==e),n.map(t=>function(i,s){let o=se(i.updateTime?i.updateTime:s);return o.isEqual(V.min())&&(o=se(s)),new pp(o,i.transformResults||[])}(t,e))):[]}(e.writeResults,e.commitTime),r=se(e.commitTime);return this.listener.T_(r,t)}return P(!e.writeResults||0===e.writeResults.length),this.h_=!0,this.listener.E_()}d_(){const e={};e.database=Qo(this.serializer),this.t_(e)}I_(e){const t={streamToken:this.lastStreamToken,writes:e.map(r=>Mr(this.serializer,r))};this.t_(t)}}class I_ extends class{}{constructor(e,t,r,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=i,this.A_=!1}R_(){if(this.A_)throw new _(g.FAILED_PRECONDITION,"The client has already been terminated.")}So(e,t,r,i){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.So(e,jo(t,r),i,s,o)).catch(s=>{throw"FirebaseError"===s.name?(s.code===g.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new _(g.UNKNOWN,s.toString())})}vo(e,t,r,i,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.vo(e,jo(t,r),i,o,a,s)).catch(o=>{throw"FirebaseError"===o.name?(o.code===g.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new _(g.UNKNOWN,o.toString())})}terminate(){this.A_=!0,this.connection.terminate()}}class E_{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){0===this.m_&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve())))}S_(e){"Online"===this.state?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.y_("Offline")))}set(e){this.b_(),this.m_=0,"Online"===e&&(this.g_=!1),this.y_(e)}y_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}w_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(ie(t),this.g_=!1):y("OnlineStateTracker",t)}b_(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}}class v_{constructor(e,t,r,i,s){var o=this;this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=s,this.M_.io(a=>{r.enqueueAndForget((0,p.Z)(function*(){var u;Pt(o)&&(y("RemoteStore","Restarting streams for network reachability change."),yield(u=(0,p.Z)(function*(l){const h=v(l);h.v_.add(4),yield kn(h),h.x_.set("Unknown"),h.v_.delete(4),yield jr(h)}),function c(l){return u.apply(this,arguments)})(o))}))}),this.x_=new E_(r,i)}}function jr(n){return Ia.apply(this,arguments)}function Ia(){return Ia=(0,p.Z)(function*(n){if(Pt(n))for(const e of n.F_)yield e(!0)}),Ia.apply(this,arguments)}function kn(n){return Ta.apply(this,arguments)}function Ta(){return Ta=(0,p.Z)(function*(n){for(const e of n.F_)yield e(!1)}),Ta.apply(this,arguments)}function ls(n,e){const t=v(n);t.C_.has(e.targetId)||(t.C_.set(e.targetId,e),wa(t)?va(t):On(t).Jo()&&Ea(t,e))}function Fn(n,e){const t=v(n),r=On(t);t.C_.delete(e),r.Jo()&&bd(t,e),0===t.C_.size&&(r.Jo()?r.Xo():Pt(t)&&t.x_.set("Unknown"))}function Ea(n,e){if(n.O_.Oe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(V.min())>0){const t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}On(n).c_(e)}function bd(n,e){n.O_.Oe(e),On(n).l_(e)}function va(n){n.O_=new vp({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>n.C_.get(e)||null,nt:()=>n.datastore.serializer.databaseId}),On(n).start(),n.x_.p_()}function wa(n){return Pt(n)&&!On(n).Ho()&&n.C_.size>0}function Pt(n){return 0===v(n).v_.size}function Nd(n){n.O_=void 0}function w_(n){return Aa.apply(this,arguments)}function Aa(){return Aa=(0,p.Z)(function*(n){n.C_.forEach((e,t)=>{Ea(n,e)})}),Aa.apply(this,arguments)}function A_(n,e){return Ra.apply(this,arguments)}function Ra(){return Ra=(0,p.Z)(function*(n,e){Nd(n),wa(n)?(n.x_.S_(e),va(n)):n.x_.set("Unknown")}),Ra.apply(this,arguments)}function R_(n,e,t){return Pa.apply(this,arguments)}function Pa(){return Pa=(0,p.Z)(function*(n,e,t){if(n.x_.set("Online"),e instanceof Ph&&2===e.state&&e.cause)try{yield(r=(0,p.Z)(function*(s,o){const a=o.cause;for(const u of o.targetIds)s.C_.has(u)&&(yield s.remoteSyncer.rejectListen(u,a),s.C_.delete(u),s.O_.removeTarget(u))}),function i(s,o){return r.apply(this,arguments)})(n,e)}catch(r){y("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),yield hs(n,r)}else if(e instanceof Wi?n.O_.$e(e):e instanceof Rh?n.O_.Je(e):n.O_.Ge(e),!t.isEqual(V.min()))try{const r=yield Ed(n.localStore);t.compareTo(r)>=0&&(yield function(s,o){const a=s.O_.it(o);return a.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){const l=s.C_.get(c);l&&s.C_.set(c,l.withResumeToken(u.resumeToken,o))}}),a.targetMismatches.forEach((u,c)=>{const l=s.C_.get(u);if(!l)return;s.C_.set(u,l.withResumeToken(ce.EMPTY_BYTE_STRING,l.snapshotVersion)),bd(s,u);const h=new st(l.target,u,c,l.sequenceNumber);Ea(s,h)}),s.remoteSyncer.applyRemoteEvent(a)}(n,t))}catch(r){y("RemoteStore","Failed to raise snapshot:",r),yield hs(n,r)}var r}),Pa.apply(this,arguments)}function hs(n,e,t){return Sa.apply(this,arguments)}function Sa(){return Sa=(0,p.Z)(function*(n,e,t){if(!mt(e))throw e;n.v_.add(1),yield kn(n),n.x_.set("Offline"),t||(t=()=>Ed(n.localStore)),n.asyncQueue.enqueueRetryable((0,p.Z)(function*(){y("RemoteStore","Retrying IndexedDB access"),yield t(),n.v_.delete(1),yield jr(n)}))}),Sa.apply(this,arguments)}function kd(n,e){return e().catch(t=>hs(n,t,e))}function Mn(n){return Va.apply(this,arguments)}function Va(){return Va=(0,p.Z)(function*(n){const e=v(n),t=St(e);let r=e.D_.length>0?e.D_[e.D_.length-1].batchId:-1;for(;P_(e);)try{const i=yield l_(e.localStore,r);if(null===i){0===e.D_.length&&t.Xo();break}r=i.batchId,S_(e,i)}catch(i){yield hs(e,i)}Fd(e)&&Md(e)}),Va.apply(this,arguments)}function P_(n){return Pt(n)&&n.D_.length<10}function S_(n,e){n.D_.push(e);const t=St(n);t.Jo()&&t.P_&&t.I_(e.mutations)}function Fd(n){return Pt(n)&&!St(n).Ho()&&n.D_.length>0}function Md(n){St(n).start()}function V_(n){return xa.apply(this,arguments)}function xa(){return xa=(0,p.Z)(function*(n){St(n).d_()}),xa.apply(this,arguments)}function x_(n){return Ca.apply(this,arguments)}function Ca(){return Ca=(0,p.Z)(function*(n){const e=St(n);for(const t of n.D_)e.I_(t.mutations)}),Ca.apply(this,arguments)}function C_(n,e,t){return Da.apply(this,arguments)}function Da(){return Da=(0,p.Z)(function*(n,e,t){const r=n.D_.shift(),i=qo.from(r,e,t);yield kd(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield Mn(n)}),Da.apply(this,arguments)}function D_(n,e){return ba.apply(this,arguments)}function ba(){return ba=(0,p.Z)(function*(n,e){var t;e&&St(n).P_&&(yield(t=(0,p.Z)(function*(i,s){if(Th(a=s.code)&&a!==g.ABORTED){const o=i.D_.shift();St(i).Zo(),yield kd(i,()=>i.remoteSyncer.rejectFailedWrite(o.batchId,s)),yield Mn(i)}var a}),function r(i,s){return t.apply(this,arguments)})(n,e)),Fd(n)&&Md(n)}),ba.apply(this,arguments)}function Od(n,e){return Na.apply(this,arguments)}function Na(){return Na=(0,p.Z)(function*(n,e){const t=v(n);t.asyncQueue.verifyOperationInProgress(),y("RemoteStore","RemoteStore received new credentials");const r=Pt(t);t.v_.add(3),yield kn(t),r&&t.x_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.v_.delete(3),yield jr(t)}),Na.apply(this,arguments)}function ka(n,e){return Fa.apply(this,arguments)}function Fa(){return Fa=(0,p.Z)(function*(n,e){const t=v(n);e?(t.v_.delete(2),yield jr(t)):e||(t.v_.add(2),yield kn(t),t.x_.set("Unknown"))}),Fa.apply(this,arguments)}function On(n){return n.N_||(n.N_=function(t,r,i){const s=v(t);return s.R_(),new __(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Po:w_.bind(null,n),To:A_.bind(null,n),u_:R_.bind(null,n)}),n.F_.push(function(){var e=(0,p.Z)(function*(t){t?(n.N_.Zo(),wa(n)?va(n):n.x_.set("Unknown")):(yield n.N_.stop(),Nd(n))});return function(t){return e.apply(this,arguments)}}())),n.N_}function St(n){return n.L_||(n.L_=function(t,r,i){const s=v(t);return s.R_(),new y_(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Po:V_.bind(null,n),To:D_.bind(null,n),E_:x_.bind(null,n),T_:C_.bind(null,n)}),n.F_.push(function(){var e=(0,p.Z)(function*(t){t?(n.L_.Zo(),yield Mn(n)):(yield n.L_.stop(),n.D_.length>0&&(y("RemoteStore",`Stopping write stream with ${n.D_.length} pending writes`),n.D_=[]))});return function(t){return e.apply(this,arguments)}}())),n.L_}class Ma{constructor(e,t,r,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new ue,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,i,s){const o=Date.now()+r,a=new Ma(e,t,o,i,s);return a.start(r),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _(g.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ln(n,e){if(ie("AsyncQueue",`${e}: ${n}`),mt(n))return new _(g.UNAVAILABLE,`${e}: ${n}`);throw n}class Bn{constructor(e){this.comparator=e?(t,r)=>e(t,r)||w.comparator(t.key,r.key):(t,r)=>w.comparator(t.key,r.key),this.keyedMap=Vr(),this.sortedSet=new Q(this.comparator)}static emptySet(e){return new Bn(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Bn)||this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){const i=t.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const r=new Bn;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}}class Ld{constructor(){this.B_=new Q(w.comparator)}track(e){const t=e.doc.key,r=this.B_.get(t);r?0!==e.type&&3===r.type?this.B_=this.B_.insert(t,e):3===e.type&&1!==r.type?this.B_=this.B_.insert(t,{type:r.type,doc:e.doc}):2===e.type&&2===r.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===r.type?this.B_=this.B_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===r.type?this.B_=this.B_.remove(t):1===e.type&&2===r.type?this.B_=this.B_.insert(t,{type:1,doc:r.doc}):0===e.type&&1===r.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):R():this.B_=this.B_.insert(t,e)}k_(){const e=[];return this.B_.inorderTraversal((t,r)=>{e.push(r)}),e}}class qn{constructor(e,t,r,i,s,o,a,u,c){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(e,t,r,i,s){const o=[];return t.forEach(a=>{o.push({type:0,doc:a})}),new qn(e,t,Bn.emptySet(t),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Pr(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==r[i].type||!t[i].doc.isEqual(r[i].doc))return!1;return!0}}class b_{constructor(){this.q_=void 0,this.Q_=[]}K_(){return this.Q_.some(e=>e.U_())}}class N_{constructor(){this.queries=new rt(e=>th(e),Pr),this.onlineState="Unknown",this.W_=new Set}}function Oa(n,e){return La.apply(this,arguments)}function La(){return La=(0,p.Z)(function*(n,e){const t=v(n);let r=3;const i=e.query;let s=t.queries.get(i);s?!s.K_()&&e.U_()&&(r=2):(s=new b_,r=e.U_()?0:1);try{switch(r){case 0:s.q_=yield t.onListen(i,!0);break;case 1:s.q_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(o){const a=Ln(o,`Initialization of query '${En(e.query)}' failed`);return void e.onError(a)}t.queries.set(i,s),s.Q_.push(e),e.G_(t.onlineState),s.q_&&e.z_(s.q_)&&Ua(t)}),La.apply(this,arguments)}function Ba(n,e){return qa.apply(this,arguments)}function qa(){return qa=(0,p.Z)(function*(n,e){const t=v(n),r=e.query;let i=3;const s=t.queries.get(r);if(s){const o=s.Q_.indexOf(e);o>=0&&(s.Q_.splice(o,1),0===s.Q_.length?i=e.U_()?0:1:!s.K_()&&e.U_()&&(i=2))}switch(i){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}}),qa.apply(this,arguments)}function k_(n,e){const t=v(n);let r=!1;for(const i of e){const o=t.queries.get(i.query);if(o){for(const a of o.Q_)a.z_(i)&&(r=!0);o.q_=i}}r&&Ua(t)}function F_(n,e,t){const r=v(n),i=r.queries.get(e);if(i)for(const s of i.Q_)s.onError(t);r.queries.delete(e)}function Ua(n){n.W_.forEach(e=>{e.next()})}var Ga,Bd;(Bd=Ga||(Ga={})).j_="default",Bd.Cache="cache";class za{constructor(e,t,r){this.query=e,this.H_=t,this.J_=!1,this.Y_=null,this.onlineState="Unknown",this.options=r||{}}z_(e){if(!this.options.includeMetadataChanges){const r=[];for(const i of e.docChanges)3!==i.type&&r.push(i);e=new qn(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.J_?this.Z_(e)&&(this.H_.next(e),t=!0):this.X_(e,this.onlineState)&&(this.ea(e),t=!0),this.Y_=e,t}onError(e){this.H_.error(e)}G_(e){this.onlineState=e;let t=!1;return this.Y_&&!this.J_&&this.X_(this.Y_,e)&&(this.ea(this.Y_),t=!0),t}X_(e,t){return!e.fromCache||!this.U_()||(!this.options.ta||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Z_(e){return e.docChanges.length>0||!!(e.syncStateChanged||this.Y_&&this.Y_.hasPendingWrites!==e.hasPendingWrites)&&!0===this.options.includeMetadataChanges}ea(e){e=qn.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.J_=!0,this.H_.next(e)}U_(){return this.options.source!==Ga.Cache}}class M_{constructor(e,t){this.na=e,this.byteLength=t}ra(){return"metadata"in this.na}}class qd{constructor(e){this.serializer=e}Ps(e){return Ze(this.serializer,e)}Is(e){return e.metadata.exists?Mh(this.serializer,e.document,!1):Z.newNoDocument(this.Ps(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return se(e)}}class O_{constructor(e,t,r){this.ia=e,this.localStore=t,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ud(e)}sa(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.na.namedQuery)this.queries.push(e.na.namedQuery);else if(e.na.documentMetadata){this.documents.push({metadata:e.na.documentMetadata}),e.na.documentMetadata.exists||++t;const r=M.fromString(e.na.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e.na.document&&(this.documents[this.documents.length-1].document=e.na.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}oa(e){const t=new Map,r=new qd(this.serializer);for(const i of e)if(i.metadata.queries){const s=r.Ps(i.metadata.name);for(const o of i.metadata.queries){const a=(t.get(o)||k()).add(s);t.set(o,a)}}return t}complete(){var e=this;return(0,p.Z)(function*(){const t=yield function h_(n,e,t,r){return la.apply(this,arguments)}(e.localStore,new qd(e.serializer),e.documents,e.ia.id),r=e.oa(e.documents);for(const i of e.queries)yield d_(e.localStore,i,r.get(i.name));return e.progress.taskState="Success",{progress:e.progress,_a:e.collectionGroups,aa:t}})()}}function Ud(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}class Gd{constructor(e){this.key=e}}class zd{constructor(e){this.key=e}}class Kd{constructor(e,t){this.query=e,this.ua=t,this.ca=null,this.hasCachedResults=!1,this.current=!1,this.la=k(),this.mutatedKeys=k(),this.ha=rh(e),this.Pa=new Bn(this.ha)}get Ia(){return this.ua}Ta(e,t){const r=t?t.Ea:new Ld,i=t?t.Pa:this.Pa;let s=t?t.mutatedKeys:this.mutatedKeys,o=i,a=!1;const u="F"===this.query.limitType&&i.size===this.query.limit?i.last():null,c="L"===this.query.limitType&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((l,h)=>{const d=i.get(l),m=Sr(this.query,h)?h:null,I=!!d&&this.mutatedKeys.has(d.key),E=!!m&&(m.hasLocalMutations||this.mutatedKeys.has(m.key)&&m.hasCommittedMutations);let T=!1;d&&m?d.data.isEqual(m.data)?I!==E&&(r.track({type:3,doc:m}),T=!0):this.da(d,m)||(r.track({type:2,doc:m}),T=!0,(u&&this.ha(m,u)>0||c&&this.ha(m,c)<0)&&(a=!0)):!d&&m?(r.track({type:0,doc:m}),T=!0):d&&!m&&(r.track({type:1,doc:d}),T=!0,(u||c)&&(a=!0)),T&&(m?(o=o.add(m),s=E?s.add(l):s.delete(l)):(o=o.delete(l),s=s.delete(l)))}),null!==this.query.limit)for(;o.size>this.query.limit;){const l="F"===this.query.limitType?o.last():o.first();o=o.delete(l.key),s=s.delete(l.key),r.track({type:1,doc:l})}return{Pa:o,Ea:r,Xi:a,mutatedKeys:s}}da(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,i){const s=this.Pa;this.Pa=e.Pa,this.mutatedKeys=e.mutatedKeys;const o=e.Ea.k_();o.sort((l,h)=>function(m,I){const E=T=>{switch(T){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return R()}};return E(m)-E(I)}(l.type,h.type)||this.ha(l.doc,h.doc)),this.Aa(r),i=null!=i&&i;const a=t&&!i?this.Ra():[],u=0===this.la.size&&this.current&&!i?1:0,c=u!==this.ca;return this.ca=u,0!==o.length||c?{snapshot:new qn(this.query,e.Pa,s,o,e.mutatedKeys,0===u,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),Va:a}:{Va:a}}G_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Pa:this.Pa,Ea:new Ld,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{Va:[]}}ma(e){return!this.ua.has(e)&&!!this.Pa.has(e)&&!this.Pa.get(e).hasLocalMutations}Aa(e){e&&(e.addedDocuments.forEach(t=>this.ua=this.ua.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.ua=this.ua.delete(t)),this.current=e.current)}Ra(){if(!this.current)return[];const e=this.la;this.la=k(),this.Pa.forEach(r=>{this.ma(r.key)&&(this.la=this.la.add(r.key))});const t=[];return e.forEach(r=>{this.la.has(r)||t.push(new zd(r))}),this.la.forEach(r=>{e.has(r)||t.push(new Gd(r))}),t}fa(e){this.ua=e.hs,this.la=k();const t=this.Ta(e.documents);return this.applyChanges(t,!0)}ga(){return qn.fromInitialDocuments(this.query,this.Pa,this.mutatedKeys,0===this.ca,this.hasCachedResults)}}class L_{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}}class B_{constructor(e){this.key=e,this.pa=!1}}class q_{constructor(e,t,r,i,s,o){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.ya={},this.wa=new rt(a=>th(a),Pr),this.Sa=new Map,this.ba=new Set,this.Da=new Q(w.comparator),this.Ca=new Map,this.va=new na,this.Fa={},this.Ma=new Map,this.xa=Wt.Ln(),this.onlineState="Unknown",this.Oa=void 0}get isPrimaryClient(){return!0===this.Oa}}function U_(n,e){return Ka.apply(this,arguments)}function Ka(){return Ka=(0,p.Z)(function*(n,e,t=!0){const r=ds(n);let i;const s=r.wa.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ga()):i=yield jd(r,e,t,!0),i}),Ka.apply(this,arguments)}function G_(n,e){return ja.apply(this,arguments)}function ja(){return ja=(0,p.Z)(function*(n,e){const t=ds(n);yield jd(t,e,!0,!1)}),ja.apply(this,arguments)}function jd(n,e,t,r){return Qa.apply(this,arguments)}function Qa(){return Qa=(0,p.Z)(function*(n,e,t,r){const i=yield bn(n.localStore,Pe(e)),s=i.targetId,o=t?n.sharedClientState.addLocalQueryTarget(s):"not-current";let a;return r&&(a=yield $a(n,e,s,"current"===o,i.resumeToken)),n.isPrimaryClient&&t&&ls(n.remoteStore,i),a}),Qa.apply(this,arguments)}function $a(n,e,t,r,i){return Wa.apply(this,arguments)}function Wa(){return Wa=(0,p.Z)(function*(n,e,t,r,i){n.Na=(h,d,m)=>{return(I=(0,p.Z)(function*(T,x,b,S){let N=x.view.Ta(b);N.Xi&&(N=yield ss(T.localStore,x.query,!1).then(({documents:Be})=>x.view.Ta(Be,N)));const B=S&&S.targetChanges.get(x.targetId),U=S&&null!=S.targetMismatches.get(x.targetId),oe=x.view.applyChanges(N,T.isPrimaryClient,B,U);return su(T,x.targetId,oe.Va),oe.snapshot}),function E(T,x,b,S){return I.apply(this,arguments)})(n,h,d,m);var I};const s=yield ss(n.localStore,e,!0),o=new Kd(e,s.hs),a=o.Ta(s.documents),u=kr.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,i),c=o.applyChanges(a,n.isPrimaryClient,u);su(n,t,c.Va);const l=new L_(e,t,o);return n.wa.set(e,l),n.Sa.has(t)?n.Sa.get(t).push(e):n.Sa.set(t,[e]),c.snapshot}),Wa.apply(this,arguments)}function z_(n,e,t){return Ha.apply(this,arguments)}function Ha(){return Ha=(0,p.Z)(function*(n,e,t){const r=v(n),i=r.wa.get(e),s=r.Sa.get(i.targetId);if(s.length>1)return r.Sa.set(i.targetId,s.filter(o=>!Pr(o,e))),void r.wa.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Nn(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),t&&Fn(r.remoteStore,i.targetId),Un(r,i.targetId)}).catch(ft))):(Un(r,i.targetId),yield Nn(r.localStore,i.targetId,!0))}),Ha.apply(this,arguments)}function K_(n,e){return Za.apply(this,arguments)}function Za(){return Za=(0,p.Z)(function*(n,e){const t=v(n),r=t.wa.get(e),i=t.Sa.get(r.targetId);t.isPrimaryClient&&1===i.length&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Fn(t.remoteStore,r.targetId))}),Za.apply(this,arguments)}function Ya(){return Ya=(0,p.Z)(function*(n,e,t){const r=pu(n);try{const i=yield function(o,a){const u=v(o),c=X.now(),l=a.reduce((m,I)=>m.add(I.key),k());let h,d;return u.persistence.runTransaction("Locally write mutations","readwrite",m=>{let I=be(),E=k();return u.os.getEntries(m,l).next(T=>{I=T,I.forEach((x,b)=>{b.isValidDocument()||(E=E.add(x))})}).next(()=>u.localDocuments.getOverlayedDocuments(m,I)).next(T=>{h=T;const x=[];for(const b of a){const S=yp(b,h.get(b.key).overlayedDocument);null!=S&&x.push(new it(b.key,S,ql(S.value.mapValue),ee.exists(!0)))}return u.mutationQueue.addMutationBatch(m,c,x,a)}).next(T=>{d=T;const x=T.applyToLocalDocumentSet(h,E);return u.documentOverlayCache.saveOverlays(m,T.batchId,x)})}).then(()=>({batchId:d.batchId,changes:sh(h)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(i.batchId),function(o,a,u){let c=o.Fa[o.currentUser.toKey()];c||(c=new Q(C)),c=c.insert(a,u),o.Fa[o.currentUser.toKey()]=c}(r,i.batchId,t),yield ot(r,i.changes),yield Mn(r.remoteStore)}catch(i){const s=Ln(i,"Failed to persist write");t.reject(s)}}),Ya.apply(this,arguments)}function Qd(n,e){return Ja.apply(this,arguments)}function Ja(){return Ja=(0,p.Z)(function*(n,e){const t=v(n);try{const r=yield function c_(n,e){const t=v(n),r=e.snapshotVersion;let i=t.ns;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{const o=t.os.newChangeBuffer({trackRemovals:!0});i=t.ns;const a=[];e.targetChanges.forEach((l,h)=>{const d=i.get(h);if(!d)return;a.push(t.Qr.removeMatchingKeys(s,l.removedDocuments,h).next(()=>t.Qr.addMatchingKeys(s,l.addedDocuments,h)));let m=d.withSequenceNumber(s.currentSequenceNumber);var E,T,x;null!==e.targetMismatches.get(h)?m=m.withResumeToken(ce.EMPTY_BYTE_STRING,V.min()).withLastLimboFreeSnapshotVersion(V.min()):l.resumeToken.approximateByteSize()>0&&(m=m.withResumeToken(l.resumeToken,r)),i=i.insert(h,m),T=m,x=l,(0===(E=d).resumeToken.approximateByteSize()||T.snapshotVersion.toMicroseconds()-E.snapshotVersion.toMicroseconds()>=3e8||x.addedDocuments.size+x.modifiedDocuments.size+x.removedDocuments.size>0)&&a.push(t.Qr.updateTargetData(s,m))});let u=be(),c=k();if(e.documentUpdates.forEach(l=>{e.resolvedLimboDocuments.has(l)&&a.push(t.persistence.referenceDelegate.updateLimboDocument(s,l))}),a.push(vd(s,o,e.documentUpdates).next(l=>{u=l.cs,c=l.ls})),!r.isEqual(V.min())){const l=t.Qr.getLastRemoteSnapshotVersion(s).next(h=>t.Qr.setTargetsMetadata(s,s.currentSequenceNumber,r));a.push(l)}return f.waitFor(a).next(()=>o.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(t.ns=i,s))}(t.localStore,e);e.targetChanges.forEach((i,s)=>{const o=t.Ca.get(s);o&&(P(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.pa=!0:i.modifiedDocuments.size>0?P(o.pa):i.removedDocuments.size>0&&(P(o.pa),o.pa=!1))}),yield ot(t,r,e)}catch(r){yield ft(r)}}),Ja.apply(this,arguments)}function $d(n,e,t){const r=v(n);if(r.isPrimaryClient&&0===t||!r.isPrimaryClient&&1===t){const i=[];r.wa.forEach((s,o)=>{const a=o.view.G_(e);a.snapshot&&i.push(a.snapshot)}),function(o,a){const u=v(o);u.onlineState=a;let c=!1;u.queries.forEach((l,h)=>{for(const d of h.Q_)d.G_(a)&&(c=!0)}),c&&Ua(u)}(r.eventManager,e),i.length&&r.ya.u_(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function Q_(n,e,t){return Xa.apply(this,arguments)}function Xa(){return Xa=(0,p.Z)(function*(n,e,t){const r=v(n);r.sharedClientState.updateQueryState(e,"rejected",t);const i=r.Ca.get(e),s=i&&i.key;if(s){let o=new Q(w.comparator);o=o.insert(s,Z.newNoDocument(s,V.min()));const a=k().add(s),u=new Nr(V.min(),new Map,new Q(C),o,a);yield Qd(r,u),r.Da=r.Da.remove(s),r.Ca.delete(e),ou(r)}else yield Nn(r.localStore,e,!1).then(()=>Un(r,e,t)).catch(ft)}),Xa.apply(this,arguments)}function $_(n,e){return eu.apply(this,arguments)}function eu(){return eu=(0,p.Z)(function*(n,e){const t=v(n),r=e.batch.batchId;try{const i=yield function u_(n,e){const t=v(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{const i=e.batch.keys(),s=t.os.newChangeBuffer({trackRemovals:!0});return function(a,u,c,l){const h=c.batch,d=h.keys();let m=f.resolve();return d.forEach(I=>{m=m.next(()=>l.getEntry(u,I)).next(E=>{const T=c.docVersions.get(I);P(null!==T),E.version.compareTo(T)<0&&(h.applyToRemoteDocument(E,c),E.isValidDocument()&&(E.setReadTime(c.commitVersion),l.addEntry(E)))})}),m.next(()=>a.mutationQueue.removeMutationBatch(u,h))}(t,r,e,s).next(()=>s.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(a){let u=k();for(let c=0;c<a.mutationResults.length;++c)a.mutationResults[c].transformResults.length>0&&(u=u.add(a.batch.mutations[c].key));return u}(e))).next(()=>t.localDocuments.getDocuments(r,i))})}(t.localStore,e);iu(t,r,null),ru(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),yield ot(t,i)}catch(i){yield ft(i)}}),eu.apply(this,arguments)}function W_(n,e,t){return tu.apply(this,arguments)}function tu(){return tu=(0,p.Z)(function*(n,e,t){const r=v(n);try{const i=yield function(o,a){const u=v(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let l;return u.mutationQueue.lookupMutationBatch(c,a).next(h=>(P(null!==h),l=h.keys(),u.mutationQueue.removeMutationBatch(c,h))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,l,a)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,l)).next(()=>u.localDocuments.getDocuments(c,l))})}(r.localStore,e);iu(r,e,t),ru(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),yield ot(r,i)}catch(i){yield ft(i)}}),tu.apply(this,arguments)}function nu(){return nu=(0,p.Z)(function*(n,e){const t=v(n);Pt(t.remoteStore)||y("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const r=yield function(o){const a=v(o);return a.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>a.mutationQueue.getHighestUnacknowledgedBatchId(u))}(t.localStore);if(-1===r)return void e.resolve();const i=t.Ma.get(r)||[];i.push(e),t.Ma.set(r,i)}catch(r){const i=Ln(r,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}}),nu.apply(this,arguments)}function ru(n,e){(n.Ma.get(e)||[]).forEach(t=>{t.resolve()}),n.Ma.delete(e)}function iu(n,e,t){const r=v(n);let i=r.Fa[r.currentUser.toKey()];if(i){const s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),r.Fa[r.currentUser.toKey()]=i}}function Un(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(const r of n.Sa.get(e))n.wa.delete(r),t&&n.ya.La(r,t);n.Sa.delete(e),n.isPrimaryClient&&n.va.Vr(e).forEach(r=>{n.va.containsKey(r)||Wd(n,r)})}function Wd(n,e){n.ba.delete(e.path.canonicalString());const t=n.Da.get(e);null!==t&&(Fn(n.remoteStore,t),n.Da=n.Da.remove(e),n.Ca.delete(t),ou(n))}function su(n,e,t){for(const r of t)r instanceof Gd?(n.va.addReference(r.key,e),Z_(n,r)):r instanceof zd?(y("SyncEngine","Document no longer in limbo: "+r.key),n.va.removeReference(r.key,e),n.va.containsKey(r.key)||Wd(n,r.key)):R()}function Z_(n,e){const t=e.key,r=t.path.canonicalString();n.Da.get(t)||n.ba.has(r)||(y("SyncEngine","New document in limbo: "+t),n.ba.add(r),ou(n))}function ou(n){for(;n.ba.size>0&&n.Da.size<n.maxConcurrentLimboResolutions;){const e=n.ba.values().next().value;n.ba.delete(e);const t=new w(M.fromString(e)),r=n.xa.next();n.Ca.set(r,new B_(t)),n.Da=n.Da.insert(t,r),ls(n.remoteStore,new st(Pe(In(t.path)),r,"TargetPurposeLimboResolution",Fe._e))}}function ot(n,e,t){return au.apply(this,arguments)}function au(){return au=(0,p.Z)(function*(n,e,t){const r=v(n),i=[],s=[],o=[];var a;r.wa.isEmpty()||(r.wa.forEach((a,u)=>{o.push(r.Na(u,e,t).then(c=>{if((c||t)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(u.targetId,c?.fromCache?"not-current":"current"),c){i.push(c);const l=aa.Ki(u.targetId,c);s.push(l)}}))}),yield Promise.all(o),r.ya.u_(i),yield(a=(0,p.Z)(function*(c,l){const h=v(c);try{yield h.persistence.runTransaction("notifyLocalViewChanges","readwrite",d=>f.forEach(l,m=>f.forEach(m.qi,I=>h.persistence.referenceDelegate.addReference(d,m.targetId,I)).next(()=>f.forEach(m.Qi,I=>h.persistence.referenceDelegate.removeReference(d,m.targetId,I)))))}catch(d){if(!mt(d))throw d;y("LocalStore","Failed to update sequence numbers: "+d)}for(const d of l){const m=d.targetId;if(!d.fromCache){const I=h.ns.get(m),T=I.withLastLimboFreeSnapshotVersion(I.snapshotVersion);h.ns=h.ns.insert(m,T)}}}),function u(c,l){return a.apply(this,arguments)})(r.localStore,s))}),au.apply(this,arguments)}function Y_(n,e){return uu.apply(this,arguments)}function uu(){return uu=(0,p.Z)(function*(n,e){const t=v(n);if(!t.currentUser.isEqual(e)){y("SyncEngine","User change. New user:",e.toKey());const r=yield Td(t.localStore,e);t.currentUser=e,(s=t).Ma.forEach(a=>{a.forEach(u=>{u.reject(new _(g.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),s.Ma.clear(),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),yield ot(t,r.us)}var s}),uu.apply(this,arguments)}function J_(n,e){const t=v(n),r=t.Ca.get(e);if(r&&r.pa)return k().add(r.key);{let i=k();const s=t.Sa.get(e);if(!s)return i;for(const o of s){const a=t.wa.get(o);i=i.unionWith(a.view.Ia)}return i}}function X_(n,e){return cu.apply(this,arguments)}function cu(){return cu=(0,p.Z)(function*(n,e){const t=v(n),r=yield ss(t.localStore,e.query,!0),i=e.view.fa(r);return t.isPrimaryClient&&su(t,e.targetId,i.Va),i}),cu.apply(this,arguments)}function ey(n,e){return lu.apply(this,arguments)}function lu(){return lu=(0,p.Z)(function*(n,e){const t=v(n);return Ad(t.localStore,e).then(r=>ot(t,r))}),lu.apply(this,arguments)}function ty(n,e,t,r){return hu.apply(this,arguments)}function hu(){return hu=(0,p.Z)(function*(n,e,t,r){const i=v(n),s=yield function(a,u){const c=v(a),l=v(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",h=>l.vn(h,u).next(d=>d?c.localDocuments.getDocuments(h,d):f.resolve(null)))}(i.localStore,e);var u;null!==s?("pending"===t?yield Mn(i.remoteStore):"acknowledged"===t||"rejected"===t?(iu(i,e,r||null),ru(i,e),u=e,v(v(i.localStore).mutationQueue).Mn(u)):R(),yield ot(i,s)):y("SyncEngine","Cannot apply mutation batch with id: "+e)}),hu.apply(this,arguments)}function du(){return du=(0,p.Z)(function*(n,e){const t=v(n);if(ds(t),pu(t),!0===e&&!0!==t.Oa){const r=t.sharedClientState.getAllActiveQueryTargets(),i=yield Hd(t,r.toArray());t.Oa=!0,yield ka(t.remoteStore,!0);for(const s of i)ls(t.remoteStore,s)}else if(!1===e&&!1!==t.Oa){const r=[];let i=Promise.resolve();t.Sa.forEach((s,o)=>{t.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(Un(t,o),Nn(t.localStore,o,!0))),Fn(t.remoteStore,o)}),yield i,yield Hd(t,r),function(o){const a=v(o);a.Ca.forEach((u,c)=>{Fn(a.remoteStore,c)}),a.va.mr(),a.Ca=new Map,a.Da=new Q(w.comparator)}(t),t.Oa=!1,yield ka(t.remoteStore,!1)}}),du.apply(this,arguments)}function Hd(n,e,t){return fu.apply(this,arguments)}function fu(){return fu=(0,p.Z)(function*(n,e,t){const r=v(n),i=[],s=[];for(const o of e){let a;const u=r.Sa.get(o);if(u&&0!==u.length){a=yield bn(r.localStore,Pe(u[0]));for(const c of u){const l=r.wa.get(c),h=yield X_(r,l);h.snapshot&&s.push(h.snapshot)}}else{const c=yield wd(r.localStore,o);a=yield bn(r.localStore,c),yield $a(r,Zd(c),o,!1,a.resumeToken)}i.push(a)}return r.ya.u_(s),i}),fu.apply(this,arguments)}function Zd(n){return Jl(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function ry(n){return t=v(n).localStore,v(v(t).persistence).Bi();var t}function iy(n,e,t,r){return mu.apply(this,arguments)}function mu(){return mu=(0,p.Z)(function*(n,e,t,r){const i=v(n);if(i.Oa)return void y("SyncEngine","Ignoring unexpected query state notification.");const s=i.Sa.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{const o=yield Ad(i.localStore,nh(s[0])),a=Nr.createSynthesizedRemoteEventForCurrentChange(e,"current"===t,ce.EMPTY_BYTE_STRING);yield ot(i,o,a);break}case"rejected":yield Nn(i.localStore,e,!0),Un(i,e,r);break;default:R()}}),mu.apply(this,arguments)}function sy(n,e,t){return gu.apply(this,arguments)}function gu(){return gu=(0,p.Z)(function*(n,e,t){const r=ds(n);if(r.Oa){for(const i of e){if(r.Sa.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){y("SyncEngine","Adding an already active target "+i);continue}const s=yield wd(r.localStore,i),o=yield bn(r.localStore,s);yield $a(r,Zd(s),o.targetId,!1,o.resumeToken),ls(r.remoteStore,o)}for(const i of t)r.Sa.has(i)&&(yield Nn(r.localStore,i,!1).then(()=>{Fn(r.remoteStore,i),Un(r,i)}).catch(ft))}}),gu.apply(this,arguments)}function ds(n){const e=v(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=Qd.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=J_.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Q_.bind(null,e),e.ya.u_=k_.bind(null,e.eventManager),e.ya.La=F_.bind(null,e.eventManager),e}function pu(n){const e=v(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=$_.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=W_.bind(null,e),e}class Qr{constructor(){this.synchronizeTabs=!1}initialize(e){var t=this;return(0,p.Z)(function*(){t.serializer=Kr(e.databaseInfo.databaseId),t.sharedClientState=t.createSharedClientState(e),t.persistence=t.createPersistence(e),yield t.persistence.start(),t.localStore=t.createLocalStore(e),t.gcScheduler=t.createGarbageCollectionScheduler(e,t.localStore),t.indexBackfillerScheduler=t.createIndexBackfillerScheduler(e,t.localStore)})()}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Id(this.persistence,new yd,e.initialUser,this.serializer)}createPersistence(e){return new ra(ns.Hr,this.serializer)}createSharedClientState(e){return new Vd}terminate(){var e=this;return(0,p.Z)(function*(){var t,r;null===(t=e.gcScheduler)||void 0===t||t.stop(),null===(r=e.indexBackfillerScheduler)||void 0===r||r.stop(),e.sharedClientState.shutdown(),yield e.persistence.shutdown()})()}}class _u extends Qr{constructor(e,t,r){super(),this.ka=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.synchronizeTabs=!1}initialize(e){var t=()=>super.initialize,r=this;return(0,p.Z)(function*(){yield t().call(r,e),yield r.ka.initialize(r,e),yield pu(r.ka.syncEngine),yield Mn(r.ka.remoteStore),yield r.persistence.fi(()=>(r.gcScheduler&&!r.gcScheduler.started&&r.gcScheduler.start(),r.indexBackfillerScheduler&&!r.indexBackfillerScheduler.started&&r.indexBackfillerScheduler.start(),Promise.resolve()))})()}createLocalStore(e){return Id(this.persistence,new yd,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){return new cd(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const r=new Cg(t,this.persistence);return new xg(e.asyncQueue,r)}createPersistence(e){const t=oa(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=void 0!==this.cacheSizeBytes?we.withCacheSize(this.cacheSizeBytes):we.DEFAULT;return new sa(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,Cd(),cs(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Vd}}class Yd extends _u{constructor(e,t){super(e,t,!1),this.ka=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){var t=()=>super.initialize,r=this;return(0,p.Z)(function*(){yield t().call(r,e);const i=r.ka.syncEngine;r.sharedClientState instanceof ga&&(r.sharedClientState.syncEngine={Zs:ty.bind(null,i),Xs:iy.bind(null,i),eo:sy.bind(null,i),Bi:ry.bind(null,i),Ys:ey.bind(null,i)},yield r.sharedClientState.start()),yield r.persistence.fi(function(){var s=(0,p.Z)(function*(o){yield function ny(n,e){return du.apply(this,arguments)}(r.ka.syncEngine,o),r.gcScheduler&&(o&&!r.gcScheduler.started?r.gcScheduler.start():o||r.gcScheduler.stop()),r.indexBackfillerScheduler&&(o&&!r.indexBackfillerScheduler.started?r.indexBackfillerScheduler.start():o||r.indexBackfillerScheduler.stop())});return function(o){return s.apply(this,arguments)}}())})()}createSharedClientState(e){const t=Cd();if(!ga.D(t))throw new _(g.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const r=oa(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ga(t,e.asyncQueue,r,e.clientId,e.initialUser)}}class Gn{initialize(e,t){var r=this;return(0,p.Z)(function*(){r.localStore||(r.localStore=e.localStore,r.sharedClientState=e.sharedClientState,r.datastore=r.createDatastore(t),r.remoteStore=r.createRemoteStore(t),r.eventManager=r.createEventManager(t),r.syncEngine=r.createSyncEngine(t,!e.synchronizeTabs),r.sharedClientState.onlineStateHandler=i=>$d(r.syncEngine,i,1),r.remoteStore.remoteSyncer.handleCredentialChange=Y_.bind(null,r.syncEngine),yield ka(r.remoteStore,r.syncEngine.isPrimaryClient))})()}createEventManager(e){return new N_}createDatastore(e){const t=Kr(e.databaseInfo.databaseId),r=new p_(e.databaseInfo);return new I_(e.authCredentials,e.appCheckCredentials,r,t)}createRemoteStore(e){return r=this.localStore,i=this.datastore,s=e.asyncQueue,o=t=>$d(this.syncEngine,t,0),a=xd.D()?new xd:new f_,new v_(r,i,s,o,a);var r,i,s,o,a}createSyncEngine(e,t){return function(i,s,o,a,u,c,l){const h=new q_(i,s,o,a,u,c);return l&&(h.Oa=!0),h}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){var e=this;return(0,p.Z)(function*(){var t,r;yield(r=(0,p.Z)(function*(s){const o=v(s);y("RemoteStore","RemoteStore shutting down."),o.v_.add(5),yield kn(o),o.M_.shutdown(),o.x_.set("Unknown")}),function i(s){return r.apply(this,arguments)})(e.remoteStore),null===(t=e.datastore)||void 0===t||t.terminate()})()}}function Jd(n,e=10240){let t=0;return{read:()=>(0,p.Z)(function*(){if(t<n.byteLength){const r={value:n.slice(t,t+e),done:!1};return t+=e,r}return{done:!0}})(),cancel:()=>(0,p.Z)(function*(){})(),releaseLock(){},closed:Promise.resolve()}}class fs{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.qa(this.observer.next,e)}error(e){this.observer.error?this.qa(this.observer.error,e):ie("Uncaught Error in snapshot listener:",e.toString())}Qa(){this.muted=!0}qa(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class uy{constructor(e,t){this.Ka=e,this.serializer=t,this.metadata=new ue,this.buffer=new Uint8Array,this.$a=new TextDecoder("utf-8"),this.Ua().then(r=>{r&&r.ra()?this.metadata.resolve(r.na.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(r?.na)}`))},r=>this.metadata.reject(r))}close(){return this.Ka.cancel()}getMetadata(){var e=this;return(0,p.Z)(function*(){return e.metadata.promise})()}Ba(){var e=this;return(0,p.Z)(function*(){return yield e.getMetadata(),e.Ua()})()}Ua(){var e=this;return(0,p.Z)(function*(){const t=yield e.Wa();if(null===t)return null;const r=e.$a.decode(t),i=Number(r);isNaN(i)&&e.Ga(`length string (${r}) is not valid number`);const s=yield e.za(i);return new M_(JSON.parse(s),t.length+i)})()}ja(){return this.buffer.findIndex(e=>123===e)}Wa(){var e=this;return(0,p.Z)(function*(){for(;e.ja()<0&&!(yield e.Ha()););if(0===e.buffer.length)return null;const t=e.ja();t<0&&e.Ga("Reached the end of bundle when a length string is expected.");const r=e.buffer.slice(0,t);return e.buffer=e.buffer.slice(t),r})()}za(e){var t=this;return(0,p.Z)(function*(){for(;t.buffer.length<e;)(yield t.Ha())&&t.Ga("Reached the end of bundle when more is expected.");const r=t.$a.decode(t.buffer.slice(0,e));return t.buffer=t.buffer.slice(e),r})()}Ga(e){throw this.Ka.cancel(),new Error(`Invalid bundle format: ${e}`)}Ha(){var e=this;return(0,p.Z)(function*(){const t=yield e.Ka.read();if(!t.done){const r=new Uint8Array(e.buffer.length+t.value.length);r.set(e.buffer),r.set(t.value,e.buffer.length),e.buffer=r}return t.done})()}}class cy{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){var t=this;return(0,p.Z)(function*(){if(t.ensureCommitNotCalled(),t.mutations.length>0)throw t.lastTransactionError=new _(g.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),t.lastTransactionError;const r=yield(i=(0,p.Z)(function*(o,a){const u=v(o),c={documents:a.map(m=>Fr(u.serializer,m))},l=yield u.vo("BatchGetDocuments",u.serializer.databaseId,M.emptyPath(),c,a.length),h=new Map;l.forEach(m=>{const I=function Vp(n,e){return"found"in e?function(r,i){P(!!i.found);const s=Ze(r,i.found.name),o=se(i.found.updateTime),a=i.found.createTime?se(i.found.createTime):V.min(),u=new ye({mapValue:{fields:i.found.fields}});return Z.newFoundDocument(s,o,a,u)}(n,e):"missing"in e?function(r,i){P(!!i.missing),P(!!i.readTime);const s=Ze(r,i.missing),o=se(i.readTime);return Z.newNoDocument(s,o)}(n,e):R()}(u.serializer,m);h.set(I.key.toString(),I)});const d=[];return a.forEach(m=>{const I=h.get(m.toString());P(!!I),d.push(I)}),d}),function s(o,a){return i.apply(this,arguments)})(t.datastore,e);var i;return r.forEach(i=>t.recordVersion(i)),r})()}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(e.toString())}delete(e){this.write(new Rn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){var e=this;return(0,p.Z)(function*(){if(e.ensureCommitNotCalled(),e.lastTransactionError)throw e.lastTransactionError;const t=e.readVersions;var r;e.mutations.forEach(r=>{t.delete(r.key.toString())}),t.forEach((r,i)=>{const s=w.fromPath(i);e.mutations.push(new Lo(s,e.precondition(s)))}),yield(r=(0,p.Z)(function*(s,o){const a=v(s),u={writes:o.map(c=>Mr(a.serializer,c))};yield a.So("Commit",a.serializer.databaseId,M.emptyPath(),u)}),function i(s,o){return r.apply(this,arguments)})(e.datastore,e.mutations),e.committed=!0})()}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw R();t=V.min()}const r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new _(g.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(V.min())?ee.exists(!1):ee.updateTime(t):ee.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(V.min()))throw new _(g.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return ee.updateTime(t)}return ee.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ly{constructor(e,t,r,i,s){this.asyncQueue=e,this.datastore=t,this.options=r,this.updateFunction=i,this.deferred=s,this.Ja=r.maxAttempts,this.jo=new _a(this.asyncQueue,"transaction_retry")}Ya(){this.Ja-=1,this.Za()}Za(){var e=this;this.jo.qo((0,p.Z)(function*(){const t=new cy(e.datastore),r=e.Xa(t);r&&r.then(i=>{e.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{e.deferred.resolve(i)}).catch(s=>{e.eu(s)}))}).catch(i=>{e.eu(i)})}))}Xa(e){try{const t=this.updateFunction(e);return!yr(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}eu(e){this.Ja>0&&this.tu(e)?(this.Ja-=1,this.asyncQueue.enqueueAndForget(()=>(this.Za(),Promise.resolve()))):this.deferred.reject(e)}tu(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Th(t)}return!1}}class hy{constructor(e,t,r,i){var s=this;this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=i,this.user=de.UNAUTHENTICATED,this.clientId=pl.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(r,function(){var o=(0,p.Z)(function*(a){y("FirestoreClient","Received user=",a.uid),yield s.authCredentialListener(a),s.user=a});return function(a){return o.apply(this,arguments)}}()),this.appCheckCredentials.start(r,o=>(y("FirestoreClient","Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(g.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){var e=this;this.asyncQueue.enterRestrictedMode();const t=new ue;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((0,p.Z)(function*(){try{e._onlineComponents&&(yield e._onlineComponents.terminate()),e._offlineComponents&&(yield e._offlineComponents.terminate()),e.authCredentials.shutdown(),e.appCheckCredentials.shutdown(),t.resolve()}catch(r){const i=Ln(r,"Failed to shutdown persistence");t.reject(i)}})),t.promise}}function ms(n,e){return yu.apply(this,arguments)}function yu(){return yu=(0,p.Z)(function*(n,e){n.asyncQueue.verifyOperationInProgress(),y("FirestoreClient","Initializing OfflineComponentProvider");const t=n.configuration;yield e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(function(){var i=(0,p.Z)(function*(s){r.isEqual(s)||(yield Td(e.localStore,s),r=s)});return function(s){return i.apply(this,arguments)}}()),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e}),yu.apply(this,arguments)}function Iu(n,e){return Tu.apply(this,arguments)}function Tu(){return Tu=(0,p.Z)(function*(n,e){n.asyncQueue.verifyOperationInProgress();const t=yield Eu(n);y("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>Od(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>Od(e.remoteStore,i)),n._onlineComponents=e}),Tu.apply(this,arguments)}function Xd(n){return"FirebaseError"===n.name?n.code===g.FAILED_PRECONDITION||n.code===g.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||22===n.code||20===n.code||11===n.code}function Eu(n){return vu.apply(this,arguments)}function vu(){return vu=(0,p.Z)(function*(n){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){y("FirestoreClient","Using user provided OfflineComponentProvider");try{yield ms(n,n._uninitializedComponentsProvider._offline)}catch(e){const t=e;if(!Xd(t))throw t;Ce("Error using user provided cache. Falling back to memory cache: "+t),yield ms(n,new Qr)}}else y("FirestoreClient","Using default OfflineComponentProvider"),yield ms(n,new Qr);return n._offlineComponents}),vu.apply(this,arguments)}function gs(n){return wu.apply(this,arguments)}function wu(){return wu=(0,p.Z)(function*(n){return n._onlineComponents||(n._uninitializedComponentsProvider?(y("FirestoreClient","Using user provided OnlineComponentProvider"),yield Iu(n,n._uninitializedComponentsProvider._online)):(y("FirestoreClient","Using default OnlineComponentProvider"),yield Iu(n,new Gn))),n._onlineComponents}),wu.apply(this,arguments)}function ef(n){return Eu(n).then(e=>e.persistence)}function zn(n){return Eu(n).then(e=>e.localStore)}function tf(n){return gs(n).then(e=>e.remoteStore)}function Au(n){return gs(n).then(e=>e.syncEngine)}function Kn(n){return Ru.apply(this,arguments)}function Ru(){return Ru=(0,p.Z)(function*(n){const e=yield gs(n),t=e.eventManager;return t.onListen=U_.bind(null,e.syncEngine),t.onUnlisten=z_.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=G_.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=K_.bind(null,e.syncEngine),t}),Ru.apply(this,arguments)}function rf(n,e,t={}){const r=new ue;return n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return function(s,o,a,u,c){const l=new fs({next:d=>{o.enqueueAndForget(()=>Ba(s,h));const m=d.docs.has(a);!m&&d.fromCache?c.reject(new _(g.UNAVAILABLE,"Failed to get document because the client is offline.")):m&&d.fromCache&&u&&"server"===u.source?c.reject(new _(g.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(d)},error:d=>c.reject(d)}),h=new za(In(a.path),l,{includeMetadataChanges:!0,ta:!0});return Oa(s,h)}(yield Kn(n),n.asyncQueue,e,t,r)})),r.promise}function sf(n,e,t={}){const r=new ue;return n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return function(s,o,a,u,c){const l=new fs({next:d=>{o.enqueueAndForget(()=>Ba(s,h)),d.fromCache&&"server"===u.source?c.reject(new _(g.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(d)},error:d=>c.reject(d)}),h=new za(a,l,{includeMetadataChanges:!0,ta:!0});return Oa(s,h)}(yield Kn(n),n.asyncQueue,e,t,r)})),r.promise}function of(n){const e={};return void 0!==n.timeoutSeconds&&(e.timeoutSeconds=n.timeoutSeconds),e}const af=new Map;function Pu(n,e,t){if(!t)throw new _(g.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function uf(n,e,t,r){if(!0===e&&!0===r)throw new _(g.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function cf(n){if(!w.isDocumentKey(n))throw new _(g.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function lf(n){if(w.isDocumentKey(n))throw new _(g.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function ps(n){if(void 0===n)return"undefined";if(null===n)return"null";if("string"==typeof n)return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if("number"==typeof n||"boolean"==typeof n)return""+n;if("object"==typeof n){if(n instanceof Array)return"an array";{const e=(r=n).constructor?r.constructor.name:null;return e?`a custom ${e} object`:"an object"}}var r;return"function"==typeof n?"a function":R()}function F(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new _(g.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const t=ps(n);throw new _(g.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function hf(n,e){if(e<=0)throw new _(g.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${e}.`)}class df{constructor(e){var t,r;if(void 0===e.host){if(void 0!==e.ssl)throw new _(g.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _(g.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}uf("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!(this.experimentalForceLongPolling||void 0!==e.experimentalAutoDetectLongPolling&&!e.experimentalAutoDetectLongPolling),this.experimentalLongPollingOptions=of(null!==(r=e.experimentalLongPollingOptions)&&void 0!==r?r:{}),function(s){if(void 0!==s.timeoutSeconds){if(isNaN(s.timeoutSeconds))throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.experimentalLongPollingOptions.timeoutSeconds===e.experimentalLongPollingOptions.timeoutSeconds&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class $r{constructor(e,t,r,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new df({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new _(g.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _(g.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new df(e),void 0!==e.credentials&&(this._authCredentials=function(r){if(!r)return new _g;switch(r.type){case"firstParty":return new Eg(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new _(g.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const r=af.get(t);r&&(y("ComponentProvider","Removing Datastore"),af.delete(t),r.terminate())}(this),Promise.resolve()}}class Ie{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new Ie(this.firestore,e,this._query)}}class Y{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Ye(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Y(this.firestore,e,this._key)}}class Ye extends Ie{constructor(e,t,r){super(e,t,In(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Y(this.firestore,null,new w(e))}withConverter(e){return new Ye(this.firestore,e,this._path)}}function mf(n,e,...t){if(n=(0,q.m9)(n),Pu("collection","path",e),n instanceof $r){const r=M.fromString(e,...t);return lf(r),new Ye(n,null,r)}{if(!(n instanceof Y||n instanceof Ye))throw new _(g.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=n._path.child(M.fromString(e,...t));return lf(r),new Ye(n.firestore,null,r)}}function _s(n,e,...t){if(n=(0,q.m9)(n),1===arguments.length&&(e=pl.newId()),Pu("doc","path",e),n instanceof $r){const r=M.fromString(e,...t);return cf(r),new Y(n,null,new w(r))}{if(!(n instanceof Y||n instanceof Ye))throw new _(g.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=n._path.child(M.fromString(e,...t));return cf(r),new Y(n.firestore,n instanceof Ye?n.converter:null,new w(r))}}function gf(n,e){return n=(0,q.m9)(n),e=(0,q.m9)(e),(n instanceof Y||n instanceof Ye)&&(e instanceof Y||e instanceof Ye)&&n.firestore===e.firestore&&n.path===e.path&&n.converter===e.converter}function Su(n,e){return n=(0,q.m9)(n),e=(0,q.m9)(e),n instanceof Ie&&e instanceof Ie&&n.firestore===e.firestore&&Pr(n._query,e._query)&&n.converter===e.converter}class wy{constructor(){this.nu=Promise.resolve(),this.ru=[],this.iu=!1,this.su=[],this.ou=null,this._u=!1,this.au=!1,this.uu=[],this.jo=new _a(this,"async_queue_retry"),this.cu=()=>{const t=cs();t&&y("AsyncQueue","Visibility state changed to "+t.visibilityState),this.jo.Ko()};const e=cs();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.cu)}get isShuttingDown(){return this.iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.lu(),this.hu(e)}enterRestrictedMode(e){if(!this.iu){this.iu=!0,this.au=e||!1;const t=cs();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.cu)}}enqueue(e){if(this.lu(),this.iu)return new Promise(()=>{});const t=new ue;return this.hu(()=>this.iu&&this.au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.ru.push(e),this.Pu()))}Pu(){var e=this;return(0,p.Z)(function*(){if(0!==e.ru.length){try{yield e.ru[0](),e.ru.shift(),e.jo.reset()}catch(t){if(!mt(t))throw t;y("AsyncQueue","Operation failed with retryable error: "+t)}e.ru.length>0&&e.jo.qo(()=>e.Pu())}})()}hu(e){const t=this.nu.then(()=>(this._u=!0,e().catch(r=>{throw this.ou=r,this._u=!1,ie("INTERNAL UNHANDLED ERROR: ",function(o){let a=o.message||"";return o.stack&&(a=o.stack.includes(o.message)?o.stack:o.message+"\n"+o.stack),a}(r)),r}).then(r=>(this._u=!1,r))));return this.nu=t,t}enqueueAfterDelay(e,t,r){this.lu(),this.uu.indexOf(e)>-1&&(t=0);const i=Ma.createAndSchedule(this,e,t,r,s=>this.Iu(s));return this.su.push(i),i}lu(){this.ou&&R()}verifyOperationInProgress(){}Tu(){var e=this;return(0,p.Z)(function*(){let t;do{t=e.nu,yield t}while(t!==e.nu)})()}Eu(e){for(const t of this.su)if(t.timerId===e)return!0;return!1}du(e){return this.Tu().then(()=>{this.su.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(const t of this.su)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tu()})}Au(e){this.uu.push(e)}Iu(e){const t=this.su.indexOf(e);this.su.splice(t,1)}}function Vu(n){return function(t,r){if("object"!=typeof t||null===t)return!1;const i=t;for(const s of["next","error","complete"])if(s in i&&"function"==typeof i[s])return!0;return!1}(n)}class Ay{constructor(){this._progressObserver={},this._taskCompletionResolver=new ue,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class $ extends $r{constructor(e,t,r,i){super(e,t,r,i),this.type="firestore",this._queue=new wy,this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||pf(this),this._firestoreClient.terminate()}}function re(n){return n._firestoreClient||pf(n),n._firestoreClient.verifyNotTerminated(),n._firestoreClient}function pf(n){var e,t,r;const i=n._freezeSettings(),s=(u=(null===(e=n._app)||void 0===e?void 0:e.options.appId)||"",new Yg(n._databaseId,u,n._persistenceKey,(l=i).host,l.ssl,l.experimentalForceLongPolling,l.experimentalAutoDetectLongPolling,of(l.experimentalLongPollingOptions),l.useFetchStreams));var u,l;n._firestoreClient=new hy(n._authCredentials,n._appCheckCredentials,n._queue,s),null!==(t=i.localCache)&&void 0!==t&&t._offlineComponentProvider&&null!==(r=i.localCache)&&void 0!==r&&r._onlineComponentProvider&&(n._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function _f(n,e,t){const r=new ue;return n.asyncQueue.enqueue((0,p.Z)(function*(){try{yield ms(n,t),yield Iu(n,e),r.resolve()}catch(i){const s=i;if(!Xd(s))throw s;Ce("Error enabling indexeddb cache. Falling back to memory cache: "+s),r.reject(s)}})).then(()=>r.promise)}function yf(n){if(n._initialized||n._terminated)throw new _(g.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Je{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Je(ce.fromBase64String(e))}catch(t){throw new _(g.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new Je(ce.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class at{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new _(g.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new H(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Zt{constructor(e){this._methodName=e}}class ys{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new _(g.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new _(g.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return C(this._lat,e._lat)||C(this._long,e._long)}}const Fy=/^__.*__$/;class My{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return null!==this.fieldMask?new it(e,this.data,this.fieldMask,t,this.fieldTransforms):new An(e,this.data,t,this.fieldTransforms)}}class If{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new it(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Tf(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw R()}}class Is{constructor(e,t,r,i,s,o){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=i,void 0===s&&this.Ru(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}mu(e){return new Is(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}fu(e){var t;const r=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.mu({path:r,gu:!1});return i.pu(e),i}yu(e){var t;const r=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.mu({path:r,gu:!1});return i.Ru(),i}wu(e){return this.mu({path:void 0,gu:!0})}Su(e){return vs(e,this.settings.methodName,this.settings.bu||!1,this.path,this.settings.Du)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Ru(){if(this.path)for(let e=0;e<this.path.length;e++)this.pu(this.path.get(e))}pu(e){if(0===e.length)throw this.Su("Document fields must not be empty");if(Tf(this.Vu)&&Fy.test(e))throw this.Su('Document fields cannot begin and end with "__"')}}class Oy{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||Kr(e)}Cu(e,t,r,i=!1){return new Is({Vu:e,methodName:t,Du:r,path:H.emptyPath(),gu:!1,bu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Yt(n){const e=n._freezeSettings(),t=Kr(n._databaseId);return new Oy(n._databaseId,!!e.ignoreUndefinedProperties,t)}function Ts(n,e,t,r,i,s={}){const o=n.Cu(s.merge||s.mergeFields?2:0,e,t,i);Fu("Data must be an object, but it was:",o,r);const a=wf(r,o);let u,c;if(s.merge)u=new De(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){const l=[];for(const h of s.mergeFields){const d=Zr(e,h,t);if(!o.contains(d))throw new _(g.INVALID_ARGUMENT,`Field '${d}' is specified in your field mask but missing from your input data.`);Rf(l,d)||l.push(d)}u=new De(l),c=o.fieldTransforms.filter(h=>u.covers(h.field))}else u=null,c=o.fieldTransforms;return new My(new ye(a),u,c)}class Hr extends Zt{_toFieldTransform(e){if(2!==e.Vu)throw e.Su(1===e.Vu?`${this._methodName}() can only appear at the top level of your update data`:`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Hr}}function Ef(n,e,t){return new Is({Vu:3,Du:e.settings.Du,methodName:n._methodName,gu:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class xu extends Zt{_toFieldTransform(e){return new Cr(e.path,new vn)}isEqual(e){return e instanceof xu}}class Cu extends Zt{constructor(e,t){super(e),this.vu=t}_toFieldTransform(e){const t=Ef(this,e,!0),r=this.vu.map(s=>Jt(s,t)),i=new Ut(r);return new Cr(e.path,i)}isEqual(e){return e instanceof Cu&&(0,q.vZ)(this.vu,e.vu)}}class Du extends Zt{constructor(e,t){super(e),this.vu=t}_toFieldTransform(e){const t=Ef(this,e,!0),r=this.vu.map(s=>Jt(s,t)),i=new Gt(r);return new Cr(e.path,i)}isEqual(e){return e instanceof Du&&(0,q.vZ)(this.vu,e.vu)}}class bu extends Zt{constructor(e,t){super(e),this.Fu=t}_toFieldTransform(e){const t=new wn(e.serializer,ch(e.serializer,this.Fu));return new Cr(e.path,t)}isEqual(e){return e instanceof bu&&this.Fu===e.Fu}}function Nu(n,e,t,r){const i=n.Cu(1,e,t);Fu("Data must be an object, but it was:",i,r);const s=[],o=ye.empty();gt(r,(u,c)=>{const l=Es(e,u,t);c=(0,q.m9)(c);const h=i.yu(l);if(c instanceof Hr)s.push(l);else{const d=Jt(c,h);null!=d&&(s.push(l),o.set(l,d))}});const a=new De(s);return new If(o,a,i.fieldTransforms)}function ku(n,e,t,r,i,s){const o=n.Cu(1,e,t),a=[Zr(e,r,t)],u=[i];if(s.length%2!=0)throw new _(g.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let d=0;d<s.length;d+=2)a.push(Zr(e,s[d])),u.push(s[d+1]);const c=[],l=ye.empty();for(let d=a.length-1;d>=0;--d)if(!Rf(c,a[d])){const m=a[d];let I=u[d];I=(0,q.m9)(I);const E=o.yu(m);if(I instanceof Hr)c.push(m);else{const T=Jt(I,E);null!=T&&(c.push(m),l.set(m,T))}}const h=new De(c);return new If(l,h,o.fieldTransforms)}function vf(n,e,t,r=!1){return Jt(t,n.Cu(r?4:3,e))}function Jt(n,e){if(Af(n=(0,q.m9)(n)))return Fu("Unsupported field value:",e,n),wf(n,e);if(n instanceof Zt)return function(r,i){if(!Tf(i.Vu))throw i.Su(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Su(`${r._methodName}() is not currently supported inside arrays`);const s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,e),null;if(void 0===n&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.gu&&4!==e.Vu)throw e.Su("Nested arrays are not supported");return function(r,i){const s=[];let o=0;for(const a of r){let u=Jt(a,i.wu(o));null==u&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,e)}return function(r,i){if(null===(r=(0,q.m9)(r)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return ch(i.serializer,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date){const s=X.fromDate(r);return{timestampValue:Pn(i.serializer,s)}}if(r instanceof X){const s=new X(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Pn(i.serializer,s)}}if(r instanceof ys)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Je)return{bytesValue:Ch(i.serializer,r._byteString)};if(r instanceof Y){const s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Su(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Ko(r.firestore._databaseId||i.databaseId,r._key.path)}}throw i.Su(`Unsupported field value: ${ps(r)}`)}(n,e)}function wf(n,e){const t={};return Dl(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):gt(n,(r,i)=>{const s=Jt(i,e.fu(r));null!=s&&(t[r]=s)}),{mapValue:{fields:t}}}function Af(n){return!("object"!=typeof n||null===n||n instanceof Array||n instanceof Date||n instanceof X||n instanceof ys||n instanceof Je||n instanceof Y||n instanceof Zt)}function Fu(n,e,t){if(!Af(t)||"object"!=typeof(i=t)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i)){const r=ps(t);throw e.Su("an object"===r?n+" a custom object":n+" "+r)}var i}function Zr(n,e,t){if((e=(0,q.m9)(e))instanceof at)return e._internalPath;if("string"==typeof e)return Es(n,e);throw vs("Field path arguments must be of type string or ",n,!1,void 0,t)}const Ly=new RegExp("[~\\*/\\[\\]]");function Es(n,e,t){if(e.search(Ly)>=0)throw vs(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new at(...e.split("."))._internalPath}catch{throw vs(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function vs(n,e,t,r,i){const s=r&&!r.isEmpty(),o=void 0!==i;let a=`Function ${e}() called with invalid data`;t&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new _(g.INVALID_ARGUMENT,a+n+u)}function Rf(n,e){return n.some(t=>t.isEqual(e))}class Yr{constructor(e,t,r,i,s){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Y(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new By(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(ws("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class By extends Yr{data(){return super.data()}}function ws(n,e){return"string"==typeof e?Es(n,e):e instanceof at?e._internalPath:e._delegate._internalPath}function Pf(n){if("L"===n.limitType&&0===n.explicitOrderBy.length)throw new _(g.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Mu{}class Jr extends Mu{}function Vt(n,e,...t){let r=[];e instanceof Mu&&r.push(e),r=r.concat(t),function(s){const o=s.filter(u=>u instanceof jn).length,a=s.filter(u=>u instanceof Xr).length;if(o>1||o>0&&a>0)throw new _(g.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const i of r)n=i._apply(n);return n}class Xr extends Jr{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new Xr(e,t,r)}_apply(e){const t=this._parse(e);return Cf(e._query,t),new Ie(e.firestore,e.converter,Mo(e._query,t))}_parse(e){const t=Yt(e.firestore);return function(s,o,a,u,c,l,h){let d;if(c.isKeyField()){if("array-contains"===l||"array-contains-any"===l)throw new _(g.INVALID_ARGUMENT,`Invalid Query. You can't perform '${l}' queries on documentId().`);if("in"===l||"not-in"===l){xf(h,l);const m=[];for(const I of h)m.push(Vf(u,s,I));d={arrayValue:{values:m}}}else d=Vf(u,s,h)}else"in"!==l&&"not-in"!==l&&"array-contains-any"!==l||xf(h,l),d=vf(a,"where",h,"in"===l||"not-in"===l);return O.create(c,l,d)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}class jn extends Mu{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new jn(e,t)}_parse(e){const t=this._queryConstraints.map(r=>r._parse(e)).filter(r=>r.getFilters().length>0);return 1===t.length?t[0]:z.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(i,s){let o=i;const a=s.getFlattenedFilters();for(const u of a)Cf(o,u),o=Mo(o,u)}(e._query,t),new Ie(e.firestore,e.converter,Mo(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Ou extends Jr{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Ou(e,t)}_apply(e){const t=function(i,s,o){if(null!==i.startAt)throw new _(g.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==i.endAt)throw new _(g.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Ar(s,o)}(e._query,this._field,this._direction);return new Ie(e.firestore,e.converter,function(i,s){const o=i.explicitOrderBy.concat([s]);return new nt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}}class As extends Jr{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new As(e,t,r)}_apply(e){return new Ie(e.firestore,e.converter,zi(e._query,this._limit,this._limitType))}}class Rs extends Jr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new Rs(e,t,r)}_apply(e){const t=Sf(e,this.type,this._docOrFields,this._inclusive);return new Ie(e.firestore,e.converter,(s=t,new nt((i=e._query).path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)));var i,s}}class Ps extends Jr{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new Ps(e,t,r)}_apply(e){const t=Sf(e,this.type,this._docOrFields,this._inclusive);return new Ie(e.firestore,e.converter,(s=t,new nt((i=e._query).path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)));var i,s}}function Sf(n,e,t,r){if(t[0]=(0,q.m9)(t[0]),t[0]instanceof Yr)return function(s,o,a,u,c){if(!u)throw new _(g.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);const l=[];for(const h of Tn(s))if(h.field.isKeyField())l.push(Bt(o,u.key));else{const d=u.data.field(h.field);if(Mi(d))throw new _(g.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+h.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===d){const m=h.field.canonicalString();throw new _(g.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${m}' (used as the orderBy) does not exist.`)}l.push(d)}return new Et(l,c)}(n._query,n.firestore._databaseId,e,t[0]._document,r);{const i=Yt(n.firestore);return function(o,a,u,c,l,h){const d=o.explicitOrderBy;if(l.length>d.length)throw new _(g.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const m=[];for(let I=0;I<l.length;I++){const E=l[I];if(d[I].field.isKeyField()){if("string"!=typeof E)throw new _(g.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof E}`);if(!Fo(o)&&-1!==E.indexOf("/"))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${E}' contains a slash.`);const T=o.path.child(M.fromString(E));if(!w.isDocumentKey(T))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${T}' is not because it contains an odd number of segments.`);const x=new w(T);m.push(Bt(a,x))}else{const T=vf(u,c,E);m.push(T)}}return new Et(m,h)}(n._query,n.firestore._databaseId,i,e,t,r)}}function Vf(n,e,t){if("string"==typeof(t=(0,q.m9)(t))){if(""===t)throw new _(g.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Fo(e)&&-1!==t.indexOf("/"))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);const r=e.path.child(M.fromString(t));if(!w.isDocumentKey(r))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Bt(n,new w(r))}if(t instanceof Y)return Bt(n,t._key);throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ps(t)}.`)}function xf(n,e){if(!Array.isArray(n)||0===n.length)throw new _(g.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function Cf(n,e){const t=function(i,s){for(const o of i)for(const a of o.getFlattenedFilters())if(s.indexOf(a.op)>=0)return a.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==t)throw new _(g.INVALID_ARGUMENT,t===e.op?`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`:`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}class Lu{convertValue(e,t="none"){switch(It(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ne(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw R()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const r={};return gt(e,(i,s)=>{r[i]=this.convertValue(s,t)}),r}convertGeoPoint(e){return new ys(ne(e.latitude),ne(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":const r=Oi(e);return null==r?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(Tr(e));default:return null}}convertTimestamp(e){const t=pt(e);return new X(t.seconds,t.nanos)}convertDocumentKey(e,t){const r=M.fromString(e);P(Uh(r));const i=new _t(r.get(1),r.get(3)),s=new w(r.popFirst(5));return i.isEqual(t)||ie(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Ss(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}class Wy extends Lu{constructor(e){super(),this.firestore=e}convertBytes(e){return new Je(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Y(this.firestore,null,t)}}class Xt{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ut extends Yr{constructor(e,t,r,i,s,o){super(e,t,r,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new ei(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const r=this._document.data.field(ws("DocumentSnapshot.get",e));if(null!==r)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}}class ei extends ut{data(e={}){return super.data(e)}}class xt{constructor(e,t,r,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new Xt(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new ei(this._firestore,this._userDataWriter,r.key,r,new Xt(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new _(g.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(a=>({type:"added",doc:new ei(i._firestore,i._userDataWriter,a.doc.key,a.doc,new Xt(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:o++}))}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(a=>s||3!==a.type).map(a=>{const u=new ei(i._firestore,i._userDataWriter,a.doc.key,a.doc,new Xt(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter);let c=-1,l=-1;return 0!==a.type&&(c=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),1!==a.type&&(o=o.add(a.doc),l=o.indexOf(a.doc.key)),{type:Zy(a.type),doc:u,oldIndex:c,newIndex:l}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Zy(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return R()}}function bf(n,e){return n instanceof ut&&e instanceof ut?n._firestore===e._firestore&&n._key.isEqual(e._key)&&(null===n._document?null===e._document:n._document.isEqual(e._document))&&n._converter===e._converter:n instanceof xt&&e instanceof xt&&n._firestore===e._firestore&&Su(n.query,e.query)&&n.metadata.isEqual(e.metadata)&&n._snapshot.isEqual(e._snapshot)}class Ct extends Lu{constructor(e){super(),this.firestore=e}convertBytes(e){return new Je(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Y(this.firestore,null,t)}}function Nf(n,e,t){n=F(n,Y);const r=F(n.firestore,$),i=Ss(n.converter,e,t);return Qn(r,[Ts(Yt(r),"setDoc",n._key,i,null!==n.converter,t).toMutation(n._key,ee.none())])}function kf(n,e,t,...r){n=F(n,Y);const i=F(n.firestore,$),s=Yt(i);let o;return o="string"==typeof(e=(0,q.m9)(e))||e instanceof at?ku(s,"updateDoc",n._key,e,t,r):Nu(s,"updateDoc",n._key,e),Qn(i,[o.toMutation(n._key,ee.exists(!0))])}function Ff(n,...e){var t,r,i;n=(0,q.m9)(n);let s={includeMetadataChanges:!1,source:"default"},o=0;"object"!=typeof e[o]||Vu(e[o])||(s=e[o],o++);const a={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Vu(e[o])){const h=e[o];e[o]=null===(t=h.next)||void 0===t?void 0:t.bind(h),e[o+1]=null===(r=h.error)||void 0===r?void 0:r.bind(h),e[o+2]=null===(i=h.complete)||void 0===i?void 0:i.bind(h)}let u,c,l;if(n instanceof Y)c=F(n.firestore,$),l=In(n._key.path),u={next:h=>{e[o]&&e[o](Bu(c,n,h))},error:e[o+1],complete:e[o+2]};else{const h=F(n,Ie);c=F(h.firestore,$),l=h._query;const d=new Ct(c);u={next:m=>{e[o]&&e[o](new xt(c,d,h,m))},error:e[o+1],complete:e[o+2]},Pf(n._query)}return function(d,m,I,E){const T=new fs(E),x=new za(m,T,I);return d.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return Oa(yield Kn(d),x)})),()=>{T.Qa(),d.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return Ba(yield Kn(d),x)}))}}(re(c),l,a,u)}function Qn(n,e){return function(r,i){const s=new ue;return r.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return function j_(n,e,t){return Ya.apply(this,arguments)}(yield Au(r),i,s)})),s.promise}(re(n),e)}function Bu(n,e,t){const r=t.docs.get(e._key),i=new Ct(n);return new ut(n,i,e._key,r,new Xt(t.hasPendingWrites,t.fromCache),e.converter)}const mI={maxAttempts:5};class Mf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Yt(e)}set(e,t,r){this._verifyNotCommitted();const i=Dt(e,this._firestore),s=Ss(i.converter,t,r),o=Ts(this._dataReader,"WriteBatch.set",i._key,s,null!==i.converter,r);return this._mutations.push(o.toMutation(i._key,ee.none())),this}update(e,t,r,...i){this._verifyNotCommitted();const s=Dt(e,this._firestore);let o;return o="string"==typeof(t=(0,q.m9)(t))||t instanceof at?ku(this._dataReader,"WriteBatch.update",s._key,t,r,i):Nu(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(o.toMutation(s._key,ee.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=Dt(e,this._firestore);return this._mutations=this._mutations.concat(new Rn(t._key,ee.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(g.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Dt(n,e){if((n=(0,q.m9)(n)).firestore!==e)throw new _(g.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}class gI extends class{constructor(t,r){this._firestore=t,this._transaction=r,this._dataReader=Yt(t)}get(t){const r=Dt(t,this._firestore),i=new Wy(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||1!==s.length)return R();const o=s[0];if(o.isFoundDocument())return new Yr(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new Yr(this._firestore,i,r._key,null,r.converter);throw R()})}set(t,r,i){const s=Dt(t,this._firestore),o=Ss(s.converter,r,i),a=Ts(this._dataReader,"Transaction.set",s._key,o,null!==s.converter,i);return this._transaction.set(s._key,a),this}update(t,r,i,...s){const o=Dt(t,this._firestore);let a;return a="string"==typeof(r=(0,q.m9)(r))||r instanceof at?ku(this._dataReader,"Transaction.update",o._key,r,i,s):Nu(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,a),this}delete(t){const r=Dt(t,this._firestore);return this._transaction.delete(r._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Dt(e,this._firestore),r=new Ct(this._firestore);return super.get(e).then(i=>new ut(this._firestore,r,t._key,i._document,new Xt(!1,!1),t.converter))}}function Uu(n,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new _("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return e}function qf(){if(typeof Uint8Array>"u")throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function Uf(){if(!function Hg(){return typeof atob<"u"}())throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}!function(e,t=!0){hn=oi.SDK_VERSION,(0,oi._registerComponent)(new Hu.wA("firestore",(r,{instanceIdentifier:i,options:s})=>{const o=r.getProvider("app").getImmediate(),a=new $(new Ig(r.getProvider("auth-internal")),new vg(r.getProvider("app-check-internal")),function(c,l){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new _(g.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new _t(c.options.projectId,l)}(o,i),o);return s=Object.assign({useFetchStreams:t},s),a._setSettings(s),a},"PUBLIC").setMultipleInstances(!0)),(0,oi.registerVersion)(fl,"4.5.0",e),(0,oi.registerVersion)(fl,"4.5.0","esm2017")}();class ti{constructor(e){this._delegate=e}static fromBase64String(e){return Uf(),new ti(Je.fromBase64String(e))}static fromUint8Array(e){return qf(),new ti(Je.fromUint8Array(e))}toBase64(){return Uf(),this._delegate.toBase64()}toUint8Array(){return qf(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Gu(n){return function RI(n,e){if("object"!=typeof n||null===n)return!1;const t=n;for(const r of e)if(r in t&&"function"==typeof t[r])return!0;return!1}(n,["next","error","complete"])}class PI{enableIndexedDbPersistence(e,t){return function Py(n,e){yf(n=F(n,$));const t=re(n);if(t._uninitializedComponentsProvider)throw new _(g.FAILED_PRECONDITION,"SDK cache is already specified.");Ce("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=n._freezeSettings(),i=new Gn;return _f(t,i,new _u(i,r.cacheSizeBytes,e?.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function Sy(n){yf(n=F(n,$));const e=re(n);if(e._uninitializedComponentsProvider)throw new _(g.FAILED_PRECONDITION,"SDK cache is already specified.");Ce("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=n._freezeSettings(),r=new Gn;return _f(e,r,new Yd(r,t.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function Vy(n){if(n._initialized&&!n._terminated)throw new _(g.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new ue;return n._queue.enqueueAndForgetEvenWhileRestricted((0,p.Z)(function*(){try{yield(t=(0,p.Z)(function*(i){if(!Oe.D())return Promise.resolve();const s=i+"main";yield Oe.delete(s)}),function r(i){return t.apply(this,arguments)})(oa(n._databaseId,n._persistenceKey)),e.resolve()}catch(t){e.reject(t)}var t})),e.promise}(e._delegate)}}class Gf{constructor(e,t,r){this._delegate=t,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},e instanceof _t||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){const t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&Ce("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,r={}){!function ff(n,e,t,r={}){var i;const s=(n=F(n,$r))._getSettings(),o=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==o&&Ce("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let a,u;if("string"==typeof r.mockUserToken)a=r.mockUserToken,u=de.MOCK_USER;else{a=(0,q.Sg)(r.mockUserToken,null===(i=n._app)||void 0===i?void 0:i.options.projectId);const c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new _(g.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new de(c)}n._authCredentials=new yg(new ml(a,u))}}(this._delegate,e,t,r)}enableNetwork(){return function Cy(n){return function dy(n){return n.asyncQueue.enqueue((0,p.Z)(function*(){const e=yield ef(n),t=yield tf(n);return e.setNetworkEnabled(!0),function(i){const s=v(i);return s.v_.delete(0),jr(s)}(t)}))}(re(n=F(n,$)))}(this._delegate)}disableNetwork(){return function Dy(n){return function fy(n){return n.asyncQueue.enqueue((0,p.Z)(function*(){const e=yield ef(n),t=yield tf(n);return e.setNetworkEnabled(!1),(r=(0,p.Z)(function*(s){const o=v(s);o.v_.add(0),yield kn(o),o.x_.set("Offline")}),function i(s){return r.apply(this,arguments)})(t);var r}))}(re(n=F(n,$)))}(this._delegate)}enablePersistence(e){let t=!1,r=!1;return e&&(t=!!e.synchronizeTabs,r=!!e.experimentalForceOwningTab,uf("synchronizeTabs",t,"experimentalForceOwningTab",r)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return function xy(n){return function(t){const r=new ue;return t.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return function H_(n,e){return nu.apply(this,arguments)}(yield Au(t),r)})),r.promise}(re(n=F(n,$)))}(this._delegate)}onSnapshotsInSync(e){return function sI(n,e){return function py(n,e){const t=new fs(e);return n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return i=yield Kn(n),s=t,v(i).W_.add(s),void s.next();var i,s})),()=>{t.Qa(),n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return i=yield Kn(n),s=t,void v(i).W_.delete(s);var i,s}))}}(re(n=F(n,$)),Vu(e)?e:{next:e})}(this._delegate,e)}get app(){if(!this._appCompat)throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new $n(this,mf(this._delegate,e))}catch(t){throw Se(t,"collection()","Firestore.collection()")}}doc(e){try{return new Le(this,_s(this._delegate,e))}catch(t){throw Se(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Ve(this,function vy(n,e){if(n=F(n,$r),Pu("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new _(g.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ie(n,null,(r=e,new nt(M.emptyPath(),r)));var r}(this._delegate,e))}catch(t){throw Se(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return function pI(n,e,t){n=F(n,$);const r=Object.assign(Object.assign({},mI),t);return function(s){if(s.maxAttempts<1)throw new _(g.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,a){const u=new ue;return s.asyncQueue.enqueueAndForget((0,p.Z)(function*(){const c=yield function nf(n){return gs(n).then(e=>e.datastore)}(s);new ly(s.asyncQueue,c,a,o,u).Ya()})),u.promise}(re(n),i=>e(new gI(n,i)),r)}(this._delegate,t=>e(new zf(this,t)))}batch(){return re(this._delegate),new Kf(new Mf(this._delegate,e=>Qn(this._delegate,e)))}loadBundle(e){return function by(n,e){const t=re(n=F(n,$)),r=new Ay;return function _y(n,e,t,r){const i=function(o,a){let u;return u="string"==typeof o?vh().encode(o):o,l=function(l,h){if(l instanceof Uint8Array)return Jd(l,h);if(l instanceof ArrayBuffer)return Jd(new Uint8Array(l),h);if(l instanceof ReadableStream)return l.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),new uy(l,a);var l}(t,Kr(e));n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){!function oy(n,e,t){const r=v(n);var i;(i=(0,p.Z)(function*(o,a,u){try{const c=yield a.getMetadata();if(yield function(I,E){const T=v(I),x=se(E.createTime);return T.persistence.runTransaction("hasNewerBundle","readonly",b=>T.$r.getBundleMetadata(b,E.id)).then(b=>!!b&&b.createTime.compareTo(x)>=0)}(o.localStore,c))return yield a.close(),u._completeWith({taskState:"Success",documentsLoaded:(I=c).totalDocuments,bytesLoaded:I.totalBytes,totalDocuments:I.totalDocuments,totalBytes:I.totalBytes}),Promise.resolve(new Set);u._updateProgress(Ud(c));const l=new O_(c,o.localStore,a.serializer);let h=yield a.Ba();for(;h;){const m=yield l.sa(h);m&&u._updateProgress(m),h=yield a.Ba()}const d=yield l.complete();return yield ot(o,d.aa,void 0),yield function(I,E){const T=v(I);return T.persistence.runTransaction("Save bundle","readwrite",x=>T.$r.saveBundleMetadata(x,E))}(o.localStore,c),u._completeWith(d.progress),Promise.resolve(d._a)}catch(c){return Ce("SyncEngine",`Loading bundle failed with ${c}`),u._failWith(c),Promise.resolve(new Set)}var I}),function s(o,a,u){return i.apply(this,arguments)})(r,e,t).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}(yield Au(n),i,r)}))}(t,n._databaseId,e,r),r}(this._delegate,e)}namedQuery(e){return function Ny(n,e){return function yy(n,e){return n.asyncQueue.enqueue((0,p.Z)(function*(){return function(r,i){const s=v(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.$r.getNamedQuery(o,i))}(yield zn(n),e)}))}(re(n=F(n,$)),e).then(t=>t?new Ie(n,null,t.query):null)}(this._delegate,e).then(t=>t?new Ve(this,t):null)}}class xs extends Lu{constructor(e){super(),this.firestore=e}convertBytes(e){return new ti(new Je(e))}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return Le.forKey(t,this.firestore,null)}}class zf{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new xs(e)}get(e){const t=tn(e);return this._delegate.get(t).then(r=>new ni(this._firestore,new ut(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,t.converter)))}set(e,t,r){const i=tn(e);return r?(Uu("Transaction.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){const s=tn(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){const t=tn(e);return this._delegate.delete(t),this}}class Kf{constructor(e){this._delegate=e}set(e,t,r){const i=tn(e);return r?(Uu("WriteBatch.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){const s=tn(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){const t=tn(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class en{constructor(e,t,r){this._firestore=e,this._userDataWriter=t,this._delegate=r}fromFirestore(e,t){const r=new ei(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new ri(this._firestore,r),t??{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const r=en.INSTANCES;let i=r.get(e);i||(i=new WeakMap,r.set(e,i));let s=i.get(t);return s||(s=new en(e,new xs(e),t),i.set(t,s)),s}}en.INSTANCES=new WeakMap;class Le{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new xs(e)}static forPath(e,t,r){if(e.length%2!=0)throw new _("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new Le(t,new Y(t._delegate,r,new w(e)))}static forKey(e,t,r){return new Le(t,new Y(t._delegate,r,e))}get id(){return this._delegate.id}get parent(){return new $n(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new $n(this.firestore,mf(this._delegate,e))}catch(t){throw Se(t,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=(0,q.m9)(e))instanceof Y&&gf(this._delegate,e)}set(e,t){t=Uu("DocumentReference.set",t);try{return t?Nf(this._delegate,e,t):Nf(this._delegate,e)}catch(r){throw Se(r,"setDoc()","DocumentReference.set()")}}update(e,t,...r){try{return 1===arguments.length?kf(this._delegate,e):kf(this._delegate,e,t,...r)}catch(i){throw Se(i,"updateDoc()","DocumentReference.update()")}}delete(){return function rI(n){return Qn(F(n.firestore,$),[new Rn(n._key,ee.none())])}(this._delegate)}onSnapshot(...e){const t=jf(e),r=Qf(e,i=>new ni(this.firestore,new ut(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return Ff(this._delegate,t,r)}get(e){let t;return t="cache"===e?.source?function Jy(n){n=F(n,Y);const e=F(n.firestore,$),t=re(e),r=new Ct(e);return function my(n,e){const t=new ue;return n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return(r=(0,p.Z)(function*(s,o,a){try{const u=yield function(l,h){const d=v(l);return d.persistence.runTransaction("read document","readonly",m=>d.localDocuments.getDocument(m,h))}(s,o);u.isFoundDocument()?a.resolve(u):u.isNoDocument()?a.resolve(null):a.reject(new _(g.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(u){const c=Ln(u,`Failed to get document '${o} from cache`);a.reject(c)}}),function i(s,o,a){return r.apply(this,arguments)})(yield zn(n),e,t);var r})),t.promise}(t,n._key).then(i=>new ut(e,r,n._key,i,new Xt(null!==i&&i.hasLocalMutations,!0),n.converter))}(this._delegate):"server"===e?.source?function Xy(n){n=F(n,Y);const e=F(n.firestore,$);return rf(re(e),n._key,{source:"server"}).then(t=>Bu(e,n,t))}(this._delegate):function Yy(n){n=F(n,Y);const e=F(n.firestore,$);return rf(re(e),n._key).then(t=>Bu(e,n,t))}(this._delegate),t.then(r=>new ni(this.firestore,new ut(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(e){return new Le(this.firestore,this._delegate.withConverter(e?en.getInstance(this.firestore,e):null))}}function Se(n,e,t){return n.message=n.message.replace(e,t),n}function jf(n){for(const e of n)if("object"==typeof e&&!Gu(e))return e;return{}}function Qf(n,e){var t,r;let i;return i=Gu(n[0])?n[0]:Gu(n[1])?n[1]:"function"==typeof n[0]?{next:n[0],error:n[1],complete:n[2]}:{next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(e(s))},error:null===(t=i.error)||void 0===t?void 0:t.bind(i),complete:null===(r=i.complete)||void 0===r?void 0:r.bind(i)}}class ni{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Le(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return bf(this._delegate,e._delegate)}}class ri extends ni{data(e){const t=this._delegate.data(e);return this._delegate._converter||function pg(n,e){n||R()}(void 0!==t),t}}class Ve{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new xs(e)}where(e,t,r){try{return new Ve(this.firestore,Vt(this._delegate,function qy(n,e,t){const r=e,i=ws("where",n);return Xr._create(i,r,t)}(e,t,r)))}catch(i){throw Se(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new Ve(this.firestore,Vt(this._delegate,function Uy(n,e="asc"){const t=e,r=ws("orderBy",n);return Ou._create(r,t)}(e,t)))}catch(r){throw Se(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new Ve(this.firestore,Vt(this._delegate,function Gy(n){return hf("limit",n),As._create("limit",n,"F")}(e)))}catch(t){throw Se(t,"limit()","Query.limit()")}}limitToLast(e){try{return new Ve(this.firestore,Vt(this._delegate,function zy(n){return hf("limitToLast",n),As._create("limitToLast",n,"L")}(e)))}catch(t){throw Se(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new Ve(this.firestore,Vt(this._delegate,function Ky(...n){return Rs._create("startAt",n,!0)}(...e)))}catch(t){throw Se(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Ve(this.firestore,Vt(this._delegate,function jy(...n){return Rs._create("startAfter",n,!1)}(...e)))}catch(t){throw Se(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Ve(this.firestore,Vt(this._delegate,function Qy(...n){return Ps._create("endBefore",n,!1)}(...e)))}catch(t){throw Se(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Ve(this.firestore,Vt(this._delegate,function $y(...n){return Ps._create("endAt",n,!0)}(...e)))}catch(t){throw Se(t,"endAt()","Query.endAt()")}}isEqual(e){return Su(this._delegate,e._delegate)}get(e){let t;return t="cache"===e?.source?function tI(n){n=F(n,Ie);const e=F(n.firestore,$),t=re(e),r=new Ct(e);return function gy(n,e){const t=new ue;return n.asyncQueue.enqueueAndForget((0,p.Z)(function*(){return(r=(0,p.Z)(function*(s,o,a){try{const u=yield ss(s,o,!0),c=new Kd(o,u.hs),l=c.Ta(u.documents),h=c.applyChanges(l,!1);a.resolve(h.snapshot)}catch(u){const c=Ln(u,`Failed to execute query '${o} against cache`);a.reject(c)}}),function i(s,o,a){return r.apply(this,arguments)})(yield zn(n),e,t);var r})),t.promise}(t,n._query).then(i=>new xt(e,r,n,i))}(this._delegate):"server"===e?.source?function nI(n){n=F(n,Ie);const e=F(n.firestore,$),t=re(e),r=new Ct(e);return sf(t,n._query,{source:"server"}).then(i=>new xt(e,r,n,i))}(this._delegate):function eI(n){n=F(n,Ie);const e=F(n.firestore,$),t=re(e),r=new Ct(e);return Pf(n._query),sf(t,n._query).then(i=>new xt(e,r,n,i))}(this._delegate),t.then(r=>new zu(this.firestore,new xt(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...e){const t=jf(e),r=Qf(e,i=>new zu(this.firestore,new xt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return Ff(this._delegate,t,r)}withConverter(e){return new Ve(this.firestore,this._delegate.withConverter(e?en.getInstance(this.firestore,e):null))}}class VI{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new ri(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class zu{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Ve(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new ri(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new VI(this._firestore,t))}forEach(e,t){this._delegate.forEach(r=>{e.call(t,new ri(this._firestore,r))})}isEqual(e){return bf(this._delegate,e._delegate)}}class $n extends Ve{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){const e=this._delegate.parent;return e?new Le(this.firestore,e):null}doc(e){try{return new Le(this.firestore,void 0===e?_s(this._delegate):_s(this._delegate,e))}catch(t){throw Se(t,"doc()","CollectionReference.doc()")}}add(e){return function iI(n,e){const t=F(n.firestore,$),r=_s(n),i=Ss(n.converter,e);return Qn(t,[Ts(Yt(n.firestore),"addDoc",r._key,i,null!==n.converter,{}).toMutation(r._key,ee.exists(!1))]).then(()=>r)}(this._delegate,e).then(t=>new Le(this.firestore,t))}isEqual(e){return gf(this._delegate,e._delegate)}withConverter(e){return new $n(this.firestore,this._delegate.withConverter(e?en.getInstance(this.firestore,e):null))}}function tn(n){return F(n,Y)}class Ku{constructor(...e){this._delegate=new at(...e)}static documentId(){return new Ku(H.keyField().canonicalString())}isEqual(e){return(e=(0,q.m9)(e))instanceof at&&this._delegate._internalPath.isEqual(e._internalPath)}}class nn{constructor(e){this._delegate=e}static serverTimestamp(){const e=function yI(){return new xu("serverTimestamp")}();return e._methodName="FieldValue.serverTimestamp",new nn(e)}static delete(){const e=function _I(){return new Hr("deleteField")}();return e._methodName="FieldValue.delete",new nn(e)}static arrayUnion(...e){const t=function II(...n){return new Cu("arrayUnion",n)}(...e);return t._methodName="FieldValue.arrayUnion",new nn(t)}static arrayRemove(...e){const t=function TI(...n){return new Du("arrayRemove",n)}(...e);return t._methodName="FieldValue.arrayRemove",new nn(t)}static increment(e){const t=function EI(n){return new bu("increment",n)}(e);return t._methodName="FieldValue.increment",new nn(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}}const xI={Firestore:Gf,GeoPoint:ys,Timestamp:X,Blob:ti,Transaction:zf,WriteBatch:Kf,DocumentReference:Le,DocumentSnapshot:ni,Query:Ve,QueryDocumentSnapshot:ri,QuerySnapshot:zu,CollectionReference:$n,FieldPath:Ku,FieldValue:nn,setLogLevel:function SI(n){!function gg(n){dt.setLogLevel(n)}(n)},CACHE_SIZE_UNLIMITED:-1};!function DI(n){(function CI(n,e){n.INTERNAL.registerComponent(new Hu.wA("firestore-compat",t=>{const r=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(r,i)},"PUBLIC").setServiceProps(Object.assign({},xI)))})(n,(e,t)=>new Gf(e,t,new PI)),n.registerVersion("@firebase/firestore-compat","0.3.27")}(um.Z);var bI=J(7142);function $f(n,e){return function NI(n,e=sm.z){return new om.y(t=>{let r;return null!=e?e.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},t)}):r=n.onSnapshot({includeMetadataChanges:!0},t),()=>{r?.()}})}(n,e)}function ju(n,e){return $f(n,e).pipe((0,Ge.U)(t=>({payload:t,type:"query"})))}class Wf{ref;afs;constructor(e,t){this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){const r=this.ref.collection(e),{ref:i,query:s}=em(r,t);return new Yf(i,s,this.afs)}snapshotChanges(){return function kI(n,e){return $f(n,e).pipe((0,Ds.O)(void 0),(0,bs.G)(),(0,Ge.U)(t=>{const[r,i]=t;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}(this.ref,this.afs.schedulers.outsideAngular).pipe(xe.iC)}valueChanges(e={}){return this.snapshotChanges().pipe((0,Ge.U)(({payload:t})=>e.idField?{...t.data(),[e.idField]:t.id}:t.data()))}get(e){return(0,si.D)(this.ref.get(e)).pipe(xe.iC)}}function Cs(n,e){return ju(n,e).pipe((0,Ds.O)(void 0),(0,bs.G)(),(0,Ge.U)(t=>{const[r,i]=t,s=i.payload.docChanges(),o=s.map(a=>({type:a.type,payload:a}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((a,u)=>{const c=s.find(h=>h.doc.ref.isEqual(a.ref)),l=r?.payload.docs.find(h=>h.ref.isEqual(a.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(a.metadata)||!c&&l&&JSON.stringify(l.metadata)===JSON.stringify(a.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:a}})}),o}))}function Hf(n,e,t){return Cs(n,t).pipe((0,Ns.R)((r,i)=>function FI(n,e,t){return e.forEach(r=>{t.indexOf(r.type)>-1&&(n=function MI(n,e){switch(e.type){case"added":if(!n[e.newIndex]||!n[e.newIndex].doc.ref.isEqual(e.doc.ref))return Qu(n,e.newIndex,0,e);break;case"modified":if(null==n[e.oldIndex]||n[e.oldIndex].doc.ref.isEqual(e.doc.ref)){if(e.oldIndex!==e.newIndex){const t=n.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}return Qu(n,e.newIndex,1,e)}break;case"removed":if(n[e.oldIndex]&&n[e.oldIndex].doc.ref.isEqual(e.doc.ref))return Qu(n,e.oldIndex,1)}return n}(n,r))}),n}(r,i.map(s=>s.payload),e),[]),(0,am.x)(),(0,Ge.U)(r=>r.map(i=>({type:i.type,payload:i}))))}function Qu(n,e,t,...r){const i=n.slice();return i.splice(e,t,...r),i}function Zf(n){return(!n||0===n.length)&&(n=["added","removed","modified"]),n}class Yf{ref;query;afs;constructor(e,t,r){this.ref=e,this.query=t,this.afs=r}stateChanges(e){let t=Cs(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe((0,Ge.U)(r=>r.filter(i=>e.indexOf(i.type)>-1)))),t.pipe((0,Ds.O)(void 0),(0,bs.G)(),(0,Wu.h)(([r,i])=>i.length>0||!r),(0,Ge.U)(([,r])=>r),xe.iC)}auditTrail(e){return this.stateChanges(e).pipe((0,Ns.R)((t,r)=>[...t,...r],[]))}snapshotChanges(e){const t=Zf(e);return Hf(this.query,t,this.afs.schedulers.outsideAngular).pipe(xe.iC)}valueChanges(e={}){return ju(this.query,this.afs.schedulers.outsideAngular).pipe((0,Ge.U)(t=>t.payload.docs.map(r=>e.idField?{...r.data(),[e.idField]:r.id}:r.data())),xe.iC)}get(e){return(0,si.D)(this.query.get(e)).pipe(xe.iC)}add(e){return this.ref.add(e)}doc(e){return new Wf(this.ref.doc(e),this.afs)}}class OI{query;afs;constructor(e,t){this.query=e,this.afs=t}stateChanges(e){return e&&0!==e.length?Cs(this.query,this.afs.schedulers.outsideAngular).pipe((0,Ge.U)(t=>t.filter(r=>e.indexOf(r.type)>-1)),(0,Wu.h)(t=>t.length>0),xe.iC):Cs(this.query,this.afs.schedulers.outsideAngular).pipe(xe.iC)}auditTrail(e){return this.stateChanges(e).pipe((0,Ns.R)((t,r)=>[...t,...r],[]))}snapshotChanges(e){const t=Zf(e);return Hf(this.query,t,this.afs.schedulers.outsideAngular).pipe(xe.iC)}valueChanges(e={}){return ju(this.query,this.afs.schedulers.outsideAngular).pipe((0,Ge.U)(r=>r.payload.docs.map(i=>e.idField?{[e.idField]:i.id,...i.data()}:i.data())),xe.iC)}get(e){return(0,si.D)(this.query.get(e)).pipe(xe.iC)}}const Jf=new j.OlP("angularfire2.enableFirestorePersistence"),Xf=new j.OlP("angularfire2.firestore.persistenceSettings"),LI=new j.OlP("angularfire2.firestore.settings"),BI=new j.OlP("angularfire2.firestore.use-emulator");function em(n,e=(t=>t)){return{query:e(n),ref:n}}let tm=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(t,r,i,s,o,a,u,c,l,h,d,m,I,E,T,x,b){this.schedulers=u;const S=(0,ii.on)(t,a,r),N=l;h&&(0,ct.nw)(S,a,d,I,E,T,m,x),[this.firestore,this.persistenceEnabled$]=(0,ii.cc)(`${S.name}.firestore`,"AngularFirestore",S.name,()=>{const B=a.runOutsideAngular(()=>S.firestore());if(s&&B.settings(s),N&&B.useEmulator(...N),i&&!(0,im.PM)(o)){const U=()=>{try{return(0,si.D)(B.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(oe){return typeof console<"u"&&console.warn(oe),(0,$u.of)(!1)}};return[B,a.runOutsideAngular(U)]}return[B,(0,$u.of)(!1)]},[s,N,i])}collection(t,r){let i;i="string"==typeof t?this.firestore.collection(t):t;const{ref:s,query:o}=em(i,r),a=this.schedulers.ngZone.run(()=>s);return new Yf(a,o,this)}collectionGroup(t,r){const i=r||(o=>o),s=this.firestore.collectionGroup(t);return new OI(i(s),this)}doc(t){let r;r="string"==typeof t?this.firestore.doc(t):t;const i=this.schedulers.ngZone.run(()=>r);return new Wf(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(j.LFG(ii.Dh),j.LFG(ii.xv,8),j.LFG(Jf,8),j.LFG(LI,8),j.LFG(j.Lbi),j.LFG(j.R0b),j.LFG(xe.HU),j.LFG(Xf,8),j.LFG(BI,8),j.LFG(ct.zQ,8),j.LFG(ct.Qv,8),j.LFG(ct.L6,8),j.LFG(ct._Q,8),j.LFG(ct.rT,8),j.LFG(ct.lh,8),j.LFG(ct.f7,8),j.LFG(xe.Rf,8))};static \u0275prov=j.Yz7({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),qI=(()=>{class n{constructor(){bI.Z.registerVersion("angularfire",xe.q4.full,"fst-compat")}static enablePersistence(t){return{ngModule:n,providers:[{provide:Jf,useValue:!0},{provide:Xf,useValue:t}]}}static \u0275fac=function(r){return new(r||n)};static \u0275mod=j.oAB({type:n});static \u0275inj=j.cJS({providers:[tm]})}return n})()}}]);